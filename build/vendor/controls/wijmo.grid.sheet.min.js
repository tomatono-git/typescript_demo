/*
    *
    * Wijmo Library 5.20172.359
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */
var __extends,wijmo;(function(n){var t;(function(t){var i;(function(i){'use strict';var h=function(){function h(t){this._expressionCache={};this._idChars='$:!';this._functionTable={};this._cacheSize=0;this.unknownFunction=new n.Event;this._owner=t;this._buildSymbolTable();this._registerAggregateFunction();this._registerMathFunction();this._registerLogicalFunction();this._registerTextFunction();this._registerDateFunction();this._registLookUpReferenceFunction();this._registFinacialFunction()}return h.prototype.onUnknownFunction=function(n,t){var f,u,r;if(t&&t.length>0)for(f=[],r=0;r<t.length;r++)f[r]=t[r].evaluate();if(u=new i.UnknownFunctionEventArgs(n,f),this.unknownFunction.raise(this,u),u.value!=null)return new i._Expression(u.value);throw'The function "'+n+'" has not supported in FlexSheet yet.';},h.prototype.evaluate=function(t,r,u,f,e){var s,o;try{if(t&&t.length>1&&t[0]==='='){for(s=this._checkCache(t),o=s.evaluate(u,f,e);o instanceof i._Expression;)o=o.evaluate(u);return r&&n.isPrimitive(o)?n.Globalize.format(o,r):o}return t?t:''}catch(h){return"Error: "+h}},h.prototype.addCustomFunction=function(n,t,u,f){var e=this;n=n.toLowerCase();this._functionTable[n]=new r(function(n){var u,f=[],r;if(n.length>0)for(r=0;r<n.length;r++)u=n[r],f[r]=u instanceof i._CellRangeExpression?u.cells:u.evaluate();return t.apply(e,f)},f,u)},h.prototype.addFunction=function(n,t,u,f){var e=this;n=n.toLowerCase();this._functionTable[n]=new r(function(n){var u,f=[],r;if(n.length>0)for(r=0;r<n.length;r++)u=n[r],f[r]=u instanceof i._CellRangeExpression?u.getValuseWithTwoDimensions():[[u.evaluate()]];return t.apply(e,f)},f,u)},h.prototype._clearExpressionCache=function(){this._expressionCache=null;this._expressionCache={};this._cacheSize=0},h.prototype._parse=function(n){return this._expression=n,this._expressLength=n?n.length:0,this._pointer=0,this._expressLength>0&&this._expression[0]==='='&&this._pointer++,this._parseExpression()},h.prototype._buildSymbolTable=function(){this._tokenTable||(this._tokenTable={},this._addToken('+',u.ADD,f.ADDSUB),this._addToken('-',u.SUB,f.ADDSUB),this._addToken('(',u.OPEN,f.GROUP),this._addToken(')',u.CLOSE,f.GROUP),this._addToken('*',u.MUL,f.MULDIV),this._addToken(',',u.COMMA,f.GROUP),this._addToken('.',u.PERIOD,f.GROUP),this._addToken('/',u.DIV,f.MULDIV),this._addToken('\\',u.DIVINT,f.MULDIV),this._addToken('=',u.EQ,f.COMPARE),this._addToken('>',u.GT,f.COMPARE),this._addToken('<',u.LT,f.COMPARE),this._addToken('^',u.POWER,f.POWER),this._addToken("<>",u.NE,f.COMPARE),this._addToken(">=",u.GE,f.COMPARE),this._addToken("<=",u.LE,f.COMPARE),this._addToken('&',u.CONCAT,f.CONCAT))},h.prototype._registerAggregateFunction=function(){var t=this;t._functionTable.sum=new r(function(i,r){return t._getAggregateResult(n.Aggregate.Sum,i,r)});t._functionTable.average=new r(function(i,r){return t._getAggregateResult(n.Aggregate.Avg,i,r)});t._functionTable.max=new r(function(i,r){return t._getAggregateResult(n.Aggregate.Max,i,r)});t._functionTable.min=new r(function(i,r){return t._getAggregateResult(n.Aggregate.Min,i,r)});t._functionTable['var']=new r(function(i,r){return t._getAggregateResult(n.Aggregate.Var,i,r)});t._functionTable.varp=new r(function(i,r){return t._getAggregateResult(n.Aggregate.VarPop,i,r)});t._functionTable.stdev=new r(function(i,r){return t._getAggregateResult(n.Aggregate.Std,i,r)});t._functionTable.stdevp=new r(function(i,r){return t._getAggregateResult(n.Aggregate.StdPop,i,r)});t._functionTable.count=new r(function(n,i){return t._getFlexSheetAggregateResult(o.Count,n,i)});t._functionTable.counta=new r(function(n,i){return t._getFlexSheetAggregateResult(o.CountA,n,i)});t._functionTable.countblank=new r(function(n,i){return t._getFlexSheetAggregateResult(o.ConutBlank,n,i)});t._functionTable.countif=new r(function(n,i){return t._getFlexSheetAggregateResult(o.CountIf,n,i)},2,2);t._functionTable.countifs=new r(function(n,i){return t._getFlexSheetAggregateResult(o.CountIfs,n,i)},254,2);t._functionTable.sumif=new r(function(n,i){return t._getFlexSheetAggregateResult(o.SumIf,n,i)},3,2);t._functionTable.sumifs=new r(function(n,i){return t._getFlexSheetAggregateResult(o.SumIfs,n,i)},255,2);t._functionTable.rank=new r(function(n,i){return t._getFlexSheetAggregateResult(o.Rank,n,i)},3,2);t._functionTable.product=new r(function(n,i){return t._getFlexSheetAggregateResult(o.Product,n,i)},255,1);t._functionTable.subtotal=new r(function(n,i){return t._handleSubtotal(n,i)},255,2);t._functionTable.dcount=new r(function(n,i){return t._handleDCount(n,i)},3,3);t._functionTable.sumproduct=new r(function(n,i){return t._getSumProduct(n,i)},255,1)},h.prototype._registerMathFunction=function(){var t=this;t._functionTable.pi=new r(function(){return Math.PI},0,0);t._functionTable.rand=new r(function(){return Math.random()},0,0);t._functionTable.power=new r(function(n,t){return Math.pow(i._Expression.toNumber(n[0],t),i._Expression.toNumber(n[1],t))},2,2);t._functionTable.atan2=new r(function(n,t){var r=i._Expression.toNumber(n[0],t),u=i._Expression.toNumber(n[1],t);if(r===0&&u===0)throw'The x number and y number can\'t both be zero for the atan2 function';return Math.atan2(u,r)},2,2);t._functionTable.mod=new r(function(n,t){return i._Expression.toNumber(n[0],t)%i._Expression.toNumber(n[1],t)},2,2);t._functionTable.trunc=new r(function(n,t){var r=i._Expression.toNumber(n[0],t),f=n.length===2?i._Expression.toNumber(n[1],t):0,u;return f===0?r>=0?Math.floor(r):Math.ceil(r):(u=Math.pow(10,f),r>=0?Math.floor(r*u)/u:Math.ceil(r*u)/u)},2,1);['ceiling','floor'].forEach(function(n){t._functionTable[n]=new r(function(t,r){var f=i._Expression.toNumber(t[0],r),u=t.length===2?i._Expression.toNumber(t[1],r):1,e,o,s;if(isNaN(f))throw'Invalid Number!';if(isNaN(u))throw'Invalid Significance!';if(f>0&&u<0)throw'The significance has to be positive, if the number is positive.';if(f===0||u===0)return 0;if(e=u-Math.floor(u),o=1,e!==0)while(e<1)o*=10,e*=10;return s=n==='ceiling'?Math.ceil(f/u):Math.floor(f/u),u*o*s/o},2,1)});['round','rounddown','roundup'].forEach(function(u){t._functionTable[u]=new r(function(t,r){var f=i._Expression.toNumber(t[0],r),s=i._Expression.toNumber(t[1],r),o,h,e;if(s===0){switch(u){case'rounddown':o=f>=0?Math.floor(f):Math.ceil(f);break;case'roundup':o=f>=0?Math.ceil(f):Math.floor(f);break;case'round':o=Math.round(f);break;default:o=Math.floor(f)}h='n0'}else if(s>0&&n.isInt(s)){e=Math.pow(10,s);switch(u){case'rounddown':o=f>=0?Math.floor(f*e)/e:Math.ceil(f*e)/e;break;case'roundup':o=f>=0?Math.ceil(f*e)/e:Math.floor(f*e)/e;break;case'round':o=Math.round(f*e)/e}h='n'+s}if(o!=null)return{value:o,format:h};throw'Invalid precision!';},2,2)});['abs','acos','asin','atan','cos','exp','ln','sin','sqrt','tan'].forEach(function(n){t._functionTable[n]=new r(function(t,r){return n==='ln'?Math.log(i._Expression.toNumber(t[0],r)):Math[n](i._Expression.toNumber(t[0],r))},1,1)})},h.prototype._registerLogicalFunction=function(){this._functionTable.and=new r(function(n,t){for(var r=!0,u=0;u<n.length;u++)if(r=r&&i._Expression.toBoolean(n[u],t),!r)break;return r},Number.MAX_VALUE,1);this._functionTable.or=new r(function(n,t){for(var r=!1,u=0;u<n.length;u++)if(r=r||i._Expression.toBoolean(n[u],t),r)break;return r},Number.MAX_VALUE,1);this._functionTable.not=new r(function(n,t){return!i._Expression.toBoolean(n[0],t)},1,1);this._functionTable['if']=new r(function(n,t){return n.length===3?i._Expression.toBoolean(n[0],t)?n[1].evaluate(t):n[2].evaluate(t):i._Expression.toBoolean(n[0],t)?n[1].evaluate(t):!1},3,2);this._functionTable['true']=new r(function(){return!0},0,0);this._functionTable['false']=new r(function(){return!1},0,0)},h.prototype._registerTextFunction=function(){var t=this;this._functionTable.char=new r(function(n,t){for(var u='',r=0;r<n.length;r++)u+=String.fromCharCode(i._Expression.toNumber(n[r],t));return u},Number.MAX_VALUE,1);this._functionTable.code=new r(function(n,t){var r=i._Expression.toString(n[0],t);return r&&r.length>0?r.charCodeAt(0):-1},1,1);this._functionTable.concatenate=new r(function(n,t){for(var u='',r=0;r<n.length;r++)u=u.concat(i._Expression.toString(n[r],t));return u},Number.MAX_VALUE,1);this._functionTable.left=new r(function(n,t){var r=i._Expression.toString(n[0],t),u=Math.floor(i._Expression.toNumber(n[1],t));return r&&r.length>0?r.slice(0,u):undefined},2,2);this._functionTable.right=new r(function(n,t){var r=i._Expression.toString(n[0],t),u=Math.floor(i._Expression.toNumber(n[1],t));return r&&r.length>0?r.slice(-u):undefined},2,2);this._functionTable.find=new r(function(t,r){var e=i._Expression.toString(t[0],r),u=i._Expression.toString(t[1],r),f=t[2]!=null?n.asInt(i._Expression.toNumber(t[2])):0,o;return u!=null&&e!=null&&(o=!isNaN(f)&&f>0&&f<u.length?u.indexOf(e,f):u.indexOf(e),o>-1)?o+1:-1},3,2);this._functionTable.search=new r(function(t,r){var s=i._Expression.toString(t[0],r),u=i._Expression.toString(t[1],r),f=t[2]!=null?n.asInt(i._Expression.toNumber(t[2])):0,e,h,o;return u!=null&&s!=null&&(h=new RegExp(s,'i'),!isNaN(f)&&f>0&&f<u.length?(u=u.substring(f),e=f+1):e=1,o=u.search(h),o>-1)?o+e:-1},3,2);this._functionTable.len=new r(function(n,t){var r=i._Expression.toString(n[0],t);return r?r.length:-1},1,1);this._functionTable.mid=new r(function(n,t){var r=i._Expression.toString(n[0],t),u=Math.floor(i._Expression.toNumber(n[1],t)),f=Math.floor(i._Expression.toNumber(n[2],t));return r&&r.length>0&&u>0?r.substr(u-1,f):undefined},3,3);this._functionTable.lower=new r(function(n,t){var r=i._Expression.toString(n[0],t);return r&&r.length>0?r.toLowerCase():undefined},1,1);this._functionTable.upper=new r(function(n,t){var r=i._Expression.toString(n[0],t);return r&&r.length>0?r.toUpperCase():null},1,1);this._functionTable.proper=new r(function(n,t){var r=i._Expression.toString(n[0],t);return r&&r.length>0?r[0].toUpperCase()+r.substring(1).toLowerCase():null},1,1);this._functionTable.trim=new r(function(n,t){var r=i._Expression.toString(n[0],t);return r&&r.length>0?r.trim():null},1,1);this._functionTable.replace=new r(function(n,t){var r=i._Expression.toString(n[0],t),u=Math.floor(i._Expression.toNumber(n[1],t)),f=Math.floor(i._Expression.toNumber(n[2],t)),e=i._Expression.toString(n[3],t);return r&&r.length>0&&u>0?r.substring(0,u-1)+e+r.slice(u-1+f):null},4,4);this._functionTable.substitute=new r(function(n,t){var u=i._Expression.toString(n[0],t),f=i._Expression.toString(n[1],t),e=i._Expression.toString(n[2],t),r=n.length===4?i._Expression.toNumber(n[3],t):null,o=0,s;if(r!=null&&r<1||isNaN(r))throw'Invalid instance number.';return u&&u.length>0&&f&&f.length>0?(s=new RegExp(f,'g'),u.replace(s,function(n){return(o++,r!=null)?(r=Math.floor(r),o===r?e:n):e})):null},4,3);this._functionTable.rept=new r(function(n,t){var r=i._Expression.toString(n[0],t),e=Math.floor(i._Expression.toNumber(n[1],t)),u='',f;if(r&&r.length>0&&e>0)for(f=0;f<e;f++)u=u.concat(r);return u},2,2);this._functionTable.text=new r(function(r,u){var f=r[0].evaluate(),e=i._Expression.toString(r[1],u),o;if(!n.isPrimitive(f)&&f&&(f=f.value),n.isDate(f))e=e.replace(/\[\$\-.+\]/g,'').replace(/(\\)(.)/g,'$2').replace(/H+/g,function(n){return n.toLowerCase()}).replace(/m+/g,function(n){return n.toUpperCase()}).replace(/S+/g,function(n){return n.toLowerCase()}).replace(/AM\/PM/gi,'tt').replace(/A\/P/gi,'t').replace(/\.000/g,'.fff').replace(/\.00/g,'.ff').replace(/\.0/g,'.f').replace(/\\[\-\s,]/g,function(n){return n.substring(1)}).replace(/Y+/g,function(n){return n.toLowerCase()}).replace(/D+/g,function(n){return n.toLowerCase()}).replace(/M+:?|:?M+/gi,function(n){return n.indexOf(':')>-1?n.toLowerCase():n}).replace(/g+e/gi,function(n){return n.substring(0,n.length-1)+'yy'});else if(n.isNumber(f)){if(o=e.match(/^(\d+)(\.\d+)?\E\+(\d+)(\.\d+)?$/),o&&o.length===5)return t._parseToScientificValue(f,o[1],o[2],o[3],o[4]);/M{1,4}|d{1,4}|y{1,4}/.test(e)?f=new Date(1900,0,f-1):!!e&&e.indexOf('#')>-1&&(e=n.xlsx.Workbook.fromXlsxFormat(e)[0])}else return f;if(n.isDate(f))switch(e){case'd':return f.getDate();case'M':return f.getMonth()+1;case'y':e='yy';break;case'yyy':e='yyyy'}return n.Globalize.format(f,e)},2,2);this._functionTable.value=new r(function(t,r){var u=i._Expression.toString(t[0],r),f;if(u=u.replace(/(\,\d{3})/g,function(n){return n.substring(1)}),u.length>0){if(u[0]===n.culture.Globalize.numberFormat.currency.symbol)return u=u.substring(1),+u;if(u[u.length-1]==='%')return u=u.substring(0,u.length-1),+u/100}return f=+u,isNaN(f)?i._Expression.toNumber(t[0],r):f},1,1)},h.prototype._registerDateFunction=function(){this._functionTable.now=new r(function(){return{value:new Date,format:'M/d/yyyy h:mm'}},0,0);this._functionTable.today=new r(function(){var n=new Date;return{value:new Date(n.getFullYear(),n.getMonth(),n.getDate()),format:'d'}},0,0);this._functionTable.year=new r(function(t,r){var u=i._Expression.toDate(t[0],r);return!n.isPrimitive(u)&&u?u.value:n.isDate(u)?u.getFullYear():1900},1,1);this._functionTable.month=new r(function(t,r){var u=i._Expression.toDate(t[0],r);return!n.isPrimitive(u)&&u?u.value:n.isDate(u)?u.getMonth()+1:1},1,1);this._functionTable.day=new r(function(t,r){var u=i._Expression.toDate(t[0],r);return!n.isPrimitive(u)&&u?u.value:n.isDate(u)?u.getDate():0},1,1);this._functionTable.hour=new r(function(t,r){var u=t[0].evaluate(r);if(n.isNumber(u)&&!isNaN(u))return Math.floor(24*(u-Math.floor(u)));if(n.isDate(u)||(u=i._Expression.toDate(t[0],r),!n.isPrimitive(u)&&u&&(u=u.value),n.isDate(u)))return u.getHours();throw'Invalid parameter.';},1,1);this._functionTable.time=new r(function(t,i){var r=t[0].evaluate(i),u=t[1].evaluate(i),f=t[2].evaluate(i);if(n.isNumber(r)&&n.isNumber(u)&&n.isNumber(f))return r%=24,u%=60,f%=60,{value:new Date(0,0,0,r,u,f),format:'t'};throw'Invalid parameters.';},3,3);this._functionTable.date=new r(function(t,i){var r=t[0].evaluate(i),u=t[1].evaluate(i),f=t[2].evaluate(i);if(n.isNumber(r)&&n.isNumber(u)&&n.isNumber(f))return{value:new Date(r,u-1,f),format:'d'};throw'Invalid parameters.';},3,3);this._functionTable.datedif=new r(function(t,r){var f=i._Expression.toDate(t[0],r),u=i._Expression.toDate(t[1],r),l=t[2].evaluate(r),h,c,o,e,s;if(!n.isPrimitive(f)&&f&&(f=f.value),!n.isPrimitive(u)&&u&&(u=u.value),n.isDate(f)&&n.isDate(u)&&n.isString(l)){if(h=f.getTime(),c=u.getTime(),h>c)throw'Start date is later than end date.';o=u.getDate()-f.getDate();e=u.getMonth()-f.getMonth();s=u.getFullYear()-f.getFullYear();switch(l.toUpperCase()){case'Y':return e>0?s:e<0?s-1:o>=0?s:s-1;case'M':return o>=0?s*12+e:s*12+e-1;case'D':return(c-h)/864e5;case'YM':return e=o>=0?s*12+e:s*12+e-1,e%12;case'YD':return e>0?(new Date(f.getFullYear(),u.getMonth(),u.getDate()).getTime()-f.getTime())/864e5:e<0?(new Date(f.getFullYear()+1,u.getMonth(),u.getDate()).getTime()-f.getTime())/864e5:o>=0?o:(new Date(f.getFullYear()+1,u.getMonth(),u.getDate()).getTime()-f.getTime())/864e5;case'MD':return o>=0?o:new Date(u.getFullYear(),u.getMonth(),0).getDate()-new Date(u.getFullYear(),u.getMonth()-1,1).getDate()+1+o;default:throw'Invalid unit.';}}throw'Invalid parameters.';},3,3)},h.prototype._registLookUpReferenceFunction=function(){var n=this;n._functionTable.column=new r(function(t,r,u,f){var e;if(t==null)return f+1;if(e=t[0],e=n._ensureNonFunctionExpression(e),e instanceof i._CellRangeExpression)return e.cells.col+1;throw'Invalid Cell Reference.';},1,0);n._functionTable.columns=new r(function(t){var r=t[0];if(r=n._ensureNonFunctionExpression(r),r instanceof i._CellRangeExpression)return r.cells.columnSpan;throw'Invalid Cell Reference.';},1,1);n._functionTable.row=new r(function(t,r,u){var f;if(t==null)return u+1;if(f=t[0],f=n._ensureNonFunctionExpression(f),f instanceof i._CellRangeExpression)return f.cells.row+1;throw'Invalid Cell Reference.';},1,0);n._functionTable.rows=new r(function(t){var r=t[0];if(r=n._ensureNonFunctionExpression(r),r instanceof i._CellRangeExpression)return r.cells.rowSpan;throw'Invalid Cell Reference.';},1,1);n._functionTable.choose=new r(function(n,t){var r=i._Expression.toNumber(n[0],t);if(isNaN(r))throw'Invalid index number.';if(r<1||r>=n.length)throw'The index number is out of the list range.';return n[r].evaluate(t)},255,2);n._functionTable.index=new r(function(r,u){var s=r[0],f,e=i._Expression.toNumber(r[1],u),o=r[2]!=null?i._Expression.toNumber(r[2],u):0;if(isNaN(e)||e<0)throw'Invalid Row Number.';if(isNaN(o)||o<0)throw'Invalid Column Number.';if(s=n._ensureNonFunctionExpression(s),s instanceof i._CellRangeExpression){if(f=s.cells,e>f.rowSpan||o>f.columnSpan)throw'Index is out of the cell range.';if(e>0&&o>0)return n._owner.getCellValue(f.topRow+e-1,f.leftCol+o-1,!0,u);if(e===0&&o===0)return s;if(e===0)return new i._CellRangeExpression(new t.CellRange(f.topRow,f.leftCol+o-1,f.bottomRow,f.leftCol+o-1),s.sheetRef,n._owner);if(o===0)return new i._CellRangeExpression(new t.CellRange(f.topRow+e-1,f.leftCol,f.topRow+e-1,f.rightCol),s.sheetRef,n._owner)}throw'Invalid Cell Reference.';},4,2);n._functionTable.hlookup=new r(function(t,i){return n._handleHLookup(t,i)},4,3)},h.prototype._registFinacialFunction=function(){var n=this;n._functionTable.rate=new r(function(t,i){var r=n._calculateRate(t,i);return{value:r,format:'p2'}},6,3)},h.prototype._addToken=function(n,t,i){var r=new s(n,t,i);this._tokenTable[n]=r},h.prototype._parseExpression=function(){return this._getToken(),this._parseCompareOrConcat()},h.prototype._parseCompareOrConcat=function(){for(var n=this._parseAddSub(),t,r;this._token.tokenType===f.COMPARE||this._token.tokenType===f.CONCAT;)t=this._token,this._getToken(),r=this._parseAddSub(),n=new i._BinaryExpression(t,n,r);return n},h.prototype._parseAddSub=function(){for(var n=this._parseMulDiv(),t,r;this._token.tokenType===f.ADDSUB;)t=this._token,this._getToken(),r=this._parseMulDiv(),n=new i._BinaryExpression(t,n,r);return n},h.prototype._parseMulDiv=function(){for(var n=this._parsePower(),t,r;this._token.tokenType===f.MULDIV;)t=this._token,this._getToken(),r=this._parsePower(),n=new i._BinaryExpression(t,n,r);return n},h.prototype._parsePower=function(){for(var n=this._parseUnary(),t,r;this._token.tokenType===f.POWER;)t=this._token,this._getToken(),r=this._parseUnary(),n=new i._BinaryExpression(t,n,r);return n},h.prototype._parseUnary=function(){var n,t;return this._token.tokenID===u.ADD||this._token.tokenID===u.SUB?(n=this._token,this._getToken(),t=this._parseAtom(),new i._UnaryExpression(n,t)):this._parseAtom()},h.prototype._parseAtom=function(){var n=null,t,r,e,c,h,o,v,y,p,s,l,a;switch(this._token.tokenType){case f.LITERAL:n=new i._Expression(this._token);break;case f.IDENTIFIER:if(t=this._token.value.toString().toLowerCase(),r=this._functionTable[t],r)if(e=this._getParameters(),this._token.tokenID===u.CLOSE){if(c=e?e.length:0,r.paramMin!==-1&&c<r.paramMin)throw'Too few parameters.';if(r.paramMax!==-1&&c>r.paramMax)throw'Too many parameters.';n=new i._FunctionExpression(r,e,t!=='rand');break}else if(t==='true'||t==='false'){n=new i._FunctionExpression(r,e,!1);break}if(s=t.split('!'),s.length===2?(a=s[0],l=s[1]):l=s[0],o=this._getDefinedName(l,a||this._owner.selectedSheet.name.toLowerCase()),o)if(o.sheetName&&o.sheetName!==this._owner.selectedSheet.name&&o.sheetName.toLowerCase()!==a)throw'The defined name item works in '+o.sheetName+'.  It does not work in current sheet.';else{p=this._pointer;y=this._expressLength;v=this._expression;this._pointer=0;n=this._checkCache(o.value);this._pointer=p;this._expressLength=y;this._expression=v;break}if(h=this._getCellRange(t),h){n=new i._CellRangeExpression(h.cellRange,h.sheetRef,this._owner);break}e=this._getParameters();n=this.onUnknownFunction(t,e);break;case f.GROUP:if(this._token.tokenID!==u.OPEN)throw'Expression expected.';if(this._getToken(),n=this._parseCompareOrConcat(),this._token.tokenID!==u.CLOSE)throw'Unbalanced parenthesis.';}if(n===null)throw'';return this._getToken(),n},h.prototype._getToken=function(){for(var t,n,c,e,o,h='',i='',l=new RegExp('[\u3000-\u303f\u3040-\u309f\u30a0-\u30ff\uff00-\uff9f\u4e00-\u9faf\u3400-\u4dbf]'),r;this._pointer<this._expressLength&&this._expression[this._pointer]===' ';)this._pointer++;if(this._pointer>=this._expressLength){this._token=new s(null,u.END,f.GROUP);return}if(n=this._expression[this._pointer],e=n>='a'&&n<='z'||n>='A'&&n<='Z'||l.test(n),o=n>='0'&&n<='9'||n=='.',!e&&!o&&(r=this._tokenTable[n],r)){this._token=r;this._pointer++;this._pointer<this._expressLength&&(n==='>'||n==='<')&&(r=this._tokenTable[this._expression.substring(this._pointer-1,this._pointer+1)],r&&(this._token=r,this._pointer++));return}if(o){this._parseDigit();return}if(n==='\"'){this._parseString();return}if(n!=='\''||(i=this._parseSheetRef(),i)){if(n==='#'){this._parseDate();return}if(!e&&n!=='_'&&this._idChars.indexOf(n)<0&&!i)throw'Identifier expected.';for(t=1;t+this._pointer<this._expressLength;t++){if(n=this._expression[this._pointer+t],e=n>='a'&&n<='z'||n>='A'&&n<='Z'||l.test(n),o=n>='0'&&n<='9',n==='\''&&c===':'){h=i+this._expression.substring(this._pointer,this._pointer+t);this._pointer+=t;i=this._parseSheetRef();t=0;continue}if(c=n,!e&&!o&&n!=='_'&&this._idChars.indexOf(n)<0)break}h+=i+this._expression.substring(this._pointer,this._pointer+t);this._pointer+=t;this._token=new s(h,u.ATOM,f.IDENTIFIER)}},h.prototype._parseDigit=function(){for(var i=-1,e=!1,o=!1,r=0,n,h,t=0;t+this._pointer<this._expressLength;t++){if(n=this._expression[this._pointer+t],n>='0'&&n<='9'){r=r*10+(+n-0);i>-1&&(i*=10);continue}if(n==='.'&&i<0){i=1;continue}if((n==='E'||n==='e')&&!e){e=!0;n=this._expression[this._pointer+t+1];(n==='+'||n==='-')&&t++;continue}if(n==='%'){o=!0;t++;break}break}e?(h=this._expression.substring(this._pointer,this._pointer+t),r=+h):(i>1&&(r/=i),o&&(r/=100));this._token=new s(r,u.ATOM,f.LITERAL);this._pointer+=t},h.prototype._parseString=function(){for(var t,i,r,n=1;n+this._pointer<this._expressLength;n++)if(t=this._expression[this._pointer+n],t==='\"'){if(i=n+this._pointer<this._expressLength-1?this._expression[this._pointer+n+1]:' ',i!=='\"')break;n++}if(t!=='\"')throw'Can\'t find final quote.';if(r=this._expression.substring(this._pointer+1,this._pointer+n),this._pointer+=n+1,this._expression[this._pointer]==='!')throw'Illegal cross sheet reference.';this._token=new s(r.replace('\"\"','\"'),u.ATOM,f.LITERAL)},h.prototype._parseDate=function(){for(var t,i,n=1;n+this._pointer<this._expressLength;n++)if(t=this._expression[this._pointer+n],t==='#')break;if(t!=='#')throw'Can\'t find final date delimiter ("#").';i=this._expression.substring(this._pointer+1,this._pointer+n);this._pointer+=n+1;this._token=new s(Date.parse(i),u.ATOM,f.LITERAL)},h.prototype._parseSheetRef=function(){for(var t,i,r,n=1;n+this._pointer<this._expressLength;n++)if(t=this._expression[this._pointer+n],t==='\''){if(i=n+this._pointer<this._expressLength-1?this._expression[this._pointer+n+1]:' ',i!=='\'')break;n++}if(t!=='\'')throw'Can\'t find final quote.';return r=this._expression.substring(this._pointer+1,this._pointer+n),this._pointer+=n+1,this._expression[this._pointer]==='!'?r.replace(/\'\'/g,'\''):''},h.prototype._getCellRange=function(n){var i,r,u,t,f;if(n&&(i=n.split(':'),i.length>0&&i.length<3&&(r=this._parseCell(i[0]),t=r.cellRange,t&&i.length===2))){if(u=this._parseCell(i[1]),f=u.cellRange,r.sheetRef&&!u.sheetRef&&(u.sheetRef=r.sheetRef),r.sheetRef!==u.sheetRef)throw'The cell reference must be in the same sheet!';f?(t.col2=f.col,t.row2=f.row):t=null}return t==null?null:{cellRange:t,sheetRef:r.sheetRef}},h.prototype._parseCellRange=function(n){for(var u=-1,f=-1,e=!1,o=!1,i,r=0;r<n.length;r++){if(i=n[r],i==='$'&&!e){e=!0;continue}if(!(i>='a'&&i<='z')&&!(i>='A'&&i<='Z'))break;u<0&&(u=0);u=26*u+(i.toUpperCase().charCodeAt(0)-'A'.charCodeAt(0)+1)}for(;r<n.length;r++){if(i=n[r],i==='$'&&!o){o=!0;continue}if(!(i>='0'&&i<='9'))break;f<0&&(f=0);f=10*f+(+i-0)}return(r<n.length&&(f=u=-1),f===-1||u===-1)?null:new t.CellRange(f-1,u-1)},h.prototype._parseCell=function(n){var r,t,i,u;if(t=n.lastIndexOf('!'),t>0&&t<n.length-1)u=n.substring(0,t),i=n.substring(t+1);else if(t<=0)i=n;else return null;return r=this._parseCellRange(i),{cellRange:r,sheetRef:u}},h.prototype._getParameters=function(){var i=this._pointer,r=this._token,n,t;if(this._getToken(),this._token.tokenID!==u.OPEN)return this._pointer=i,this._token=r,null;if(i=this._pointer,this._getToken(),this._token.tokenID===u.CLOSE)return null;for(this._pointer=i,n=[],t=this._parseExpression(),n.push(t);this._token.tokenID===u.COMMA;)t=this._parseExpression(),n.push(t);if(this._token.tokenID!==u.CLOSE)throw'Syntax error.';return n},h.prototype._getAggregateResult=function(t,i,r){var f=this._getItemList(i,r),u;return u=n.getAggregate(t,f.items),f.isDate&&(u=new Date(u)),u},h.prototype._getFlexSheetAggregateResult=function(n,t,r){var u,f,e,s;switch(n){case o.Count:return u=this._getItemList(t,r,!0,!1),this._countNumberCells(u.items);case o.CountA:return u=this._getItemList(t,r,!1,!1),u.items.length;case o.ConutBlank:return u=this._getItemList(t,r,!1,!0),this._countBlankCells(u.items);case o.Rank:if(e=i._Expression.toNumber(t[0],r),s=t[2]?i._Expression.toNumber(t[2],r):0,isNaN(e))throw'Invalid number.';if(isNaN(s))throw'Invalid order.';if(t[1]=this._ensureNonFunctionExpression(t[1]),t[1]instanceof i._CellRangeExpression)return u=this._getItemList([t[1]],r),this._getRankOfCellRange(e,u.items,s);throw'Invalid Cell Reference.';case o.CountIf:if(t[0]=this._ensureNonFunctionExpression(t[0]),t[0]instanceof i._CellRangeExpression)return u=this._getItemList([t[0]],r,!1),this._countCellsByCriterias([u.items],[t[1]],r);throw'Invalid Cell Reference.';case o.CountIfs:return this._handleCountIfs(t,r);case o.SumIf:if(t[0]=this._ensureNonFunctionExpression(t[0]),t[0]instanceof i._CellRangeExpression)return u=this._getItemList([t[0]],r,!1),t[2]=this._ensureNonFunctionExpression(t[2]),t[2]!=null&&t[2]instanceof i._CellRangeExpression&&(f=this._getItemList([t[2]],r)),this._sumCellsByCriterias([u.items],[t[1]],f?f.items:null,r);throw'Invalid Cell Reference.';case o.SumIfs:return this._handleSumIfs(t,r);case o.Product:return u=this._getItemList(t,r),this._getProductOfNumbers(u.items)}throw'Invalid aggregate type.';},h.prototype._getItemList=function(t,r,u,f,e,o){u===void 0&&(u=!0);f===void 0&&(f=!1);e===void 0&&(e=!0);for(var l=[],s,v,y,h,c=!0,a=0;a<t.length;a++)if(h=t[a],h=this._ensureNonFunctionExpression(h),h instanceof i._CellRangeExpression){y=h.getValues(e,o,r);n:for(v=0;v<y.length;v++)(s=y[v],f||s!=null&&s!=='')&&(c=c&&s instanceof Date,s=u&&!n.isBoolean(s)?+s:s,l.push(s))}else{if(s=h instanceof i._Expression?h.evaluate(r):h,n.isPrimitive(s)||(s=s.value),!f&&(s==null||s===''))continue;c=c&&s instanceof Date;s=u?+s:s;l.push(s)}return l.length===0&&(c=!1),{isDate:c,items:l}},h.prototype._countBlankCells=function(t){for(var r=0,u=0,i;r<t.length;r++)i=t[r],(i==null||n.isString(i)&&i===''||n.isNumber(i)&&isNaN(i))&&u++;return u},h.prototype._countNumberCells=function(t){for(var r=0,u=0,i;r<t.length;r++)i=t[r],i!=null&&n.isNumber(i)&&!isNaN(i)&&u++;return u},h.prototype._getRankOfCellRange=function(n,t,i){i===void 0&&(i=0);var r=0,f=0,u;for(i?t.sort(function(n,t){return isNaN(n)||isNaN(t)?-1:n-t}):t.sort(function(n,t){return isNaN(n)||isNaN(t)?1:t-n});r<t.length;r++)if((u=t[r],!isNaN(u))&&(f++,n===u))return f;throw n+' is not in the cell range.';},h.prototype._handleCountIfs=function(n,t){var u=0,f=[],e=[],o,r,s,h;if(n.length%2!=0)throw'Invalid params.';for(;u<n.length/2;u++)if(r=n[2*u],r=this._ensureNonFunctionExpression(r),r instanceof i._CellRangeExpression){if(u===0)if(r.cells)s=r.cells.rowSpan,h=r.cells.columnSpan;else throw'Invalid Cell Reference.';else if(r.cells){if(r.cells.rowSpan!==s||r.cells.columnSpan!==h)throw'The row span and column span of each cell range has to be same with each other.';}else throw'Invalid Cell Reference.';o=this._getItemList([r],t,!1);f[u]=o.items;e[u]=n[2*u+1]}else throw'Invalid Cell Reference.';return this._countCellsByCriterias(f,e,t)},h.prototype._countCellsByCriterias=function(t,r,u,f){for(var c=0,o=0,a=0,p=t[0].length,v=[],s,l,y,h,e;o<r.length;o++)e=i._Expression.toString(r[o],u),e==='*'?v.push(e):v.push(this._parseRightExpr(e));for(;c<p;c++){s=!1;n:for(o=0;o<t.length;o++)if(y=t[o],h=y[c],e=v[o],typeof e=='string'){if(e!=='*'&&(h==null||h==='')){s=!1;break n}if(s=e==='*'||this.evaluate(this._combineExpr(h,e),null,u),!s)break n}else if(s=s=e.reg.test(h.toString())===e.checkMathces,!s)break n;s&&(f?(l=f[c],l!=null&&n.isNumber(l)&&!isNaN(l)&&a++):a++)}return a},h.prototype._handleSumIfs=function(n,t){var f=1,e=[],o=[],s,h,r,u,c,l;if(n.length%2!=1)throw'Invalid params.';if(r=n[0],r=this._ensureNonFunctionExpression(r),r instanceof i._CellRangeExpression){if(r.cells)c=r.cells.rowSpan,l=r.cells.columnSpan;else throw'Invalid Sum Cell Reference.';h=this._getItemList([r],t)}else throw'Invalid Sum Cell Reference.';for(;f<(n.length+1)/2;f++)if(u=n[2*f-1],u=this._ensureNonFunctionExpression(u),u instanceof i._CellRangeExpression){if(u.cells){if(u.cells.rowSpan!==c||u.cells.columnSpan!==l)throw'The row span and column span of each cell range has to be same with each other.';}else throw'Invalid Criteria Cell Reference.';s=this._getItemList([u],t,!1);e[f-1]=s.items;o[f-1]=n[2*f]}else throw'Invalid Criteria Cell Reference.';return this._sumCellsByCriterias(e,o,h.items,t)},h.prototype._sumCellsByCriterias=function(t,r,u,f){var c=0,o=0,v=0,l,p=t[0].length,a=[],s,y,h,e;for(u==null&&(u=t[0]);o<r.length;o++)e=i._Expression.toString(r[o],f),e==='*'?a.push(e):a.push(this._parseRightExpr(e));for(;c<p;c++){s=!1;l=u[c];n:for(o=0;o<t.length;o++)if(y=t[o],h=y[c],e=a[o],typeof e=='string'){if(e!=='*'&&(h==null||h==='')){s=!1;break n}if(s=e==='*'||this.evaluate(this._combineExpr(h,e),null,f),!s)break n}else if(s=e.reg.test(h.toString())===e.checkMathces,!s)break n;s&&n.isNumber(l)&&!isNaN(l)&&(v+=l)}return v},h.prototype._getProductOfNumbers=function(t){var i,r=0,u=1,f=!1;if(t)for(;r<t.length;r++)i=t[r],n.isNumber(i)&&!isNaN(i)&&(u*=i,f=!0);return f?u:0},h.prototype._handleSubtotal=function(t,r){var u,o,f,s,h=!0;if(u=i._Expression.toNumber(t[0],r),u>=1&&u<=11||u>=101&&u<=111){u>=101&&u<=111&&(h=!1);u=n.asEnum(u,e);o=this._getItemList(t.slice(1),r,!0,!1,h);switch(u){case e.Count:case e.CountWithoutHidden:return this._countNumberCells(o.items);case e.CountA:case e.CountAWithoutHidden:return o.items.length;case e.Product:case e.ProductWithoutHidden:return this._getProductOfNumbers(o.items);case e.Average:case e.AverageWithoutHidden:f=n.Aggregate.Avg;break;case e.Max:case e.MaxWithoutHidden:f=n.Aggregate.Max;break;case e.Min:case e.MinWithoutHidden:f=n.Aggregate.Min;break;case e.Std:case e.StdWithoutHidden:f=n.Aggregate.Std;break;case e.StdPop:case e.StdPopWithoutHidden:f=n.Aggregate.StdPop;break;case e.Sum:case e.SumWithoutHidden:f=n.Aggregate.Sum;break;case e.Var:case e.VarWithoutHidden:f=n.Aggregate.Var;break;case e.VarPop:case e.VarPopWithoutHidden:f=n.Aggregate.VarPop}return s=n.getAggregate(f,o.items),o.isDate&&(s=new Date(s)),s}throw'Invalid Subtotal function.';},h.prototype._handleDCount=function(n,t){var r=n[0],u=n[2],e,o,f;if(r=this._ensureNonFunctionExpression(r),u=this._ensureNonFunctionExpression(u),r instanceof i._CellRangeExpression&&u instanceof i._CellRangeExpression&&(e=n[1].evaluate(t),o=this._getColumnIndexByField(r,e),f=this._getItemList([r],t,!0,!1,!0,o),f.items&&f.items.length>1))return this._DCountWithCriterias(f.items.slice(1),r,u);throw'Invalid Count Cell Reference.';},h.prototype._DCountWithCriterias=function(n,t,r){var u=r.cells,v=0,h,c,y,e,f,p,o,w,s,l,a;if(h=this._getSheet(t.sheetRef),c=this._getSheet(r.sheetRef),u.rowSpan>1){for(y=u.topRow,e=u.bottomRow;e>u.topRow;e--){for(l=[],a=[],f=u.leftCol;f<=u.rightCol;f++)if(o=this._owner.getCellValue(e,f,!1,c),o!=null&&o!=='')if(a.push(new i._Expression(o)),w=this._owner.getCellValue(y,f,!1,c),p=this._getColumnIndexByField(t,w),s=this._getItemList([t],h,!1,!1,!0,p),s.items!=null&&s.items.length>1)l.push(s.items.slice(1));else throw'Invalid Count Cell Reference.';v+=this._countCellsByCriterias(l,a,h,n)}return v}throw'Invalid Criteria Cell Reference.';},h.prototype._getColumnIndexByField=function(t,i){var r,o,f,u,e;if(r=t.cells,e=r.topRow,e===-1)throw'Invalid Count Cell Reference.';if(n.isInt(i)&&!isNaN(i)){if(i>=1&&i<=r.columnSpan)return r.leftCol+i-1}else for(o=this._getSheet(t.sheetRef),f=r.leftCol;f<=r.rightCol;f++)if(u=this._owner.getCellValue(e,f,!1,o),i=n.isString(i)?i.toLowerCase():i,u=n.isString(u)?u.toLowerCase():u,i===u)return f;throw'Invalid field.';},h.prototype._getSumProduct=function(n,t){var f,e=0,i=this._getItemListForSumProduct(n,t),o,s,r,u;if(i.length>0)for(o=i[0].length,s=i.length,r=0;r<o;r++){for(f=1,u=0;u<s;u++)f*=i[u][r];e+=f}return e},h.prototype._getItemListForSumProduct=function(n,t){for(var s=[[]],f,e,o,h,r,u=0;u<n.length;u++){if(r=n[u],f=[],r=this._ensureNonFunctionExpression(r),r instanceof i._CellRangeExpression)for(h=r.getValues(!0,null,t),o=0;o<h.length;o++)e=h[o],f.push(+e);else e=r instanceof i._Expression?r.evaluate(t):r,f.push(+e);if(u>0&&f.length!==s[0].length)throw'The cell ranges of the sumProduct formula must have the same dimensions.';s[u]=f}return s},h.prototype._getSheet=function(n){var t=0,i;if(n)for(;t<this._owner.sheets.length;t++)if(i=this._owner.sheets[t],i.name===n)break;return i},h.prototype._parseRightExpr=function(n){var t,r,i=!1;if(n.indexOf('?')>-1||n.indexOf('*')>-1){if(t=n.match(/([\?\*]*)(\w+)([\?\*]*)(\w+)([\?\*]*)/),t!=null&&t.length===6)r=new RegExp('^'+(t[1].length>0?this._parseRegCriteria(t[1]):'')+t[2]+(t[3].length>0?this._parseRegCriteria(t[3]):'')+t[4]+(t[5].length>0?this._parseRegCriteria(t[5]):'')+'$','i');else throw'Invalid Criteria.';return/^[<>=]/.test(n)?n.trim()[0]==='='&&(i=!0):i=!0,{reg:r,checkMathces:i}}if(isNaN(+n))if(/^\w/.test(n))n='="'+n+'"';else if(/^[<>=]{1,2}\s*-?.+$/.test(n))n=n.replace(/([<>=]{1,2})\s*(-?.+)/,'$1"$2"');else throw'Invalid Criteria.';else n='='+ +n;return n},h.prototype._combineExpr=function(t,i){return(n.isString(t)||n.isDate(t))&&(t='"'+t+'"'),t='='+t,t+i},h.prototype._parseRegCriteria=function(n){for(var i=0,t=0,r='';i<n.length;i++)n[i]==='*'?(t>0&&(r+='\\w{'+t+'}',t=0),r+='\\w*'):n[i]==='?'&&t++;return t>0&&(r+='\\w{'+t+'}'),r},h.prototype._calculateRate=function(n,t){var v=1e-7,w=20,p=0,b=0,y,r,u,e,o,s,c,k,a,f,l,h;for(u=i._Expression.toNumber(n[0],t),e=i._Expression.toNumber(n[1],t),o=i._Expression.toNumber(n[2],t),s=n[3]!=null?i._Expression.toNumber(n[3],t):0,c=n[4]!=null?i._Expression.toNumber(n[4],t):0,k=n[5]!=null?i._Expression.toNumber(n[5],t):.1,r=k,Math.abs(r)<v?a=o*(1+u*r)+e*(1+r*c)*u+s:(f=Math.exp(u*Math.log(1+r)),a=o*f+e*(1/r+c)*(f-1)+s),l=o+e*u+s,h=o*f+e*(1/r+c)*(f-1)+s,y=r;Math.abs(l-h)>v&&p<w;)r=(h*b-l*y)/(h-l),b=y,y=r,Math.abs(r)<v?a=o*(1+u*r)+e*(1+r*c)*u+s:(f=Math.exp(u*Math.log(1+r)),a=o*f+e*(1/r+c)*(f-1)+s),l=h,h=a,++p;if(Math.abs(l-h)>v&&p===w)throw'It is not able to calculate the rate with current parameters.';return r},h.prototype._handleHLookup=function(n,t){var f=n[0].evaluate(t),e=n[1],o=i._Expression.toNumber(n[2],t),s=n[3]!=null?i._Expression.toBoolean(n[3],t):!0,r,u;if(f==null||f=='')throw'Invalid lookup value.';if(isNaN(o)||o<0)throw'Invalid row index.';if(e=this._ensureNonFunctionExpression(e),e instanceof i._CellRangeExpression){if(r=e.cells,o>r.rowSpan)throw'Row index is out of the cell range.';if(s?(u=this._exactMatch(f,r,t,!1),u===-1&&(u=this._approximateMatch(f,r,t))):u=this._exactMatch(f,r,t),u===-1)throw'Lookup Value is not found.';return this._owner.getCellValue(r.topRow+o-1,u,!1,t)}throw'Invalid Cell Reference.';},h.prototype._exactMatch=function(t,i,r,u){u===void 0&&(u=!0);var h=i.topRow,e,o,f,s;if(n.isString(t)&&(t=t.toLowerCase()),u&&n.isString(t)&&(t.indexOf('?')>-1||t.indexOf('*')>-1))if(f=t.match(/([\?\*]*)(\w+)([\?\*]*)(\w+)([\?\*]*)/),f!=null&&f.length===6)s=new RegExp('^'+(f[1].length>0?this._parseRegCriteria(f[1]):'')+f[2]+(f[3].length>0?this._parseRegCriteria(f[3]):'')+f[4]+(f[5].length>0?this._parseRegCriteria(f[5]):'')+'$','i');else throw'Invalid lookup value.';for(e=i.leftCol;e<=i.rightCol;e++)if(o=this._owner.getCellValue(h,e,!1,r),s!=null){if(s.test(o))return e}else if(n.isString(o)&&(o=o.toLowerCase()),t===o)return e;return-1},h.prototype._approximateMatch=function(t,i,r){var u,f,s=i.topRow,e=[],o=0;for(n.isString(t)&&(t=t.toLowerCase()),f=i.leftCol;f<=i.rightCol;f++)u=this._owner.getCellValue(s,f,!1,r),u=isNaN(+u)?u:+u,e.push({value:u,index:f});for(e.sort(function(t,i){return(n.isString(t.value)&&(t.value=t.value.toLowerCase()),n.isString(i.value)&&(i.value=i.value.toLowerCase()),t.value>i.value)?-1:t.value===i.value?i.index-t.index:1});o<e.length;o++)if(u=e[o],n.isString(u.value)&&(u.value=u.value.toLowerCase()),t>u.value)return u.index;throw'Lookup Value is not found.';},h.prototype._parseToScientificValue=function(t,i,r,u,f){var o,h,e,a,s,c=0,l;if(Math.abs(t)>=1)for(h='+',o=Math.pow(10,i.length);t>o;)t/=o,c+=i.length;else for(h='-',o=Math.pow(10,i.length);t*o<o;)t*=o,c+=i.length;if(e=n.Globalize.format(t,'D'+i.length),r)for(e+=n.Globalize.format(t-Math.floor(t),i+r).substring(1),a=e.indexOf('.'),a>-1?s=e.length-1-e.indexOf('.'):(e+='.',s=0);s<r.length-1;)e+='0',s++;if(e+='E'+h+n.Globalize.format(c,'D'+u.length),f)for(e+='.',l=1;l<f.length;l++)e+='0';return e},h.prototype._checkCache=function(n){var t=this._expressionCache[n];if(t)return t;if(t=this._parse(n),this._token.tokenID!==u.END||this._token.tokenType!==f.GROUP)throw'Invalid Expression: '+n;return this._cacheSize>1e4&&this._clearExpressionCache(),this._expressionCache[n]=t,this._cacheSize++,t},h.prototype._ensureNonFunctionExpression=function(n,t){while(n instanceof i._FunctionExpression)n=n.evaluate(t);return n},h.prototype._getDefinedName=function(n,t){for(var i,u,r=0;r<this._owner.definedNames.length;r++)if(i=this._owner.definedNames[r],i.name.toLowerCase()===n)if(i.sheetName){if(i.sheetName.toLowerCase()===t)return i}else u=i;return u},h}(),s,r,f,u,o,e;i._CalcEngine=h;s=function(){function n(n,t,i){this._value=n;this._tokenID=t;this._tokenType=i}return Object.defineProperty(n.prototype,"value",{get:function(){return this._value},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"tokenID",{get:function(){return this._tokenID},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"tokenType",{get:function(){return this._tokenType},enumerable:!0,configurable:!0}),n}();i._Token=s;r=function(){function t(t,i,r){this._paramMax=Number.MAX_VALUE;this._paramMin=Number.MIN_VALUE;this._func=t;n.isNumber(i)&&!isNaN(i)&&(this._paramMax=i);n.isNumber(r)&&!isNaN(r)&&(this._paramMin=r)}return Object.defineProperty(t.prototype,"paramMax",{get:function(){return this._paramMax},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"paramMin",{get:function(){return this._paramMin},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"func",{get:function(){return this._func},enumerable:!0,configurable:!0}),t}();i._FunctionDefinition=r,function(n){n[n.COMPARE=0]="COMPARE";n[n.ADDSUB=1]="ADDSUB";n[n.MULDIV=2]="MULDIV";n[n.POWER=3]="POWER";n[n.CONCAT=4]="CONCAT";n[n.GROUP=5]="GROUP";n[n.LITERAL=6]="LITERAL";n[n.IDENTIFIER=7]="IDENTIFIER"}(f=i._TokenType||(i._TokenType={})),function(n){n[n.GT=0]="GT";n[n.LT=1]="LT";n[n.GE=2]="GE";n[n.LE=3]="LE";n[n.EQ=4]="EQ";n[n.NE=5]="NE";n[n.ADD=6]="ADD";n[n.SUB=7]="SUB";n[n.MUL=8]="MUL";n[n.DIV=9]="DIV";n[n.DIVINT=10]="DIVINT";n[n.MOD=11]="MOD";n[n.POWER=12]="POWER";n[n.CONCAT=13]="CONCAT";n[n.OPEN=14]="OPEN";n[n.CLOSE=15]="CLOSE";n[n.END=16]="END";n[n.COMMA=17]="COMMA";n[n.PERIOD=18]="PERIOD";n[n.ATOM=19]="ATOM"}(u=i._TokenID||(i._TokenID={})),function(n){n[n.Count=0]="Count";n[n.CountA=1]="CountA";n[n.ConutBlank=2]="ConutBlank";n[n.CountIf=3]="CountIf";n[n.CountIfs=4]="CountIfs";n[n.Rank=5]="Rank";n[n.SumIf=6]="SumIf";n[n.SumIfs=7]="SumIfs";n[n.Product=8]="Product"}(o||(o={})),function(n){n[n.Average=1]="Average";n[n.Count=2]="Count";n[n.CountA=3]="CountA";n[n.Max=4]="Max";n[n.Min=5]="Min";n[n.Product=6]="Product";n[n.Std=7]="Std";n[n.StdPop=8]="StdPop";n[n.Sum=9]="Sum";n[n.Var=10]="Var";n[n.VarPop=11]="VarPop";n[n.AverageWithoutHidden=101]="AverageWithoutHidden";n[n.CountWithoutHidden=102]="CountWithoutHidden";n[n.CountAWithoutHidden=103]="CountAWithoutHidden";n[n.MaxWithoutHidden=104]="MaxWithoutHidden";n[n.MinWithoutHidden=105]="MinWithoutHidden";n[n.ProductWithoutHidden=106]="ProductWithoutHidden";n[n.StdWithoutHidden=107]="StdWithoutHidden";n[n.StdPopWithoutHidden=108]="StdPopWithoutHidden";n[n.SumWithoutHidden=109]="SumWithoutHidden";n[n.VarWithoutHidden=110]="VarWithoutHidden";n[n.VarPopWithoutHidden=111]="VarPopWithoutHidden"}(e||(e={}))})(i=t.sheet||(t.sheet={}))})(t=n.grid||(n.grid={}))})(wijmo||(wijmo={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t;(function(t){var i;(function(i){'use strict';var r=function(){function t(n){this._token=n?n instanceof i._Token?n:new i._Token(n,i._TokenID.ATOM,i._TokenType.LITERAL):new i._Token(null,i._TokenID.ATOM,i._TokenType.IDENTIFIER)}return Object.defineProperty(t.prototype,"token",{get:function(){return this._token},enumerable:!0,configurable:!0}),t.prototype.evaluate=function(){if(this._token.tokenType!==i._TokenType.LITERAL)throw'Bad expression.';return this._token.value},t.toString=function(t,i){var r=t.evaluate(i);return n.isPrimitive(r)||(r=r.value),r!=null?r.toString():''},t.toNumber=function(t,i){var r=t.evaluate(i),u=['January','February','March','April','May','June','July','August','September','October','November','December','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],f;if(n.isPrimitive(r)||(r=r.value),n.isNumber(r))return r;if(n.isBoolean(r))return r?1:0;if(n.isDate(r))return this._toOADate(r);if(n.isString(r)){if(r){if(isNaN(+r)){for(f in u)if(r.indexOf(u[f])>-1)return this._toOADate(new Date(r));return+r}return+r}return 0}return n.changeType(r,n.DataType.Number,'')},t.toBoolean=function(t,i){var r=t.evaluate(i);return(n.isPrimitive(r)||(r=r.value),n.isBoolean(r))?r:n.isNumber(r)?r===0?!1:!0:n.changeType(r,n.DataType.Boolean,'')},t.toDate=function(t,i){var r=t.evaluate(i);return(n.isPrimitive(r)||(r=r.value),n.isDate(r))?r:n.isNumber(r)?this._fromOADate(r):n.changeType(r,n.DataType.Date,'')},t._toOADate=function(n){var t=Date.UTC(1899,11,30),i=Date.UTC(n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds(),n.getMilliseconds());return(i-t)/864e5},t._fromOADate=function(n){var t=Date.UTC(1899,11,30),i=new Date,r=n>=60?0:864e5;return new Date(n*864e5+t+i.getTimezoneOffset()*6e4+r)},t}(),u,f,e,o;i._Expression=r;u=function(n){function t(t,i){var r=n.call(this,t)||this;return r._expr=i,r}return __extends(t,n),t.prototype.evaluate=function(n){if(this.token.tokenID===i._TokenID.SUB)return this._evaluatedValue==null&&(this._evaluatedValue=-r.toNumber(this._expr,n)),this._evaluatedValue;if(this.token.tokenID===i._TokenID.ADD)return this._evaluatedValue==null&&(this._evaluatedValue=+r.toNumber(this._expr,n)),this._evaluatedValue;throw'Bad expression.';},t}(r);i._UnaryExpression=u;f=function(t){function u(n,i,r){var u=t.call(this,n)||this;return u._leftExpr=i,u._rightExpr=r,u}return __extends(u,t),u.prototype.evaluate=function(n){var e,o,s,h,t,u,f,c=!1;if(this._evaluatedValue!=null)return this._evaluatedValue;if(e=r.toString(this._leftExpr,n),o=r.toString(this._rightExpr,n),this.token.tokenType===i._TokenType.CONCAT)return this._evaluatedValue=e+o,this._evaluatedValue;if(s=this._leftExpr.evaluate(n),h=this._rightExpr.evaluate(n),c=this._isDateValue(s)||this._isDateValue(h),t=r.toNumber(this._leftExpr,n),u=r.toNumber(this._rightExpr,n),f=t-u,this.token.tokenType===i._TokenType.COMPARE)switch(this.token.tokenID){case i._TokenID.GT:return f>0;case i._TokenID.LT:return f<0;case i._TokenID.GE:return f>=0;case i._TokenID.LE:return f<=0;case i._TokenID.EQ:return isNaN(f)?(this._evaluatedValue=e.toLowerCase()===o.toLowerCase(),this._evaluatedValue):(this._evaluatedValue=f===0,this._evaluatedValue);case i._TokenID.NE:return isNaN(f)?(this._evaluatedValue=e.toLowerCase()!==o.toLowerCase(),this._evaluatedValue):(this._evaluatedValue=f!==0,this._evaluatedValue)}switch(this.token.tokenID){case i._TokenID.ADD:this._evaluatedValue=t+u;break;case i._TokenID.SUB:this._evaluatedValue=t-u;break;case i._TokenID.MUL:this._evaluatedValue=t*u;break;case i._TokenID.DIV:this._evaluatedValue=t/u;break;case i._TokenID.DIVINT:this._evaluatedValue=Math.floor(t/u);break;case i._TokenID.MOD:this._evaluatedValue=Math.floor(t%u);break;case i._TokenID.POWER:u===0&&(this._evaluatedValue=1);u===.5&&(this._evaluatedValue=Math.sqrt(t));u===1&&(this._evaluatedValue=t);u===2&&(this._evaluatedValue=t*t);u===3&&(this._evaluatedValue=t*t*t);u===4&&(this._evaluatedValue=t*t*t*t);this._evaluatedValue=Math.pow(t,u);break;default:this._evaluatedValue=NaN}if(!isNaN(this._evaluatedValue))return c&&(this._evaluatedValue={value:r._fromOADate(this._evaluatedValue),format:s.format||h.format}),this._evaluatedValue;throw'Bad expression.';},u.prototype._isDateValue=function(t){return n.isPrimitive(t)?n.isDate(t):n.isDate(t.value)},u}(r);i._BinaryExpression=f;e=function(i){function r(n,t,r){var u=i.call(this)||this;return u._cells=n,u._sheetRef=t,u._flex=r,u._evalutingRange={},u}return __extends(r,i),r.prototype.evaluate=function(n){return this._evaluatedValue==null&&(this._evaluatedValue=this._getCellValue(this._cells,n)),this._evaluatedValue},r.prototype.getValues=function(i,r,u){i===void 0&&(i=!0);var e,o=[],s=0,f,r,h,c;if(h=r!=null&&!isNaN(+r)?r:this._cells.leftCol,c=r!=null&&!isNaN(+r)?r:this._cells.rightCol,u=this._getSheet()||u||this._flex.selectedSheet,!u)return null;for(f=this._cells.topRow;f<=this._cells.bottomRow;f++){if(f>=u.grid.rows.length)throw'The cell reference is out of the cell range of the flexsheet.';if(i||u.grid.rows[f].isVisible!==!1)for(r=h;r<=c;r++){if(r>=u.grid.columns.length)throw'The cell reference is out of the cell range of the flexsheet.';(i||u.grid.columns[r].isVisible!==!1)&&(e=this._getCellValue(new t.CellRange(f,r),u),n.isPrimitive(e)||(e=e.value),o[s]=e,s++)}}return o},r.prototype.getValuseWithTwoDimensions=function(i,r){i===void 0&&(i=!0);var e,c=[],s,h=0,o=0,u,f;if(r=this._getSheet()||r||this._flex.selectedSheet,!r)return null;for(u=this._cells.topRow;u<=this._cells.bottomRow;u++){if(u>=r.grid.rows.length)throw'The cell reference is out of the cell range of the flexsheet.';if(!i&&r.grid.rows[u].isVisible===!1){h++;continue}for(s=[],o=0,f=this._cells.leftCol;f<=this._cells.rightCol;f++){if(f>=r.grid.columns.length)throw'The cell reference is out of the cell range of the flexsheet.';if(!i&&r.grid.columns[f].isVisible===!1){o++;continue}e=this._getCellValue(new t.CellRange(u,f),r);n.isPrimitive(e)||(e=e.value);s[o]=e;o++}c[h]=s;h++}return c},Object.defineProperty(r.prototype,"cells",{get:function(){return this._cells},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"sheetRef",{get:function(){return this._sheetRef},enumerable:!0,configurable:!0}),r.prototype._getCellValue=function(n,t){var t,i;if(t=this._getSheet()||t||this._flex.selectedSheet,!t)return null;if(i=t.name+':'+n.row+','+n.col+'-'+n.row2+','+n.col2,this._evalutingRange[i])throw'Circular Reference';try{if(this._flex)return this._evalutingRange[i]=!0,this._flex.getCellValue(n.row,n.col,!1,t)}finally{delete this._evalutingRange[i]}},r.prototype._getSheet=function(){var n=0,t;if(!this._sheetRef)return null;for(;n<this._flex.sheets.length;n++)if(t=this._flex.sheets[n],t.name.toLowerCase()===this._sheetRef)return t;throw'Invalid sheet reference';},r}(r);i._CellRangeExpression=e;o=function(n){function t(t,i,r){r===void 0&&(r=!0);var u=n.call(this)||this;return u._funcDefinition=t,u._params=i,u._needCacheEvaluatedVal=r,u}return __extends(t,n),t.prototype.evaluate=function(n,t,i){return this._needCacheEvaluatedVal?(this._evaluatedValue==null&&(this._evaluatedValue=this._funcDefinition.func(this._params,n,t,i)),this._evaluatedValue):this._funcDefinition.func(this._params,n,t,i)},t}(r);i._FunctionExpression=o})(i=t.sheet||(t.sheet={}))})(t=n.grid||(n.grid={}))}(wijmo||(wijmo={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t;(function(t){var i;(function(t){'use strict';var i=function(){function n(n){this._owner=n;this._sheetIndex=n.selectedSheetIndex}return Object.defineProperty(n.prototype,"sheetIndex",{get:function(){return this._sheetIndex},enumerable:!0,configurable:!0}),n.prototype.undo=function(){throw'This abstract method must be overridden.';},n.prototype.redo=function(){throw'This abstract method must be overridden.';},n.prototype.saveNewState=function(){throw'This abstract method must be overridden.';},n}(),u,f,e,o,s,h,r,c,l,a,v;t._UndoAction=i;u=function(n){function t(t,i){var u=this,s,i,e,f,o;if(u=n.call(this,t)||this,u._isPaste=!1,u._selections=i?[i]:t.selectedSheet.selectionRanges.slice(),u._oldValues={},u._mergeAction=new r(t),t.rows.length>0&&t.columns.length>0)for(s=0;s<u._selections.length;s++)for(i=u._selections[s],e=i.topRow;e<=i.bottomRow;e++)for(f=i.leftCol;f<=i.rightCol;f++)o=t.getCellData(e,f,t.columns[f]&&!!t.columns[f].dataMap),o=o==null?'':o,u._oldValues['r'+e+'_c'+f]={row:e,col:f,value:o};return u}return __extends(t,n),Object.defineProperty(t.prototype,"isPaste",{get:function(){return this._isPaste},enumerable:!0,configurable:!0}),t.prototype.undo=function(){var n=this,t,i;n._owner._clearCalcEngine();n._owner.selectedSheet.selectionRanges.clear();n._owner.deferUpdate(function(){for(t=0;t<n._selections.length;t++)i=n._selections[t],n._owner.selectedSheet.selectionRanges.push(i);Object.keys(n._oldValues).forEach(function(t){var i=n._oldValues[t];n._owner.setCellData(i.row,i.col,i.value)});n._mergeAction.undo();n._owner.refresh(!1)})},t.prototype.redo=function(){var n=this,t,i;n._owner._clearCalcEngine();n._owner.selectedSheet.selectionRanges.clear();n._owner.deferUpdate(function(){for(t=0;t<n._selections.length;t++)i=n._selections[t],n._owner.selectedSheet.selectionRanges.push(i);Object.keys(n._newValues).forEach(function(t){var i=n._newValues[t];n._owner.setCellData(i.row,i.col,i.value)});n._mergeAction.redo();n._owner.refresh(!1)})},t.prototype.saveNewState=function(){var u,i,f,t,n,r;for(this._newValues={},u=0;u<this._selections.length;u++)for(i=this._selections[u],t=i.topRow;t<=i.bottomRow;t++)for(n=i.leftCol;n<=i.rightCol;n++){if(f=this._owner.columns[n],!f)return!1;r=this._owner.getCellData(t,n,!!f.dataMap);r=r==null?'':r;this._newValues['r'+t+'_c'+n]={row:t,col:n,value:r}}return this._mergeAction.saveNewState(),!this._checkActionState()},t.prototype.markIsPaste=function(){this._isPaste=!0},t.prototype.updateForPasting=function(n){var t=this._selections[this._selections.length-1],i=this._owner.getCellData(n.row,n.col,!!this._owner.columns[n.col].dataMap);t||(t=this._owner.selection,this._selections=[t]);i=i==null?'':i;this._oldValues['r'+n.row+'_c'+n.col]={row:n.row,col:n.col,value:i};t.row=Math.min(t.topRow,n.topRow);t.row2=Math.max(t.bottomRow,n.bottomRow);t.col=Math.min(t.leftCol,n.leftCol);t.col2=Math.max(t.rightCol,n.rightCol)},t.prototype._checkActionState=function(){var n=this,t=!0;return Object.keys(n._oldValues).forEach(function(i){var r,u;t&&(r=n._oldValues[i],u=n._newValues[i],r&&u&&r.value!==u.value&&(t=!1))}),t},t}(i);t._EditAction=u;f=function(n){function t(t,i,r){var u=n.call(this,t)||this;return u._panel=i,u._colIndex=r,u._oldColWidth=i.columns[r].width,u}return __extends(t,n),t.prototype.undo=function(){var n=this._panel.columns[this._colIndex];n&&(n.width=this._oldColWidth)},t.prototype.redo=function(){var n=this._panel.columns[this._colIndex];n&&(n.width=this._newColWidth)},t.prototype.saveNewState=function(){return(this._newColWidth=this._panel.columns[this._colIndex].width,this._oldColWidth===this._newColWidth)?!1:!0},t}(i);t._ColumnResizeAction=f;e=function(n){function t(t,i,r){var u=n.call(this,t)||this;return u._panel=i,u._rowIndex=r,u._oldRowHeight=i.rows[r].height,u}return __extends(t,n),t.prototype.undo=function(){var n=this._panel.rows[this._rowIndex];n&&(n.height=this._oldRowHeight)},t.prototype.redo=function(){var n=this._panel.rows[this._rowIndex];n&&(n.height=this._newRowHeight)},t.prototype.saveNewState=function(){return(this._newRowHeight=this._panel.rows[this._rowIndex].height,this._oldRowHeight===this._newRowHeight)?!1:!0},t}(i);t._RowResizeAction=e;o=function(n){function t(t){var i=this,r,u=[];for(i=n.call(this,t)||this,i._selection=t.selection,r=0;r<t.columns.length;r++)u.push(t.columns[r]);return i._oldValue={columns:u,sortList:t.sortManager._committedList.slice(),styledCells:t.selectedSheet?JSON.parse(JSON.stringify(t.selectedSheet._styledCells)):null,mergedCells:t._cloneMergedCells()},i}return __extends(t,n),t.prototype.undo=function(){var f,i,t,r,u,e,o,n=this;if(n._owner.selectedSheet){for(n._owner._isUndoing=!0,n._owner._clearCalcEngine(),n._owner.finishEditing(),n._owner.columns.clear(),n._owner.selectedSheet._styledCells=undefined,n._owner.selectedSheet._mergedRanges=undefined,n._owner.columns.beginUpdate(),f=0;f<n._oldValue.columns.length;f++)n._owner.columns.push(n._oldValue.columns[f]);if(n._owner.columns.endUpdate(),n._owner.selectedSheet._styledCells=n._oldValue.styledCells,n._owner.selectedSheet._mergedRanges=n._oldValue.mergedCells,n._affectedFormulas&&(r=n._affectedFormulas.oldFormulas),n._owner.deferUpdate(function(){if(!!r&&r.length>0){for(i=0;i<r.length;i++)t=r[i],t.point!=null?t.sheet.name===n._owner.selectedSheet.name?n._owner.setCellData(t.point.x,t.point.y,t.formula):t.sheet.grid.setCellData(t.point.x,t.point.y,t.formula):t.row._ubv[t.column._hash]=t.formula;n._owner._copyTo(n._owner.selectedSheet);n._owner._copyFrom(n._owner.selectedSheet)}}),n._affectedDefinedNameVals&&(u=n._affectedDefinedNameVals.oldDefinedNameVals),u&&u.length>0)for(i=0;i<u.length;i++)e=u[i],o=n._owner._getDefinedNameIndexByName(e.name),o>-1&&(n._owner.definedNames[o].value=e.value);n._owner.selectedSheet.grid.wj_sheetInfo.styledCells=n._owner.selectedSheet._styledCells;n._owner.selectedSheet.grid.wj_sheetInfo.mergedRanges=n._owner.selectedSheet._mergedRanges;n._owner.sortManager.sortDescriptions.sourceCollection=n._oldValue.sortList.slice();n._owner.sortManager.commitSort(!1);n._owner.sortManager._refresh();n._owner.selection=n._selection;n._owner.refresh(!0);n._owner._isUndoing=!1;setTimeout(function(){n._owner._setFlexSheetToDirty();n._owner.refresh(!0)},10)}},t.prototype.redo=function(){var f,i,t,r,u,e,o,n=this;if(n._owner.selectedSheet){for(n._owner._isUndoing=!0,n._owner._clearCalcEngine(),n._owner.finishEditing(),n._owner.columns.clear(),n._owner.selectedSheet._styledCells=undefined,n._owner.selectedSheet._mergedRanges=undefined,n._owner.columns.beginUpdate(),f=0;f<n._newValue.columns.length;f++)n._owner.columns.push(n._newValue.columns[f]);if(n._owner.columns.endUpdate(),n._owner.selectedSheet._styledCells=n._newValue.styledCells,n._owner.selectedSheet._mergedRanges=n._newValue.mergedCells,n._affectedFormulas&&(r=n._affectedFormulas.newFormulas),n._owner.deferUpdate(function(){if(!!r&&r.length>0){for(i=0;i<r.length;i++)t=r[i],t.point!=null?t.sheet.name===n._owner.selectedSheet.name?n._owner.setCellData(t.point.x,t.point.y,t.formula):t.sheet.grid.setCellData(t.point.x,t.point.y,t.formula):t.row._ubv[t.column._hash]=t.formula;n._owner._copyTo(n._owner.selectedSheet);n._owner._copyFrom(n._owner.selectedSheet)}}),n._affectedDefinedNameVals&&(u=n._affectedDefinedNameVals.newDefinedNameVals),u&&u.length>0)for(i=0;i<u.length;i++)e=u[i],o=n._owner._getDefinedNameIndexByName(e.name),o>-1&&(n._owner.definedNames[o].value=e.value);n._owner.selectedSheet.grid.wj_sheetInfo.styledCells=n._owner.selectedSheet._styledCells;n._owner.selectedSheet.grid.wj_sheetInfo.mergedRanges=n._owner.selectedSheet._mergedRanges;n._owner.sortManager.sortDescriptions.sourceCollection=n._newValue.sortList.slice();n._owner.sortManager.commitSort(!1);n._owner.sortManager._refresh();n._owner.selection=n._selection;n._owner.refresh(!0);n._owner._isUndoing=!1;setTimeout(function(){n._owner._setFlexSheetToDirty();n._owner.refresh(!0)},10)}},t.prototype.saveNewState=function(){for(var t=[],n=0;n<this._owner.columns.length;n++)t.push(this._owner.columns[n]);return this._newValue={columns:t,sortList:this._owner.sortManager._committedList.slice(),styledCells:this._owner.selectedSheet?JSON.parse(JSON.stringify(this._owner.selectedSheet._styledCells)):null,mergedCells:this._owner._cloneMergedCells()},!0},t}(i);t._ColumnsChangedAction=o;s=function(n){function i(t){var i=this,r,u,f=[],e=[];for(i=n.call(this,t)||this,i._selection=t.selection,r=0;r<t.rows.length;r++)f.push(t.rows[r]);for(u=0;u<t.columns.length;u++)e.push(t.columns[u]);return i._oldValue={rows:f,columns:e,itemsSource:t.itemsSource?t.itemsSource.slice():undefined,styledCells:t.selectedSheet?JSON.parse(JSON.stringify(t.selectedSheet._styledCells)):null,mergedCells:t._cloneMergedCells()},i}return __extends(i,n),i.prototype.undo=function(){var u,s,r,f,i,e,o,h,c,n=this,l=!!n._oldValue.itemsSource;if(n._owner.selectedSheet){for(n._owner._isUndoing=!0,n._owner._clearCalcEngine(),n._owner.finishEditing(),n._owner.columns.clear(),n._owner.rows.clear(),n._owner.selectedSheet._styledCells=undefined,n._owner.selectedSheet._mergedRanges=undefined,l&&(n._owner.autoGenerateColumns=!1,n._owner.itemsSource=n._oldValue.itemsSource.slice()),n._owner.rows.beginUpdate(),u=0;u<n._oldValue.rows.length;u++)f=n._oldValue.rows[u],l?f.dataItem||f instanceof t.HeaderRow||n._owner.rows.splice(u,0,f):n._owner.rows.push(f);for(s=0;s<n._oldValue.columns.length;s++)n._owner.columns.push(n._oldValue.columns[s]);if(n._owner.rows.endUpdate(),n._owner.selectedSheet._styledCells=n._oldValue.styledCells,n._owner.selectedSheet._mergedRanges=n._oldValue.mergedCells,n._affectedFormulas&&(e=n._affectedFormulas.oldFormulas),n._owner.deferUpdate(function(){if(!!e&&e.length>0){for(r=0;r<e.length;r++)i=e[r],i.point!=null?i.sheet.name===n._owner.selectedSheet.name?n._owner.setCellData(i.point.x,i.point.y,i.formula):i.sheet.grid.setCellData(i.point.x,i.point.y,i.formula):i.row._ubv[i.column._hash]=i.formula;n._owner._copyTo(n._owner.selectedSheet);n._owner._copyFrom(n._owner.selectedSheet)}}),n._affectedDefinedNameVals&&(o=n._affectedDefinedNameVals.oldDefinedNameVals),o&&o.length>0)for(r=0;r<o.length;r++)h=o[r],c=n._owner._getDefinedNameIndexByName(h.name),c>-1&&(n._owner.definedNames[c].value=h.value);n._owner.selectedSheet.grid.wj_sheetInfo.styledCells=n._owner.selectedSheet._styledCells;n._owner.selectedSheet.grid.wj_sheetInfo.mergedRanges=n._owner.selectedSheet._mergedRanges;n._owner.selection=n._selection;n._owner.refresh(!0);n._owner._isUndoing=!1;setTimeout(function(){n._owner._setFlexSheetToDirty();n._owner.refresh(!0)},10)}},i.prototype.redo=function(){var u,s,r,f,i,e,o,h,c,n=this,l=!!n._newValue.itemsSource;if(n._owner.selectedSheet){for(n._owner._isUndoing=!0,n._owner._clearCalcEngine(),n._owner.finishEditing(),n._owner.columns.clear(),n._owner.rows.clear(),n._owner.selectedSheet._styledCells=undefined,n._owner.selectedSheet._mergedRanges=undefined,l&&(n._owner.autoGenerateColumns=!1,n._owner.itemsSource=n._newValue.itemsSource.slice()),n._owner.rows.beginUpdate(),u=0;u<n._newValue.rows.length;u++)f=n._newValue.rows[u],l?f.dataItem||f instanceof t.HeaderRow||n._owner.rows.splice(u,0,f):n._owner.rows.push(f);for(s=0;s<n._newValue.columns.length;s++)n._owner.columns.push(n._newValue.columns[s]);if(n._owner.rows.endUpdate(),n._owner.selectedSheet._styledCells=n._newValue.styledCells,n._owner.selectedSheet._mergedRanges=n._newValue.mergedCells,n._affectedFormulas&&(e=n._affectedFormulas.newFormulas),n._owner.deferUpdate(function(){if(!!e&&e.length>0){for(r=0;r<e.length;r++)i=e[r],i.point!=null?i.sheet.name===n._owner.selectedSheet.name?n._owner.setCellData(i.point.x,i.point.y,i.formula):i.sheet.grid.setCellData(i.point.x,i.point.y,i.formula):i.row._ubv[i.column._hash]=i.formula;n._owner._copyTo(n._owner.selectedSheet);n._owner._copyFrom(n._owner.selectedSheet)}}),n._affectedDefinedNameVals&&(o=n._affectedDefinedNameVals.newDefinedNameVals),o&&o.length>0)for(r=0;r<o.length;r++)h=o[r],c=n._owner._getDefinedNameIndexByName(h.name),c>-1&&(n._owner.definedNames[c].value=h.value);n._owner.selectedSheet.grid.wj_sheetInfo.styledCells=n._owner.selectedSheet._styledCells;n._owner.selectedSheet.grid.wj_sheetInfo.mergedRanges=n._owner.selectedSheet._mergedRanges;n._owner.selection=n._selection;n._owner.refresh(!0);n._owner._isUndoing=!1;setTimeout(function(){n._owner._setFlexSheetToDirty();n._owner.refresh(!0)},10)}},i.prototype.saveNewState=function(){for(var t,i=[],r=[],n=0;n<this._owner.rows.length;n++)i.push(this._owner.rows[n]);for(t=0;t<this._owner.columns.length;t++)r.push(this._owner.columns[t]);return this._newValue={rows:i,columns:r,itemsSource:this._owner.itemsSource?this._owner.itemsSource.slice():undefined,styledCells:this._owner.selectedSheet?JSON.parse(JSON.stringify(this._owner.selectedSheet._styledCells)):null,mergedCells:this._owner._cloneMergedCells()},!0},i}(i);t._RowsChangedAction=s;h=function(n){function t(t,i){var r=n.call(this,t)||this;return r._oldStyledCells=i?JSON.parse(JSON.stringify(i)):t.selectedSheet?JSON.parse(JSON.stringify(t.selectedSheet._styledCells)):null,r}return __extends(t,n),t.prototype.undo=function(){this._owner.selectedSheet&&(this._owner.selectedSheet._styledCells=JSON.parse(JSON.stringify(this._oldStyledCells)),this._owner.selectedSheet.grid.wj_sheetInfo.styledCells=this._owner.selectedSheet._styledCells,this._owner.refresh(!1))},t.prototype.redo=function(){this._owner.selectedSheet&&(this._owner.selectedSheet._styledCells=JSON.parse(JSON.stringify(this._newStyledCells)),this._owner.selectedSheet.grid.wj_sheetInfo.styledCells=this._owner.selectedSheet._styledCells,this._owner.refresh(!1))},t.prototype.saveNewState=function(){return this._newStyledCells=this._owner.selectedSheet?JSON.parse(JSON.stringify(this._owner.selectedSheet._styledCells)):null,!0},t}(i);t._CellStyleAction=h;r=function(n){function t(t){var i=n.call(this,t)||this;return i._oldMergedCells=t._cloneMergedCells(),i}return __extends(t,n),t.prototype.undo=function(){this._owner.selectedSheet&&(this._owner._clearCalcEngine(),this._owner.selectedSheet._mergedRanges=this._oldMergedCells,this._owner.selectedSheet.grid.wj_sheetInfo.mergedRanges=this._owner.selectedSheet._mergedRanges,this._owner.refresh(!0))},t.prototype.redo=function(){this._owner.selectedSheet&&(this._owner._clearCalcEngine(),this._owner.selectedSheet._mergedRanges=this._newMergedCells,this._owner.selectedSheet.grid.wj_sheetInfo.mergedRanges=this._owner.selectedSheet._mergedRanges,this._owner.refresh(!0))},t.prototype.saveNewState=function(){return this._newMergedCells=this._owner._cloneMergedCells(),!0},t}(i);t._CellMergeAction=r;c=function(n){function t(t){var u=this,i,r,f=[],e=[];if(u=n.call(this,t)||this,!t.itemsSource){for(i=0;i<t.rows.length;i++)e.push(t.rows[i]);for(r=0;r<t.columns.length;r++)f.push(t.columns[r])}return u._oldValue={sortList:t.sortManager._committedList.slice(),rows:e,columns:f,formulas:t._scanFormulas()},u}return __extends(t,n),t.prototype.undo=function(){var n=this,t,i,r,u;n._owner.selectedSheet&&(n._owner._isUndoing=!0,n._owner.deferUpdate(function(){if(n._owner._clearCalcEngine(),n._owner.sortManager.sortDescriptions.sourceCollection=n._oldValue.sortList.slice(),n._owner.sortManager.commitSort(!1),n._owner.sortManager._refresh(),!n._owner.itemsSource){for(n._owner.rows.clear(),n._owner.columns.clear(),n._owner.selectedSheet.grid.rows.clear(),n._owner.selectedSheet.grid.columns.clear(),t=0;t<n._oldValue.rows.length;t++)r=n._oldValue.rows[t],n._owner.rows.push(r),n._owner.selectedSheet.grid.rows.push(r);for(i=0;i<n._oldValue.columns.length;i++)u=n._oldValue.columns[i],n._owner.columns.push(u),n._owner.selectedSheet.grid.columns.push(u);n._owner._resetFormulas(n._oldValue.formulas);n._owner._isUndoing=!1;setTimeout(function(){n._owner._setFlexSheetToDirty();n._owner.refresh(!0)},10)}}))},t.prototype.redo=function(){var n=this,t,i,r,u;n._owner.selectedSheet&&(n._owner._isUndoing=!0,n._owner.deferUpdate(function(){if(n._owner._clearCalcEngine(),n._owner.sortManager.sortDescriptions.sourceCollection=n._newValue.sortList.slice(),n._owner.sortManager.commitSort(!1),n._owner.sortManager._refresh(),!n._owner.itemsSource){for(n._owner.rows.clear(),n._owner.columns.clear(),n._owner.selectedSheet.grid.rows.clear(),n._owner.selectedSheet.grid.columns.clear(),t=0;t<n._newValue.rows.length;t++)r=n._newValue.rows[t],n._owner.rows.push(r),n._owner.selectedSheet.grid.rows.push(r);for(i=0;i<n._newValue.columns.length;i++)u=n._newValue.columns[i],n._owner.columns.push(u),n._owner.selectedSheet.grid.columns.push(u);n._owner._resetFormulas(n._newValue.formulas);n._owner._isUndoing=!1;setTimeout(function(){n._owner._setFlexSheetToDirty();n._owner.refresh(!0)},10)}}))},t.prototype.saveNewState=function(){var n,t,i=[],r=[];if(!this._owner.itemsSource){for(n=0;n<this._owner.rows.length;n++)r.push(this._owner.rows[n]);for(t=0;t<this._owner.columns.length;t++)i.push(this._owner.columns[t])}return this._newValue={sortList:this._owner.sortManager._committedList.slice(),rows:r,columns:i,formulas:this._owner._scanFormulas()},!0},t}(i);t._SortColumnAction=c;l=function(t){function i(n,i,r,u){var f=this,o,e,s,h,c;if(f=t.call(this,n)||this,n.selectedSheet){for(f._isDraggingColumns=i.topRow===0&&i.bottomRow===n.rows.length-1?!0:!1,f._isCopyCells=u,f._dragRange=i,f._dropRange=r,f._oldDroppingCells=[],f._oldDroppingColumnSetting={},o=r.topRow;o<=r.bottomRow;o++)for(e=r.leftCol;e<=r.rightCol;e++)f._isDraggingColumns&&(f._oldDroppingColumnSetting[e]||(f._oldDroppingColumnSetting[e]={dataType:n.columns[e].dataType,align:n.columns[e].align,format:n.columns[e].format})),s=o*f._owner.columns.length+e,c=f._owner.selectedSheet._styledCells[s]?JSON.parse(JSON.stringify(f._owner.selectedSheet._styledCells[s])):null,h=f._owner.getCellData(o,e,!1),f._oldDroppingCells.push({rowIndex:o,columnIndex:e,cellContent:h,cellStyle:c});if(!u)for(f._draggingCells=[],f._draggingColumnSetting={},o=i.topRow;o<=i.bottomRow;o++)for(e=i.leftCol;e<=i.rightCol;e++)f._isDraggingColumns&&(f._draggingColumnSetting[e]||(f._draggingColumnSetting[e]={dataType:n.columns[e].dataType,align:n.columns[e].align,format:n.columns[e].format})),s=o*f._owner.columns.length+e,c=f._owner.selectedSheet._styledCells[s]?JSON.parse(JSON.stringify(f._owner.selectedSheet._styledCells[s])):null,h=f._owner.getCellData(o,e,!1),f._draggingCells.push({rowIndex:o,columnIndex:e,cellContent:h,cellStyle:c});return f}}return __extends(i,t),i.prototype.undo=function(){var t=this,i,r,o,f,e,s,u,h,c,l;t._owner.selectedSheet&&(t._owner._clearCalcEngine(),t._owner.deferUpdate(function(){if(t._affectedFormulas&&(s=t._affectedFormulas.oldFormulas),!!s&&s.length>0)for(i=0;i<s.length;i++)u=s[i],u.sheet.name===t._owner.selectedSheet.name?t._owner.setCellData(u.point.x,u.point.y,u.formula):u.sheet.grid.setCellData(u.point.x,u.point.y,u.formula);if(t._affectedDefinedNameVals&&(h=t._affectedDefinedNameVals.oldDefinedNameVals),h&&h.length>0)for(i=0;i<h.length;i++)c=h[i],l=t._owner._getDefinedNameIndexByName(c.name),l>-1&&(t._owner.definedNames[l].value=c.value);for(i=0;i<t._oldDroppingCells.length;i++)r=t._oldDroppingCells[i],t._owner.setCellData(r.rowIndex,r.columnIndex,r.cellContent),o=r.rowIndex*t._owner.columns.length+r.columnIndex,r.cellStyle?t._owner.selectedSheet._styledCells[o]=r.cellStyle:delete t._owner.selectedSheet._styledCells[o];if(t._isDraggingColumns&&!!t._oldDroppingColumnSetting&&Object.keys(t._oldDroppingColumnSetting).forEach(function(i){t._owner.columns[+i].dataType=t._oldDroppingColumnSetting[+i].dataType?t._oldDroppingColumnSetting[+i].dataType:n.DataType.Object;t._owner.columns[+i].align=t._oldDroppingColumnSetting[+i].align;t._owner.columns[+i].format=t._oldDroppingColumnSetting[+i].format}),!t._isCopyCells){for(i=0;i<t._draggingCells.length;i++)r=t._draggingCells[i],t._owner.setCellData(r.rowIndex,r.columnIndex,r.cellContent),o=r.rowIndex*t._owner.columns.length+r.columnIndex,r.cellStyle&&(t._owner.selectedSheet._styledCells[o]=r.cellStyle);if(t._isDraggingColumns&&!!t._draggingColumnSetting&&Object.keys(t._draggingColumnSetting).forEach(function(i){t._owner.columns[+i].dataType=t._draggingColumnSetting[+i].dataType?t._draggingColumnSetting[+i].dataType:n.DataType.Object;t._owner.columns[+i].align=t._draggingColumnSetting[+i].align;t._owner.columns[+i].format=t._draggingColumnSetting[+i].format}),t._isDraggingColumns)if(t._dragRange.leftCol<t._dropRange.leftCol)for(e=t._dragRange.leftCol,f=t._dropRange.leftCol;f<=t._dropRange.rightCol;f++)t._owner._updateColumnFiler(f,e),e++;else for(e=t._dragRange.rightCol,f=t._dropRange.rightCol;f>=t._dropRange.leftCol;f--)t._owner._updateColumnFiler(f,e),e--}}))},i.prototype.redo=function(){var t=this,i,r,e,f,o,s,u,h,c,l;t._owner.selectedSheet&&(t._owner._clearCalcEngine(),t._owner.deferUpdate(function(){if(t._affectedFormulas&&(s=t._affectedFormulas.newFormulas),!!s&&s.length>0)for(i=0;i<s.length;i++)u=s[i],u.sheet.name===t._owner.selectedSheet.name?t._owner.setCellData(u.point.x,u.point.y,u.formula):u.sheet.grid.setCellData(u.point.x,u.point.y,u.formula);if(t._affectedDefinedNameVals&&(h=t._affectedDefinedNameVals.newDefinedNameVals),h&&h.length>0)for(i=0;i<h.length;i++)c=h[i],l=t._owner._getDefinedNameIndexByName(c.name),l>-1&&(t._owner.definedNames[l].value=c.value);if(!t._isCopyCells){for(i=0;i<t._draggingCells.length;i++)r=t._draggingCells[i],t._owner.setCellData(r.rowIndex,r.columnIndex,null),e=r.rowIndex*t._owner.columns.length+r.columnIndex,t._owner.selectedSheet._styledCells[e]&&delete t._owner.selectedSheet._styledCells[e];t._isDraggingColumns&&!!t._draggingColumnSetting&&Object.keys(t._draggingColumnSetting).forEach(function(i){t._owner.columns[+i].dataType=n.DataType.Object;t._owner.columns[+i].align=null;t._owner.columns[+i].format=null})}for(i=0;i<t._newDroppingCells.length;i++)r=t._newDroppingCells[i],t._owner.setCellData(r.rowIndex,r.columnIndex,r.cellContent),e=r.rowIndex*t._owner.columns.length+r.columnIndex,r.cellStyle?t._owner.selectedSheet._styledCells[e]=r.cellStyle:delete t._owner.selectedSheet._styledCells[e];if(t._isDraggingColumns&&!!t._newDroppingColumnSetting&&Object.keys(t._newDroppingColumnSetting).forEach(function(i){t._owner.columns[+i].dataType=t._newDroppingColumnSetting[+i].dataType?t._newDroppingColumnSetting[+i].dataType:n.DataType.Object;t._owner.columns[+i].align=t._newDroppingColumnSetting[+i].align;t._owner.columns[+i].format=t._newDroppingColumnSetting[+i].format}),t._isDraggingColumns&&!t._isCopyCells)if(t._dragRange.leftCol>t._dropRange.leftCol)for(o=t._dropRange.leftCol,f=t._dragRange.leftCol;f<=t._dragRange.rightCol;f++)t._owner._updateColumnFiler(f,o),o++;else for(o=t._dropRange.rightCol,f=t._dragRange.rightCol;f>=t._dragRange.leftCol;f--)t._owner._updateColumnFiler(f,o),o--}))},i.prototype.saveNewState=function(){var t,n,i,r,u;if(!this._owner.selectedSheet)return!1;if(this._dropRange){for(this._newDroppingCells=[],this._newDroppingColumnSetting={},t=this._dropRange.topRow;t<=this._dropRange.bottomRow;t++)for(n=this._dropRange.leftCol;n<=this._dropRange.rightCol;n++)this._isDraggingColumns&&(this._newDroppingColumnSetting[n]||(this._newDroppingColumnSetting[n]={dataType:this._owner.columns[n].dataType,align:this._owner.columns[n].align,format:this._owner.columns[n].format})),i=t*this._owner.columns.length+n,u=this._owner.selectedSheet._styledCells[i]?JSON.parse(JSON.stringify(this._owner.selectedSheet._styledCells[i])):null,r=this._owner.getCellData(t,n,!1),this._newDroppingCells.push({rowIndex:t,columnIndex:n,cellContent:r,cellStyle:u});return!0}return!1},i}(i);t._MoveCellsAction=l;a=function(n){function t(t){var i=this,f,u,e,o;for(i=n.call(this,t)||this,i._oldValues=[],i._oldCutValues=[],i._mergeAction=new r(t),i._cutSheet=t._copiedSheet,i._selection=t.selection,i._cutSelection=t._copiedRanges[0],o=i._cutSheet===t.selectedSheet?t:i._cutSheet.grid,f=i._cutSelection.topRow;f<=i._cutSelection.bottomRow;f++)for(u=i._cutSelection.leftCol;u<=i._cutSelection.rightCol;u++)e=o.getCellData(f,u,!!o.columns[u].dataMap),e=e==null?'':e,i._oldCutValues.push({row:f,col:u,value:e});return i}return __extends(t,n),t.prototype.undo=function(){var n=this;n._owner._clearCalcEngine();n._owner.selectedSheet.selectionRanges.clear();n._owner.deferUpdate(function(){var t,i,r=n._cutSheet===n._owner.selectedSheet?n._owner:n._cutSheet.grid;for(n._owner.selectedSheet.selectionRanges.push(n._selection),t=0;t<n._oldCutValues.length;t++)i=n._oldCutValues[t],r.setCellData(i.row,i.col,i.value);for(t=0;t<n._oldValues.length;t++)i=n._oldValues[t],n._owner.setCellData(i.row,i.col,i.value);n._mergeAction.undo();n._owner.refresh(!1)})},t.prototype.redo=function(){var n=this;n._owner._clearCalcEngine();n._owner.selectedSheet.selectionRanges.clear();n._owner.deferUpdate(function(){var t,i,r=n._cutSheet===n._owner.selectedSheet?n._owner:n._cutSheet.grid;for(n._owner.selectedSheet.selectionRanges.push(n._selection),t=0;t<n._newCutValues.length;t++)i=n._newCutValues[t],r.setCellData(i.row,i.col,i.value);for(t=0;t<n._newValues.length;t++)i=n._newValues[t],n._owner.setCellData(i.row,i.col,i.value);n._mergeAction.redo();n._owner.refresh(!1)})},t.prototype.saveNewState=function(){var t,n,r,i,u=this._cutSheet===this._owner.selectedSheet?this._owner:this._cutSheet.grid;for(this._newCutValues=[],t=this._cutSelection.topRow;t<=this._cutSelection.bottomRow;t++)for(n=this._cutSelection.leftCol;n<=this._cutSelection.rightCol;n++)i=u.getCellData(t,n,!!u.columns[n].dataMap),i=i==null?'':i,this._newCutValues.push({row:t,col:n,value:i});for(this._newValues=[],t=this._selection.topRow;t<=this._selection.bottomRow;t++)for(n=this._selection.leftCol;n<=this._selection.rightCol;n++){if(r=this._owner.columns[n],!r)return!1;i=this._owner.getCellData(t,n,!!this._owner.columns[n].dataMap);i=i==null?'':i;this._newValues.push({row:t,col:n,value:i})}return this._mergeAction.saveNewState(),!0},t.prototype.updateForPasting=function(n){var t=this._owner.getCellData(n.row,n.col,!!this._owner.columns[n.col].dataMap);t=t==null?'':t;this._oldValues.push({row:n.row,col:n.col,value:t});this._selection.row=Math.min(this._selection.topRow,n.topRow);this._selection.row2=Math.max(this._selection.bottomRow,n.bottomRow);this._selection.col=Math.min(this._selection.leftCol,n.leftCol);this._selection.col2=Math.max(this._selection.rightCol,n.rightCol)},t}(i);t._CutAction=a;v=function(n){function t(t){var i=n.call(this,t)||this;return i._oldFilterDefinition=t._filter.filterDefinition,i}return __extends(t,n),t.prototype.undo=function(){this._owner._filter.filterDefinition=this._oldFilterDefinition},t.prototype.redo=function(){this._owner._filter.filterDefinition=this._newFilterDefinition},t.prototype.saveNewState=function(){return this._oldFilterDefinition!==this._owner._filter.filterDefinition?(this._newFilterDefinition=this._owner._filter.filterDefinition,!0):!1},t}(i);t._FilteringAction=v})(i=t.sheet||(t.sheet={}))})(t=n.grid||(n.grid={}))}(wijmo||(wijmo={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t;(function(t){var i;(function(t){'use strict';var i=function(t){function i(n,i){var r=t.call(this,n)||this;return r._idx=-1,r._owner=i,r.applyTemplate('',r.getTemplate(),{_insRows:'insert-rows',_delRows:'delete-rows',_insCols:'insert-columns',_delCols:'delete-columns'}),r._init(),r}return __extends(i,t),Object.defineProperty(i.prototype,"visible",{get:function(){return this.hostElement.style.display!=='none'},enumerable:!0,configurable:!0}),i.prototype.show=function(n,t){var i=(t?t.x:n.clientX)+(n?window.pageXOffset:0),r=(t?t.y:n.clientY)+(n?window.pageYOffset:0);this.hostElement.style.position='absolute';this.hostElement.style.display='inline';r+this.hostElement.clientHeight>window.innerHeight&&(r-=this.hostElement.clientHeight);i+this.hostElement.clientWidth>window.innerWidth&&(i-=this.hostElement.clientWidth);this.hostElement.style.top=r+'px';this.hostElement.style.left=i+'px'},i.prototype.hide=function(){this._idx=-1;var n=this.hostElement.querySelectorAll('.wj-context-menu-item');this._removeSelectedState(n);this.hostElement.style.display='none'},i.prototype.moveToNext=function(){var t=this.hostElement.querySelectorAll('.wj-context-menu-item');this._removeSelectedState(t);this._idx++;this._idx>=t.length&&(this._idx=0);n.addClass(t[this._idx],'wj-context-menu-item-selected')},i.prototype.moveToPrev=function(){var t=this.hostElement.querySelectorAll('.wj-context-menu-item');this._removeSelectedState(t);this._idx--;this._idx<0&&(this._idx=t.length-1);n.addClass(t[this._idx],'wj-context-menu-item-selected')},i.prototype.moveToFirst=function(){var t=this.hostElement.querySelectorAll('.wj-context-menu-item');this._removeSelectedState(t);this._idx=0;n.addClass(t[this._idx],'wj-context-menu-item-selected')},i.prototype.moveToLast=function(){var t=this.hostElement.querySelectorAll('.wj-context-menu-item');this._removeSelectedState(t);this._idx=t.length-1;n.addClass(t[this._idx],'wj-context-menu-item-selected')},i.prototype.handleContextMenu=function(){if(this._idx===-1)this.moveToNext();else{var n=this.hostElement.querySelectorAll('.wj-context-menu-item');switch(n[this._idx]){case this._insCols:this._owner.insertColumns();break;case this._insRows:this._owner.insertRows();break;case this._delCols:this._owner.deleteColumns();break;case this._delRows:this._owner.deleteRows()}this.hide();this._owner.hostElement.focus()}},i.prototype._init=function(){var n=this,t=this.hostElement.querySelectorAll('.wj-context-menu-item');n.hostElement.style.zIndex='9999';document.querySelector('body').appendChild(n.hostElement);n.addEventListener(document.body,'mousemove',function(){n._removeSelectedState(t)});n.addEventListener(n.hostElement,'contextmenu',function(n){n.preventDefault()});n.addEventListener(n._insRows,'click',function(){n._owner.insertRows();n.hide();n._owner.hostElement.focus()});n.addEventListener(n._delRows,'click',function(){n._owner.deleteRows();n.hide();n._owner.hostElement.focus()});n.addEventListener(n._insCols,'click',function(){n._owner.insertColumns();n.hide();n._owner.hostElement.focus()});n.addEventListener(n._delCols,'click',function(){n._owner.deleteColumns();n.hide();n._owner.hostElement.focus()})},i.prototype._removeSelectedState=function(t){for(var i=0;i<t.length;i++)n.removeClass(t[i],'wj-context-menu-item-selected')},i}(n.Control);i.controlTemplate='<div class="wj-context-menu" width="150px"><div class="wj-context-menu-item" wj-part="insert-rows">Insert Row<\/div><div class="wj-context-menu-item" wj-part="delete-rows">Delete Rows<\/div><div class="wj-context-menu-item" wj-part="insert-columns">Insert Column<\/div><div class="wj-context-menu-item" wj-part="delete-columns">Delete Columns<\/div><\/div>';t._ContextMenu=i})(i=t.sheet||(t.sheet={}))})(t=n.grid||(n.grid={}))}(wijmo||(wijmo={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t;(function(t){var i;(function(t){'use strict';var i=function(n){function i(t,i){var r=n.call(this,t)||this;return r._splitterMousedownHdl=r._splitterMousedownHandler.bind(r),r._owner=i,r.hostElement.attributes.tabindex&&r.hostElement.attributes.removeNamedItem('tabindex'),r.applyTemplate('',r.getTemplate(),{_divSheet:'left',_divSplitter:'splitter',_divRight:'right'}),r._init(),r}return __extends(i,n),Object.defineProperty(i.prototype,"sheetControl",{get:function(){return this._sheetControl},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"visible",{get:function(){return this.hostElement.style.display!=='none'},set:function(n){this.hostElement.style.display=n?'block':'none';this._divSheet.style.display=n?'block':'none'},enumerable:!0,configurable:!0}),i.prototype.getSheetBlanketSize=function(){return 20},i.prototype.adjustSize=function(){var t=this._owner.scrollSize.width-this._owner.clientSize.width,i=this._owner.scrollSize.height-this._owner.clientSize.height,n=this._divSplitter.parentElement;t<=0?(n.style.minWidth='100px',this._divSplitter.style.display='none',this._divRight.style.display='none',this._divSheet.style.width='100%',this._divSplitter.removeEventListener('mousedown',this._splitterMousedownHdl,!0)):(n.style.minWidth='300px',this._divSplitter.style.display='none',this._divRight.style.display='none',this._divSheet.style.width='100%',this._divSplitter.removeEventListener('mousedown',this._splitterMousedownHdl,!0),this._divSplitter.addEventListener('mousedown',this._splitterMousedownHdl,!0));this._sheetControl._adjustSize()},i.prototype._init=function(){var n=this;n._funSplitterMousedown=function(t){n._splitterMouseupHandler(t)};n._divSplitter.parentElement.style.height=n.getSheetBlanketSize()+'px';n._sheetControl=new t._SheetTabs(n._divSheet,this._owner)},i.prototype._splitterMousedownHandler=function(n){this._startPos=n.pageX;document.addEventListener('mousemove',this._splitterMousemoveHandler.bind(this),!0);document.addEventListener('mouseup',this._funSplitterMousedown,!0);n.preventDefault()},i.prototype._splitterMousemoveHandler=function(n){this._startPos!==null&&typeof this._startPos!='undefined'&&this._adjustDis(n.pageX-this._startPos)},i.prototype._splitterMouseupHandler=function(n){document.removeEventListener('mousemove',this._splitterMousemoveHandler,!0);document.removeEventListener('mouseup',this._funSplitterMousedown,!0);this._adjustDis(n.pageX-this._startPos);this._startPos=null},i.prototype._adjustDis=function(n){var t=this._divRight.offsetWidth-n,i=this._divSheet.offsetWidth+n;(t<=100?(t=100,n=this._divRight.offsetWidth-t,i=this._divSheet.offsetWidth+n):i<=100&&(i=100,n=i-this._divSheet.offsetWidth,t=this._divRight.offsetWidth-n),n!=0)&&(this._divRight.style.width=t+'px',this._divSheet.style.width=i+'px',this._startPos=this._startPos+n)},i}(n.Control);i.controlTemplate='<div><div wj-part="left" style ="float:left;height:100%;overflow:hidden"><\/div><div wj-part="splitter" style="float:left;height:100%;width:6px;background-color:#e9eaee;padding:2px;cursor:e-resize"><div style="background-color:#8a9eb2;height:100%"><\/div><\/div><div wj-part="right" style="float:left;height:100%;background-color:#e9eaee"><\/div><\/div>';t._TabHolder=i})(i=t.sheet||(t.sheet={}))})(t=n.grid||(n.grid={}))}(wijmo||(wijmo={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t;(function(t){var i;(function(i){'use strict';var r=function(r){function u(){return r!==null&&r.apply(this,arguments)||this}return __extends(u,r),u.prototype.updateCell=function(u,f,e,o,s){var d=u.grid,ot=f,st=e,ut,g,c,y,h,w,ft,l,p,nt,b,v,tt,k,it,et,rt,a;u.cellType===t.CellType.Cell&&this._resetCellStyle(u.columns[e],o);r.prototype.updateCell.call(this,u,f,e,o,s);s&&!s.isSingleCell&&(f=s.row,e=s.col,ot=s.row2,st=s.col2);b=d._getBindingColumn(u,f,u.columns[e]);switch(u.cellType){case t.CellType.RowHeader:o.textContent=f+1+'';break;case t.CellType.ColumnHeader:ut=i.FlexSheet.convertNumberToAlpha(e);o.innerHTML=o.innerHTML.replace(n.escapeHtml(o.textContent),'').replace(o.textContent,'')+ut;o.style.textAlign='center';break;case t.CellType.Cell:if(c=u.grid,g=f*c.columns.length+e,l=c.selectedSheet&&c.selectedSheet._styledCells?c.selectedSheet._styledCells[g]:null,!s||s.isSingleCell||(tt=this._getFirstVisibleCell(c,s),f=tt.row,e=tt.col),u.rows[f]instanceof i.HeaderRow)u.columns[e].dataType===n.DataType.Boolean&&o.childElementCount===1&&o.firstElementChild instanceof HTMLInputElement&&o.firstElementChild.type==='checkbox'&&(o.innerHTML=n.escapeHtml(u.columns[e].header)),n.addClass(o,'wj-header-row');else if(h=c.getCellValue(f,e,!1),w=c.getCellData(f,e,!1),ft=w!=null&&typeof w=='string'&&w[0]==='=',k=u.rows[f]instanceof t.GroupRow,v=(l?l.format:null)||(k?null:b.format),c.editRange&&c.editRange.contains(f,e)?!n.isNumber(h)||b.dataMap||ft||(v&&(h=this._getFormattedValue(h,v)),nt=o.querySelector('input'),nt&&(nt.value=h)):u.columns[e].dataType===n.DataType.Boolean?(p=o.querySelector('[type="checkbox"]'),p&&(p.checked=c.getCellValue(f,e),p.disabled=p.disabled||!c.canEditCell(f,e))):b.dataMap&&!k?(h=c.getCellValue(f,e,!0),y=o.firstChild,y&&y.nodeType===3&&y.nodeValue!==h&&(y.nodeValue=h)):o.childElementCount===0&&o.textContent===c.getCellData(f,e,!0)&&(h=c.getCellValue(f,e,!0),h!==''&&n.isNumber(+h)&&!isNaN(+h)&&/[hsmy\:]/i.test(v)&&(it=i._Expression._fromOADate(+h),isNaN(it.getTime())||(h=n.Globalize.formatDate(it,v))),(v||!k)&&(h=n.isString(h)?h.replace(/^(\')(\s*=)/,'$2'):h,o.innerHTML=n.isString(h)?h&&this._isURL(h)?'<a href="'+h+'" target="_blank">'+n.escapeHtml(h)+'</a>':n.escapeHtml(h):h)),l){et=o.style;for(a in l)a==='className'?l.className&&n.addClass(o,l.className):a!=='format'&&(rt=l[a])&&(et[a]=(n.hasClass(o,'wj-state-selected')||n.hasClass(o,'wj-state-multi-selected'))&&(a==='color'||a==='backgroundColor')?'':a==='whiteSpace'&&rt==='normal'?'':rt)}!o.style.backgroundColor&&!o.style.color||(l||(c.selectedSheet._styledCells[g]=l={}),!o.style.backgroundColor||(l.backgroundColor=o.style.backgroundColor),!o.style.color||(l.color=o.style.color))}u.cellType===t.CellType.Cell&&(f!==d._lastVisibleFrozenRow||n.hasClass(o,'wj-frozen-row')||n.addClass(o,'wj-frozen-row'),e!==d._lastVisibleFrozenColumn||n.hasClass(o,'wj-frozen-col')||n.addClass(o,'wj-frozen-col'))},u.prototype._resetCellStyle=function(n,t){['fontFamily','fontSize','fontStyle','fontWeight','textDecoration','textAlign','verticalAlign','backgroundColor','color','whiteSpace','borderLeftStyle','borderLeftColor','borderLeftWidth','borderRightStyle','borderRightColor','borderRightWidth','borderTopStyle','borderTopColor','borderTopWidth','borderBottomStyle','borderBottomColor','borderBottomWidth'].forEach(function(i){i==='textAlign'?t.style.textAlign=n.getAlignment():t.style[i]=''})},u.prototype._getFormattedValue=function(t,i){return t!==Math.round(t)&&(i=i.replace(/([a-z])(\d*)(.*)/ig,'$0112$3')),n.Globalize.formatNumber(t,i,!0)},u.prototype._getFirstVisibleCell=function(n,i){for(var u,r=i.topRow;r<=i.bottomRow;r++)if(n.rows[r].isVisible)break;for(u=i.leftCol;u<=i.rightCol;u++)if(n.columns[u].isVisible)break;return new t.CellRange(r,u)},u.prototype._isURL=function(n){var t=new RegExp("^(https|http|ftp|rtsp|mms)://(([0-9a-z_!~*'().&=+$%-]+: )?[0-9a-z_!~*'().&=+$%-]+@)?(([0-9]{1,3}.){3}[0-9]{1,3}|([0-9a-z_!~*'()-]+.)*([0-9a-z][0-9a-z-]{0,61})?[0-9a-z].[a-z]{2,6})(:[0-9]{1,4})?((/?)|(/[0-9a-z_!~*'().;?:@&=+$,%#-]+)+/?)$");return t.test(n)},u}(t.CellFactory);i._FlexSheetCellFactory=r})(i=t.sheet||(t.sheet={}))})(t=n.grid||(n.grid={}))}(wijmo||(wijmo={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t;(function(t){var i;(function(i){'use strict';var s=[{name:'abs',description:'Returns the absolute value of a number.'},{name:'acos',description:'Returns the arccosine of a number.'},{name:'and',description:'Returns TRUE if all of its arguments are TRUE.'},{name:'asin',description:'Returns the arcsine of a number.'},{name:'atan',description:'Returns the arctangent of a number.'},{name:'atan2',description:'Returns the arctangent from x- and y-coordinates.'},{name:'average',description:'Returns the average of its arguments.'},{name:'ceiling',description:'Rounds a number to the nearest integer or to the nearest multiple of significance.'},{name:'char',description:'Returns the character specified by the code number.'},{name:'choose',description:'Chooses a value from a list of values.'},{name:'code',description:'Returns a numeric code for the first character in a text string.'},{name:'column',description:'Returns the column number of a reference.'},{name:'columns',description:'Returns the number of columns in a reference.'},{name:'concatenate',description:'Joins several text items into one text item.'},{name:'cos',description:'Returns the cosine of a number.'},{name:'count',description:'Counts how many numbers are in the list of arguments.'},{name:'counta',description:'Counts how many values are in the list of arguments.'},{name:'countblank',description:'Counts the number of blank cells within a range.'},{name:'countif',description:'Counts the number of cells within a range that meet the given criteria.'},{name:'countifs',description:'Counts the number of cells within a range that meet multiple criteria.'},{name:'date',description:'Returns the serial number of a particular date.'},{name:'datedif',description:'Calculates the number of days, months, or years between two dates.'},{name:'day',description:'Converts a serial number to a day of the month.'},{name:'dcount',description:'Counts the cells that contain numbers in a database.'},{name:'exp',description:'Returns e raised to the power of a given number.'},{name:'false',description:'Returns the logical value FALSE.'},{name:'find',description:'Finds one text value within another (case-sensitive).'},{name:'floor',description:'Rounds a number down, toward zero.'},{name:'hlookup',description:'Looks in the top row of an array and returns the value of the indicated cell.'},{name:'hour',description:'Converts a serial number to an hour.'},{name:'if',description:'Specifies a logical test to perform.'},{name:'index',description:'Uses an index to choose a value from a reference.'},{name:'left',description:'Returns the leftmost characters from a text value.'},{name:'len',description:'Returns the number of characters in a text string.'},{name:'ln',description:'Returns the natural logarithm of a number.'},{name:'lower',description:'Converts text to lowercase.'},{name:'max',description:'Returns the maximum value in a list of arguments.'},{name:'mid',description:'Returns a specific number of characters from a text string starting at the position you specify.'},{name:'min',description:'Returns the minimum value in a list of arguments.'},{name:'mod',description:'Returns the remainder from division.'},{name:'month',description:'Converts a serial number to a month.'},{name:'not',description:'Reverses the logic of its argument.'},{name:'now',description:'Returns the serial number of the current date and time.'},{name:'or',description:'Returns TRUE if any argument is TRUE.'},{name:'pi',description:'Returns the value of pi.'},{name:'power',description:'Returns the result of a number raised to a power.'},{name:'product',description:'Multiplies its arguments.'},{name:'proper',description:'Capitalizes the first letter in each word of a text value.'},{name:'rand',description:'Returns a random number between 0 and 1.'},{name:'rank',description:'Returns the rank of a number in a list of numbers.'},{name:'rate',description:'Returns the interest rate per period of an annuity.'},{name:'replace',description:'Replaces characters within text.'},{name:'rept',description:'Repeats text a given number of times.'},{name:'right',description:'Returns the rightmost characters from a text value.'},{name:'round',description:'Rounds a number to a specified number of digits.'},{name:'rounddown',description:'Rounds a number down, toward zero.'},{name:'roundup',description:'Rounds a number up, away from zero.'},{name:'row',description:'Returns the row number of a reference.'},{name:'rows',description:'Returns the number of rows in a reference.'},{name:'search',description:'Finds one text value within another (not case-sensitive).'},{name:'sin',description:'Returns the sine of the given angle.'},{name:'sqrt',description:'Returns a positive square root.'},{name:'stdev',description:'Estimates standard deviation based on a sample.'},{name:'stdevp',description:'Calculates standard deviation based on the entire population.'},{name:'substitute',description:'Substitutes new text for old text in a text string.'},{name:'subtotal',description:'Returns a subtotal in a list or database.'},{name:'sum',description:'Adds its arguments.'},{name:'sumif',description:'Adds the cells specified by a given criteria.'},{name:'sumifs',description:'Adds the cells in a range that meet multiple criteria.'},{name:'sumproduct',description:'Multiplies corresponding components in the given arrays, and returns the sum of those products.'},{name:'tan',description:'Returns the tangent of a number.'},{name:'text',description:'Formats a number and converts it to text.'},{name:'time',description:'Returns the serial number of a particular time.'},{name:'today',description:'Returns the serial number of today\'s date.'},{name:'trim',description:'Removes spaces from text.'},{name:'true',description:'Returns the logical value TRUE.'},{name:'trunc',description:'Truncates a number to an integer.'},{name:'upper',description:'Converts text to uppercase.'},{name:'value',description:'Converts a text argument to a number.'},{name:'var',description:'Estimates variance based on a sample.'},{name:'varp',description:'Calculates variance based on the entire population.'},{name:'year',description:'Converts a serial number to a year.'},],h=function(h){function c(r,u){var f=h.call(this,r,u)||this;return f._selectedSheetIndex=-1,f._columnHeaderClicked=!1,f._addingSheet=!1,f._mouseMoveHdl=f._mouseMove.bind(f),f._clickHdl=f._click.bind(f),f._touchStartHdl=f._touchStart.bind(f),f._touchEndHdl=f._touchEnd.bind(f),f._isContextMenuKeyDown=!1,f._isClicking=!1,f._resettingFilter=!1,f._definedNames=new n.collections.ObservableArray,f._needCopyToSheet=!0,f.selectedSheetChanged=new n.Event,f.draggingRowColumn=new n.Event,f.droppingRowColumn=new n.Event,f.loaded=new n.Event,f.unknownFunction=new n.Event,f.sheetCleared=new n.Event,f.prepareChangingRow=new n.Event,f.prepareChangingColumn=new n.Event,f.rowChanged=new n.Event,f.columnChanged=new n.Event,f._needCopyToSheet=!1,f._eCt.style.backgroundColor='white',n.addClass(f.hostElement,'wj-flexsheet'),n.setCss(f.hostElement,{fontFamily:'Arial'}),f._cf=new i._FlexSheetCellFactory,f._bndSortConverter=f._sheetSortConverter.bind(f),f._init(),f.showSort=!1,f.allowSorting=!1,f.showGroups=!1,f.showMarquee=!0,f.showSelectedHeaders=t.HeadersVisibility.All,f.allowResizing=t.AllowResizing.Both,f.allowDragging=t.AllowDragging.None,f._needCopyToSheet=!0,f}return __extends(c,h),Object.defineProperty(c.prototype,"sheets",{get:function(){return this._sheets||(this._sheets=new i.SheetCollection,this._sheets.selectedSheetChanged.addHandler(this._selectedSheetChange,this),this._sheets.collectionChanged.addHandler(this._sourceChange,this),this._sheets.sheetVisibleChanged.addHandler(this._sheetVisibleChange,this),this._sheets.sheetCleared.addHandler(this.onSheetCleared,this)),this._sheets},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"selectedSheetIndex",{get:function(){return this._selectedSheetIndex},set:function(n){n!==this._selectedSheetIndex&&(this._showSheet(n),this._sheets.selectedIndex=n)},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"selectedSheet",{get:function(){return this._sheets[this._selectedSheetIndex]},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"isFunctionListOpen",{get:function(){return this._functionListHost&&this._functionListHost.style.display!=='none'},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"isTabHolderVisible",{get:function(){return this._tabHolder.visible},set:function(n){n!==this._tabHolder.visible&&(this._divContainer.style.height=n?this._divContainer.parentElement.clientHeight-this._tabHolder.getSheetBlanketSize()+'px':this._divContainer.parentElement.clientHeight+'px',this._tabHolder.visible=n)},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"undoStack",{get:function(){return this._undoStack},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"sortManager",{get:function(){return this._sortManager},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"showFilterIcons",{get:function(){return!this._filter?!1:this._filter.showFilterIcons},set:function(n){!this._filter||this._filter.showFilterIcons===n||(this._filter.showFilterIcons=n)},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"definedNames",{get:function(){return this._definedNames},enumerable:!0,configurable:!0}),c.prototype.onSelectedSheetChanged=function(n){this._sortManager._refresh();this.selectedSheetChanged.raise(this,n)},c.prototype.onDraggingRowColumn=function(n){this.draggingRowColumn.raise(this,n)},c.prototype.onDroppingRowColumn=function(){this.droppingRowColumn.raise(this,new n.EventArgs)},c.prototype.onLoaded=function(){var t=this;t._toRefresh&&(clearTimeout(t._toRefresh),t._toRefresh=null);t._toRefresh=setTimeout(function(){t._setFlexSheetToDirty();t.invalidate()},10);t.loaded.raise(this,new n.EventArgs)},c.prototype.onUnknownFunction=function(n){this.unknownFunction.raise(this,n)},c.prototype.onSheetCleared=function(){this.sheetCleared.raise(this,new n.EventArgs)},c.prototype.onPrepareChangingRow=function(){this.prepareChangingRow.raise(this,new n.EventArgs)},c.prototype.onPrepareChangingColumn=function(){this.prepareChangingColumn.raise(this,new n.EventArgs)},c.prototype.onRowChanged=function(n){this.rowChanged.raise(this,n)},c.prototype.onColumnChanged=function(n){this.columnChanged.raise(this,n)},c.prototype.refresh=function(n){var u,e,f,t,i;if(n===void 0&&(n=!0),this._divContainer.style.height=this._divContainer.parentElement.clientHeight-(this.isTabHolderVisible?this._tabHolder.getSheetBlanketSize():0)+'px',this.preserveSelectedState||!this.selectedSheet||(this.selectedSheet.selectionRanges.clear(),this.selectedSheet.selectionRanges.push(this.selection)),n&&this._calcEngine._clearExpressionCache(),this._lastVisibleFrozenRow=-1,this.frozenRows>0)for(t=this.frozenRows-1;t>=0;t--)if(this.rows[t]&&this.rows[t].isVisible){this._lastVisibleFrozenRow=t;break}if(this._lastVisibleFrozenColumn=-1,this.frozenColumns>0)for(i=this.frozenColumns-1;i>=0;i--)if(this.columns[i]&&this.columns[i].isVisible){this._lastVisibleFrozenColumn=i;break}if(this.selectedSheet){if(this.selectedSheet._freezeHiddenRowCnt>0)for(u=0;u<this.selectedSheet._freezeHiddenRowCnt;u++)e=this.rows[u],e instanceof r||(e.visible=!1);if(this.selectedSheet._freezeHiddenColumnCnt>0)for(f=0;f<this.selectedSheet._freezeHiddenColumnCnt;f++)this.columns[f].visible=!1}h.prototype.refresh.call(this,n);this._tabHolder.adjustSize()},c.prototype.setCellData=function(t,i,r,u){u===void 0&&(u=!1);var f=n.isString(r)&&r.length>1&&r[0]==='=';return this._calcEngine._clearExpressionCache(),this.cells.setCellData(t,i,r,u&&!f)},c.prototype.containsFocus=function(){return this.isFunctionListOpen||h.prototype.containsFocus.call(this)},c.prototype.addUnboundSheet=function(n,t,i,r,u){var f=this._addSheet(n,t,i,r,u);return f.selectionRanges.length===0&&f.selectionRanges.push(this.selection),f},c.prototype.addBoundSheet=function(n,t,i,r){var u=this._addSheet(n,0,0,i,r);return t&&(u.itemsSource=t,this.childItemsPath&&(u.grid.childItemsPath=this.childItemsPath)),u.selectionRanges.length===0&&u.selectionRanges.push(this.selection),u},c.prototype.applyCellsStyle=function(n,t,r){r===void 0&&(r=!1);var f,e,s=t||[this.selection],u,o,h;if(this.selectedSheet){if(!n&&this._cloneStyle){this.selectedSheet._styledCells=JSON.parse(JSON.stringify(this._cloneStyle));this._cloneStyle=null;this.refresh(!1);return}if(s){for(t||r?r&&!this._cloneStyle&&(this._cloneStyle=JSON.parse(JSON.stringify(this.selectedSheet._styledCells))):(h=new i._CellStyleAction(this,this._cloneStyle),this._cloneStyle=null),o=0;o<s.length;o++)for(u=s[o],f=u.topRow;f<=u.bottomRow;f++)for(e=u.leftCol;e<=u.rightCol;e++)this._applyStyleForCell(f,e,n);t||r||(h.saveNewState(),this._undoStack._addAction(h))}t||this.refresh(!1)}},c.prototype.freezeAtCursor=function(){var n=this,i,t,f,e,u,o;if(n.selectedSheet){if(n.selection&&n.frozenRows===0&&n.frozenColumns===0){if(n._ptScrl.y<0)for(i=0;i<n.selection.topRow-1;i++)if(u=n.rows[i],!(u instanceof r))if(u._pos+n._ptScrl.y<0)u.visible=!1;else{n.selectedSheet._freezeHiddenRowCnt=i;break}if(n._ptScrl.x<0)for(t=0;t<n.selection.leftCol-1;t++)if(o=n.columns[t],o._pos+n._ptScrl.x<0)n.columns[t].visible=!1;else{n.selectedSheet._freezeHiddenColumnCnt=t;break}f=n.selection.leftCol>0?n.selection.leftCol:0;e=n.selection.topRow>0?n.selection.topRow:0}else{for(i=0;i<n.frozenRows-1;i++)n.rows[i].visible=!0;for(t=0;t<n.frozenColumns-1;t++)n.columns[t].visible=!0;n._filter.apply();f=0;e=0;n.selectedSheet._freezeHiddenRowCnt=0;n.selectedSheet._freezeHiddenColumnCnt=0}n.frozenRows=n.selectedSheet.grid.frozenRows=e;n.frozenColumns=n.selectedSheet.grid.frozenColumns=f;setTimeout(function(){n._setFlexSheetToDirty();n.invalidate();n.scrollIntoView(n.selection.topRow,n.selection.leftCol)},10)}},c.prototype.showColumnFilter=function(){var n=this.selection.col>0?this.selection.col:0;this.columns.length>0&&this._filter.editColumnFilter(this.columns[n])},c.prototype.clear=function(){this.beginUpdate();this.selection=new t.CellRange;this.sheets.clear();this._selectedSheetIndex=-1;this.columns.clear();this.rows.clear();this.columnHeaders.columns.clear();this.rowHeaders.rows.clear();this._undoStack.clear();this._ptScrl=new n.Point;this._clearCalcEngine();this.definedNames.clear();this.addUnboundSheet();this.endUpdate()},c.prototype.getSelectionFormatState=function(){var n,t,r=this.rows.length,u=this.columns.length,i={isBold:!1,isItalic:!1,isUnderline:!1,textAlign:'left',isMergedCell:!1};if(r===0||u===0)return i;if(this.selection){if(this.selection.row>=r||this.selection.row2>=r||this.selection.col>=u||this.selection.col2>=u)return i;for(n=this.selection.topRow;n<=this.selection.bottomRow;n++)for(t=this.selection.leftCol;t<=this.selection.rightCol;t++)this._checkCellFormat(n,t,i)}return i},c.prototype.insertRows=function(f,e){var o=n.isNumber(f)&&f>=0?f:this.selection&&this.selection.topRow>-1?this.selection.topRow:0,s=n.isNumber(e)?e:1,h=new i._RowsChangedAction(this),l=this.rows[o],c;if(this.selectedSheet&&!this.itemsSource){for(this._clearCalcEngine(),this.finishEditing(),o===0&&l&&l.constructor===r&&(o=1),this.onPrepareChangingRow(),this._updateCellsForUpdatingRow(this.rows.length,o,s),h._affectedFormulas=this._updateAffectedFormula(o,s,!0,!0),h._affectedDefinedNameVals=this._updateAffectedNamedRanges(o,s,!0,!0),this.rows.beginUpdate(),c=0;c<s;c++)this.rows.insert(o,new t.Row);this.rows.endUpdate();this.selection&&this.selection.row!==-1&&this.selection.col!==-1||(this.selection=new t.CellRange(0,0));h.saveNewState();this._undoStack._addAction(h);this.onRowChanged(new u(o,s,!0))}},c.prototype.deleteRows=function(f,e){var l=n.isNumber(e)&&e>=0?e:this.selection&&this.selection.topRow>-1?this.selection.bottomRow-this.selection.topRow+1:1,s=n.isNumber(f)&&f>=0?f:this.selection&&this.selection.topRow>-1?this.selection.topRow:-1,o=n.isNumber(f)&&f>=0?f+l-1:this.selection&&this.selection.topRow>-1?this.selection.bottomRow:-1,h=new i._RowsChangedAction(this),v=!1,c,y,a;if(this.selectedSheet&&!this.itemsSource&&(this._clearCalcEngine(),this.finishEditing(),s>-1&&o>-1)){for(this.onPrepareChangingRow(),this._updateCellsForUpdatingRow(this.rows.length,s,l,!0),h._affectedFormulas=this._updateAffectedFormula(o,o-s+1,!1,!0),h._affectedDefinedNameVals=this._updateAffectedNamedRanges(o,o-s+1,!1,!0),this.rows.beginUpdate();o>=s;o--)(c=this.rows[o],c&&c.constructor===r)||(c.dataItem&&this.collectionView?(this.collectionView.beginUpdate(),y=this._getCvIndex(o),y>-1&&this.itemsSource.splice(o-1,1),this.collectionView.endUpdate()):this.rows.removeAt(o),v=!0);if(this.rows.endUpdate(),a=this.rows.length,this.selectedSheet.selectionRanges.clear(),a===0?(this.select(new t.CellRange),this.hostElement.style.cursor==='move'&&(this.hostElement.style.cursor='default')):o===a-1?this.select(new t.CellRange(o,0,o,this.columns.length-1)):this.select(new t.CellRange(this.selection.topRow,this.selection.col,this.selection.topRow,this.selection.col2)),v){h.saveNewState();this._undoStack._addAction(h);this.onRowChanged(new u(s,l,!1))}}},c.prototype.insertColumns=function(r,f){var e=n.isNumber(r)&&r>=0?r:this.selection&&this.selection.leftCol>-1?this.selection.leftCol:0,o=n.isNumber(f)?f:1,s=new i._ColumnsChangedAction(this),h,c;if(this.selectedSheet&&!this.itemsSource){for(this._clearCalcEngine(),this.finishEditing(),this.onPrepareChangingColumn(),this._updateCellsForUpdatingColumn(this.columns.length,e,o),s._affectedFormulas=this._updateAffectedFormula(e,o,!0,!1),s._affectedDefinedNameVals=this._updateAffectedNamedRanges(e,o,!0,!1),this.columns.beginUpdate(),c=0;c<o;c++)h=new t.Column,h.isRequired=!1,this.columns.insert(e,h);this.columns.endUpdate();this.selection&&this.selection.row!==-1&&this.selection.col!==-1||(this.selection=new t.CellRange(0,0));s.saveNewState();this._undoStack._addAction(s);this.onColumnChanged(new u(e,o,!0))}},c.prototype.deleteColumns=function(r,f){var h,c=n.isNumber(f)&&f>=0?f:this.selection&&this.selection.leftCol>-1?this.selection.rightCol-this.selection.leftCol+1:1,o=n.isNumber(r)&&r>=0?r:this.selection&&this.selection.leftCol>-1?this.selection.leftCol:-1,e=n.isNumber(r)&&r>=0?r+c-1:this.selection&&this.selection.leftCol>-1?this.selection.rightCol:-1,s=new i._ColumnsChangedAction(this);if(this.selectedSheet&&!this.itemsSource&&(this._clearCalcEngine(),this.finishEditing(),o>-1&&e>-1)){for(this.onPrepareChangingColumn(),this._updateCellsForUpdatingColumn(this.columns.length,o,c,!0),s._affectedFormulas=this._updateAffectedFormula(e,e-o+1,!1,!1),s._affectedDefinedNameVals=this._updateAffectedNamedRanges(e,e-o+1,!1,!1),this.columns.beginUpdate();e>=o;e--)this.columns.removeAt(e),this._sortManager.deleteSortLevel(e);this.columns.endUpdate();this._sortManager.commitSort(!1);h=this.columns.length;this.selectedSheet.selectionRanges.clear();h===0?(this.select(new t.CellRange),this.hostElement.style.cursor==='move'&&(this.hostElement.style.cursor='default')):e===h-1?this.select(new t.CellRange(0,e,this.rows.length-1,e)):this.select(new t.CellRange(this.selection.row,this.selection.leftCol,this.selection.row2,this.selection.leftCol));s.saveNewState();this._undoStack._addAction(s);this.onColumnChanged(new u(o,c,!1))}},c.prototype.mergeRange=function(n,r){r===void 0&&(r=!1);var f,e,h,u=n||this.selection,s,o=-1;if(this.selectedSheet){if(u){if(u.rowSpan===1&&u.columnSpan===1)return;if(n||r||(s=new i._CellMergeAction(this),this.hostElement.focus()),!this._resetMergedRange(u)){for(f=u.topRow;f<=u.bottomRow;f++)if(o<0&&this.rows[f].visible&&(o=f),!(o<0))for(e=u.leftCol;e<=u.rightCol;e++)h=f*this.columns.length+e,this.selectedSheet._mergedRanges[h]=new t.CellRange(o,u.leftCol,u.bottomRow,u.rightCol);n||r||(s.saveNewState(),this._undoStack._addAction(s))}}n||this.refresh()}},c.prototype.getMergedRange=function(n,i,r,u){u===void 0&&(u=!0);var l=i*this.columns.length+r,f=this.selectedSheet?this.selectedSheet._mergedRanges[l]:null,s,e,c,o;return n===this.cells&&f?!f.isSingleCell&&(this.frozenRows>0||this.frozenColumns>0)&&(f.topRow<this.frozenRows&&f.bottomRow>=this.frozenRows||f.leftCol<this.frozenColumns&&f.rightCol>=this.frozenColumns)?(s=f.topRow,e=f.bottomRow,c=f.leftCol,o=f.rightCol,i>=this.frozenRows&&f.topRow<this.frozenRows&&(s=this.frozenRows),i<this.frozenRows&&f.bottomRow>=this.frozenRows&&(e=this.frozenRows-1),e>=this.rows.length&&(e=this.rows.length-1),r>=this.frozenColumns&&f.leftCol<this.frozenColumns&&(c=this.frozenColumns),r<this.frozenColumns&&f.rightCol>=this.frozenColumns&&(o=this.frozenColumns-1),o>=this.columns.length&&(o=this.columns.length-1),new t.CellRange(s,c,e,o)):f.bottomRow>=this.rows.length?new t.CellRange(f.topRow,f.leftCol,this.rows.length-1,f.rightCol):f.rightCol>=this.columns.length?new t.CellRange(f.topRow,f.leftCol,f.bottomRow,this.columns.length-1):f.clone():r>=0&&this.columns&&this.columns.length>r&&i>=0&&this.rows&&this.rows.length>i?h.prototype.getMergedRange.call(this,n,i,r,u):null},c.prototype.evaluate=function(n,t,i){return this._evaluate(n,t,i)},c.prototype.getCellValue=function(t,i,r,u){r===void 0&&(r=!1);var s=u&&u!==this.selectedSheet?u.grid.columns[i]:this.columns[i],e=this._getCellStyle(t,i,u),o,f;return o=e&&e.format?e.format:'',f=u&&u!==this.selectedSheet?u.grid.getCellData(t,i,!1):this.getCellData(t,i,!1),n.isString(f)&&f[0]==='='&&(f=this._evaluate(f,r?o:'',u,t,i)),r?f=this._formatEvaluatedResult(f,s,o):f==null||n.isPrimitive(f)||(f=f.value),f==null?'':f},c.prototype.showFunctionList=function(t){var i=this,e=i._cumulativeOffset(t),f=i._cumulativeOffset(i._root),r,u;i._functionTarget=n.tryCast(t,HTMLInputElement);i._functionTarget&&i._functionTarget.value&&i._functionTarget.value[0]==='='?(i._functionList._cv.filter=function(n){var u=n.actualvalue.toLowerCase(),t=i._getCurrentFormulaIndex(i._functionTarget.value),r;return(t===-1&&(t=0),r=i._functionTarget.value.substr(t+1).trim().toLowerCase(),r.length>0&&u.indexOf(r)===0||i._functionTarget.value==='=')?!0:!1},i._functionList.selectedIndex=0,r=e.y+t.clientHeight+2+(n.hasClass(t,'wj-grid-editor')?this._ptScrl.y:0),u=e.x+(n.hasClass(t,'wj-grid-editor')?this._ptScrl.x:0),n.setCss(i._functionListHost,{height:i._functionList._cv.items.length>5?'218px':'auto',display:i._functionList._cv.items.length>0?'block':'none',top:'',left:''}),i._functionListHost.scrollTop=0,i._functionListHost.offsetHeight+r>f.y+i._root.offsetHeight?r=r-t.clientHeight-i._functionListHost.offsetHeight-5:r+=5,i._functionListHost.offsetWidth+u>f.x+i._root.offsetWidth&&(u=f.x+i._root.offsetWidth-i._functionListHost.offsetWidth),n.setCss(i._functionListHost,{top:r,left:u})):i.hideFunctionList()},c.prototype.hideFunctionList=function(){this._functionListHost.style.display='none'},c.prototype.selectPreviousFunction=function(){var n=this._functionList.selectedIndex;n>0&&this._functionList.selectedIndex--},c.prototype.selectNextFunction=function(){var n=this._functionList.selectedIndex;n<this._functionList.itemsSource.length&&this._functionList.selectedIndex++},c.prototype.applyFunctionToCell=function(){var n=this,t;n._functionTarget&&(t=n._getCurrentFormulaIndex(n._functionTarget.value),t===-1?t=n._functionTarget.value.indexOf('='):t+=1,n._functionTarget.value=n._functionTarget.value.substring(0,t)+n._functionList.selectedValue+'(',n._functionTarget.value[0]!=='='&&(n._functionTarget.value='='+n._functionTarget.value),n._functionTarget.focus(),n.hideFunctionList())},c.prototype.save=function(n){var t=this._saveToWorkbook();return n&&t.save(n),t},c.prototype.saveAsync=function(n,t,i){var r=this._saveToWorkbook();return n&&r.saveAsync(n,t,i),r},c.prototype.saveToWorkbookOM=function(){var n=this._saveToWorkbook();return n._serialize()},c.prototype.load=function(t){var i,r,u=this;if(t instanceof Blob)r=new FileReader,r.onload=function(){var t=r.result;t=n.xlsx.Workbook._base64EncArr(new Uint8Array(t));i=new n.xlsx.Workbook;i.load(t);u._loadFromWorkbook(i)},r.readAsArrayBuffer(t);else if(t instanceof n.xlsx.Workbook)u._loadFromWorkbook(t);else{if(t instanceof ArrayBuffer)t=n.xlsx.Workbook._base64EncArr(new Uint8Array(t));else if(!n.isString(t))throw'Invalid workbook.';i=new n.xlsx.Workbook;i.load(t);u._loadFromWorkbook(i)}},c.prototype.loadAsync=function(t,i,r){var u,f,e=this;if(t instanceof Blob)f=new FileReader,f.onload=function(){var t=f.result;t=n.xlsx.Workbook._base64EncArr(new Uint8Array(t));u=new n.xlsx.Workbook;u.loadAsync(t,function(n){e._loadFromWorkbook(n);i&&i(n)},r)},f.readAsArrayBuffer(t);else if(t instanceof n.xlsx.Workbook)e._loadFromWorkbook(t),i&&i(t);else{if(t instanceof ArrayBuffer)t=n.xlsx.Workbook._base64EncArr(new Uint8Array(t));else if(!n.isString(t))throw'Invalid workbook.';u=new n.xlsx.Workbook;u.loadAsync(t,function(n){e._loadFromWorkbook(n);i&&i(n)},r)}},c.prototype.loadFromWorkbookOM=function(t){var i;t instanceof n.xlsx.Workbook?i=t:(i=new n.xlsx.Workbook,i._deserialize(t));this._loadFromWorkbook(i)},c.prototype.undo=function(){var n=this;setTimeout(function(){n._undoStack.undo()},100)},c.prototype.redo=function(){var n=this;setTimeout(function(){n._undoStack.redo()},100)},c.prototype.select=function(n,t){t===void 0&&(t=!0);var i,r,u;if(n.rowSpan!==this.rows.length&&n.columnSpan!==this.columns.length)for(r=n.topRow;r<=n.bottomRow;r++)for(u=n.leftCol;u<=n.rightCol;u++)i=this.getMergedRange(this.cells,r,u),i&&!n.equals(i)&&(n.row<=n.row2?(n.row=Math.min(n.topRow,i.topRow),n.row2=Math.max(n.bottomRow,i.bottomRow)):(n.row=Math.max(n.bottomRow,i.bottomRow),n.row2=Math.min(n.topRow,i.topRow)),n.col<=n.col2?(n.col=Math.min(n.leftCol,i.leftCol),n.col2=Math.max(n.rightCol,i.rightCol)):(n.col=Math.max(n.rightCol,i.rightCol),n.col2=Math.min(n.leftCol,i.leftCol)));this.collectionView&&n.topRow===0&&n.bottomRow===this.rows.length-1&&n.leftCol===0&&n.rightCol===this.columns.length-1&&(n.row=1,n.row2=this.rows.length-1);h.prototype.select.call(this,n,t)},c.prototype.addCustomFunction=function(t,i,r,u,f){n._deprecated('addCustomFunction','addFunction');this._calcEngine.addCustomFunction(t,i,u,f);this._addCustomFunctionDescription(t,r)},c.prototype.addFunction=function(n,t,i,r,u){this._calcEngine.addFunction(n,t,r,u);this._addCustomFunctionDescription(n,i)},c.prototype.dispose=function(){var n=window.navigator.userAgent;this._needCopyToSheet=!1;document.removeEventListener('mousemove',this._mouseMoveHdl);document.body.removeEventListener('click',this._clickHdl);(n.match(/iPad/i)||n.match(/iPhone/i))&&(document.body.removeEventListener('touchstart',this._touchStartHdl),document.body.removeEventListener('touchend',this._touchEndHdl));this.hideFunctionList();h.prototype.dispose.call(this)},c.prototype.getClipString=function(i){var r='',u,a,f,h=!0,e,s,c,l,o;if(!i){if(this._isMultipleRowsSelected()){for(r='',u=this.selectedSheet.selectionRanges.slice(0),u.length===0&&(u=[this.selection]),u.sort(this._sortByRow),f=0;f<u.length;f++)r&&(r+='\n'),r+=this.getClipString(u[f]);return r}if(this._isMultipleColumnsSelected())for(r='',u=this.selectedSheet.selectionRanges.slice(0),u.length===0&&(u=[this.selection]),u.sort(this._sortByColumn),a=0,h=!0;a<this.rows.length;a++){for(h||(r+='\n'),h=!1,f=0,o=!0;f<u.length;f++)o||(r+='\t'),o=!1,r+=this.getClipString(u[f]);return r}else{i=this.selection;switch(this.selectionMode){case t.SelectionMode.Row:case t.SelectionMode.RowRange:i.col=0;i.col2=this.columns.length-1;break;case t.SelectionMode.ListBox:for(i.col=0,i.col2=this.columns.length-1,s=0;s<this.rows.length;s++)this.rows[s].isSelected&&this.rows[s].isVisible&&(i.row=i.row2=s,r&&(r+='\n'),r+=this.getClipString(i));return r}}}if(i=n.asType(i,t.CellRange),!i.isValid)return'';for(c=i.topRow;c<=i.bottomRow;c++)if(this.rows[c].isVisible)for(h||(r+='\n'),h=!1,l=i.leftCol,o=!0;l<=i.rightCol;l++)this.columns[l].isVisible&&(o||(r+='\t'),o=!1,e=this.getCellValue(c,l,!0).toString(),e=e.replace(/\t/g,' '),e.indexOf('\n')>-1&&(e='"'+e.replace(/"/g,'""')+'"'),r+=e);return r},c.prototype.setClipString=function(i,r){var ut=this,lt=r==null,ft=!1,s,e,f,d,y,v,et,o,p,w,g,b,ot,a,ct,st,nt,u,ht=!1,c,l,tt,it,rt,k;if(r=r?n.asType(r,t.CellRange):this.selection,i=n.asString(i).replace(/\r\n/g,'\n').replace(/\r/g,'\n'),i&&i[i.length-1]=='\n'&&(i=i.substring(0,i.length-1)),rt=i,v=this._edtHdl._parseClipString(n.asString(i)),lt&&!r.isSingleCell&&v.length&&this._edtHdl._expandClipRows(v,r),ht=this._containsMultiLineText(v),(!this._copiedRanges||this._copiedRanges.length===0||rt!==this._getRangeString(this._copiedRanges,this._copiedSheet)&&!this._containsRandFormula(this._copiedRanges,this._copiedSheet)||!!this._cutData)&&!ht){this._cutData!=null?(this.deferUpdate(function(){h.prototype.setClipString.call(ut,ut._cutData);ut._delCutData()}),this._cutData=null,this._cutValue=rt):(this._cutValue===null||rt!==this._cutValue)&&(this._cutValue=null,h.prototype.setClipString.call(this,i));this._copiedRanges=null;this._copiedSheet=null;return}if(s=new t.CellRange(r.topRow,r.leftCol),this.beginUpdate(),ht||!this._copiedRanges||this._copiedRanges.length>1||this._copiedRanges.length===0)for(e=r.topRow,u=this._copiedRanges&&this._copiedRanges.length>1?this._copiedRanges[0]:new t.CellRange,d=u.topRow,w=0;w<v.length&&e<this.rows.length;w++,e++){if(!this.rows[e].isVisible){w--;continue}for(et=v[w],y=u.leftCol,f=r.leftCol,nt=f-y,k=0;k<et.length&&f<this.columns.length;k++,f++){if(!this.columns[f].isVisible){k--;continue}o=et[k];this.columns[f].isReadOnly||this.rows[e].isReadOnly||(ft=this._postSetClipStringProcess(o,e,f,d,y),s.row2=Math.max(s.row2,e),s.col2=Math.max(s.col2,f));y>=0&&y++}d>=0&&d++}else if(this._copiedRanges&&this._copiedRanges.length===1)for(c=0,u=this._copiedRanges[0],tt=u.rowSpan>r.rowSpan?u.rowSpan:r.rowSpan,it=u.columnSpan>r.columnSpan?u.columnSpan:r.columnSpan,e=r.topRow;e<r.topRow+tt&&e<this.rows.length;e++)if(l=0,this.rows[e].isVisible){if(c>=u.rowSpan)if(tt%u.rowSpan==0&&it%u.columnSpan==0)c=c%u.rowSpan;else break;for(st=e-u.topRow-c,f=r.leftCol;f<r.leftCol+it&&f<this.columns.length;f++)if(this.columns[f].isVisible){if(l>=u.columnSpan)if(tt%u.rowSpan==0&&it%u.columnSpan==0)l=l%u.columnSpan;else break;if(nt=f-u.leftCol-l,!this.columns[f].isReadOnly&&!this.rows[e].isReadOnly){if(o=this._copiedSheet.grid.getCellData(u.topRow+c,u.leftCol+l,!0).toString(),!!o&&typeof o=='string'&&o[0]==='='&&(st!==0||nt!==0)&&(p=o.match(/(?=\b\D)\$?[A-Za-z]+\$?\d+/g),!!p&&p.length>0))n:for(g=0;g<p.length;g++)(b=p[g],ot=o.indexOf(b),ot>0&&o[ot-1]==='\"')||b.toLowerCase()!=='atan2'&&(a=n.xlsx.Workbook.tableAddress(b),a.row+=st,a.col+=nt,ct=n.xlsx.Workbook.xlsxAddress(a.row,a.col,a.absRow,a.absCol),o=o.replace(b,ct));ft=this._postSetClipStringProcess(o,e,f,u.topRow+c,u.leftCol+l);s.row2=Math.max(s.row2,e);s.col2=Math.max(s.col2,f)}l++}c++}this.endUpdate();this.collectionView&&ft&&this.collectionView.refresh();this.select(s)},c.prototype._getCvIndex=function(n){var t;return n>-1&&this.collectionView?(t=this.rows[n],t instanceof r?n:h.prototype._getCvIndex.call(this,n)):-1},c.prototype._init=function(){var o=this,u=this,s=window.navigator.userAgent,h=function(n){document.removeEventListener('mouseup',h);u._mouseUp(n)};u.hostElement.setAttribute('tabindex','-1');u._divContainer=u.hostElement.querySelector('[wj-part="container"]');u._tabHolder=new i._TabHolder(u.hostElement.querySelector('[wj-part="tab-holder"]'),u);u._contextMenu=new i._ContextMenu(u.hostElement.querySelector('[wj-part="context-menu"]'),u);u._gpCells=new f(u,t.CellType.Cell,u.rows,u.columns,u._eCt);u._gpCHdr=new f(u,t.CellType.ColumnHeader,u._hdrRows,u.columns,u._eCHdrCt);u._gpRHdr=new f(u,t.CellType.RowHeader,u.rows,u._hdrCols,u._eRHdrCt);u._gpTL=new f(u,t.CellType.TopLeft,u._hdrRows,u._hdrCols,u._eTLCt);u._sortManager=new i.SortManager(u);u._filter=new i._FlexSheetFilter(u);u._filter.filterApplied.addHandler(function(){u.selectedSheet&&(u.selectedSheet._filterDefinition=u._filter.filterDefinition)});u._calcEngine=new i._CalcEngine(u);u._calcEngine.unknownFunction.addHandler(function(n,t){u.onUnknownFunction(t)},u);u._initFuncsList();u._undoStack=new i.UndoStack(u);u.loadedRows.addHandler(function(){var n,f,i;if(u.itemsSource&&!(u.rows[0]instanceof r)){for(n=new r,i=0;i<u.columns.length;i++)f=u.columns[i],n._ubv||(n._ubv={}),n._ubv[f._hash]=f.header;u.rows[0]instanceof t._NewRowTemplate?u.rows.insert(1,n):u.rows.insert(0,n)}u._filter&&u._filter.apply()});u.itemsSourceChanged.addHandler(function(){for(var n=0;n<u.columns.length;n++)u.columns[n].isRequired=!1});u.copied.addHandler(function(n,t){var i;u._copiedSheet=u.selectedSheet;u._needCopyToSheet=!0;u._isMultipleRowsSelected()?(i=u.selectedSheet.selectionRanges.slice(0),i.sort(u._sortByRow),u._copiedRanges=i):u._isMultipleColumnsSelected()?(i=u.selectedSheet.selectionRanges.slice(0),i.sort(u._sortByColumn),u._copiedRanges=i):u._copiedRanges=[t.range]});u.rows.collectionChanged.addHandler(function(n,i){u._clearForEmptySheet('rows');u.itemsSource||!u.selectedSheet||!u._needCopyToSheet||u._isCopying||u._isUndoing||i.item instanceof t._NewRowTemplate||u._copyRowsToSelectedSheet()},u);u.columns.collectionChanged.addHandler(function(){u._clearForEmptySheet('columns');u.selectedSheet&&u._needCopyToSheet&&!u._isCopying&&!u._isUndoing&&u._copyColumnsToSelectedSheet()},u);u.definedNames.collectionChanged.addHandler(function(t,i){if(i.action===n.collections.NotifyCollectionChangedAction.Add||i.action===n.collections.NotifyCollectionChangedAction.Change){var r=i.action===n.collections.NotifyCollectionChangedAction.Add?'inserted':'updated';if(!(i.item instanceof e)){u.definedNames.remove(i.item);throw'Invalid defined name item object was '+r+'.  The DefinedName instance should be '+r+' in the definedNames array.';}if(!(i.item&&i.item.name&&i.item.value!=null)){u.definedNames.remove(i.item);throw'Invalid defined name was '+r+'.';}if(i.item.sheetName!=null&&!u._validateSheetName(i.item.sheetName)){u.definedNames.remove(i.item);throw'The sheet name ('+i.item.sheetName+') does not exist in FlexSheet.';}if(u._checkExistDefinedName(i.item.name,i.item.sheetName,i.index)){u.definedNames.remove(i.item);throw'The '+i.item.name+' already existed in definedNames.';}}});u.addEventListener(u.hostElement,'mousedown',function(n){document.addEventListener('mouseup',h);u._isDescendant(u._divContainer,n.target)&&u._mouseDown(n)},!0);u.addEventListener(u.hostElement,'drop',function(){u._columnHeaderClicked=!1});u.addEventListener(u.hostElement,'contextmenu',function(i){var r,e,s,h,c,v,l,a,f;i.defaultPrevented||u.activeEditor||(u._isContextMenuKeyDown&&u.selection.row>-1&&u.selection.col>-1&&u.rows.length>0&&u.columns.length>0?(s=u.columns[u.selection.col],e=u.rows[u.selection.row],l=u._cumulativeOffset(u.hostElement),a=u._cumulativeScrollOffset(u.hostElement),h=s.pos+u._eCt.offsetLeft+l.x+s.renderSize/2+u._ptScrl.x,c=e.pos+u._eCt.offsetTop+l.y+e.renderSize/2+u._ptScrl.y,v=new n.Point(h-a.x,c-a.y),r=u.hitTest(h,c),u._isContextMenuKeyDown=!1):r=u.hitTest(i),i.preventDefault(),r&&r.cellType!==t.CellType.None&&(o.itemsSource||u._contextMenu.show(i,v),f=new t.CellRange(r.row,r.col),r.cellType!==t.CellType.Cell||f.intersects(u.selection)||(u.selectedSheet&&u.selectedSheet.selectionRanges.clear(),u.selection=f,u.selectedSheet.selectionRanges.push(f))))});u.prepareCellForEdit.addHandler(u._prepareCellForEditHandler,u);u.cellEditEnded.addHandler(function(n,t){t.data&&(t.data.keyCode===46||t.data.keyCode===8)||setTimeout(function(){u.hideFunctionList();o._filter._divEdt==null&&u.hostElement.focus()},200)});u.cellEditEnding.addHandler(function(n,t){t.data&&(t.data.keyCode===46||t.data.keyCode===8)||u._clearCalcEngine()});u.pasting.addHandler(function(){u._needCopyToSheet=!1;u._isPasting=!0});u.pasted.addHandler(function(){u._needCopyToSheet=!0;u._isPasting=!1;u._clearCalcEngine()});u.addEventListener(u.hostElement,'keydown',function(i){var r,e,f;if(i.ctrlKey&&(i.keyCode===89&&(u.finishEditing(),u.redo(),i.preventDefault()),i.keyCode===90&&(u.finishEditing(),u.undo(),i.preventDefault()),!u.selectedSheet||i.keyCode!==65||(u.selectedSheet.selectionRanges.clear(),u.selectedSheet.selectionRanges.push(u.selection)),(i.keyCode===67||i.keyCode==45)&&(!u.activeEditor||(u._copiedRanges=null,u._copiedSheet=null),u._cutValue=null),i.keyCode===88&&!u.activeEditor)){if(u.finishEditing(),r=new t.CellRangeEventArgs(u.cells,u.selection),u.onCopying(r)){u._cutData=null;u._cutValue=null;e=u.getClipString();u._cutData=u._getRangeString(u.selection,u.selectedSheet,!1);n.Clipboard.copy(e);u.onCopied(r)}i.stopPropagation()}if(i.keyCode===n.Key.Escape&&u._contextMenu.hide(),(i.keyCode===93||i.shiftKey&&i.keyCode===121)&&(u._isContextMenuKeyDown=!0),!!u.selectedSheet&&!u._edtHdl.activeEditor)switch(i.keyCode){case n.Key.Left:case n.Key.Right:case n.Key.Up:case n.Key.Down:case n.Key.PageUp:case n.Key.PageDown:case n.Key.Home:case n.Key.End:case n.Key.Tab:case n.Key.Enter:f=u.selectedSheet.selectionRanges.length;f>0&&(u.selectedSheet.selectionRanges.splice(f-1,1,u.selection),u.scrollIntoView(u.selection.row,u.selection.col))}});u.addEventListener(document.body,'keydown',function(t){(u._isDescendant(u.hostElement,t.target)||u.hostElement===t.target)&&!u._edtHdl.activeEditor&&(t.keyCode===n.Key.Delete||t.keyCode===n.Key.Back)&&(u._delSeletionContent(t),t.preventDefault());u._contextMenu.visible&&(t.keyCode===n.Key.Down&&u._contextMenu.moveToNext(),t.keyCode===n.Key.Up&&u._contextMenu.moveToPrev(),t.keyCode===n.Key.Home&&u._contextMenu.moveToFirst(),t.keyCode===n.Key.End&&u._contextMenu.moveToLast(),t.keyCode===n.Key.Enter&&u._contextMenu.handleContextMenu(),t.preventDefault())},!0);document.body.addEventListener('click',u._clickHdl);document.addEventListener('mousemove',u._mouseMoveHdl);(s.match(/iPad/i)||s.match(/iPhone/i))&&(document.body.addEventListener('touchstart',u._touchStartHdl),document.body.addEventListener('touchend',u._touchEndHdl));u.addEventListener(u.hostElement,'drop',function(){u._htDown=null})},c.prototype._initFuncsList=function(){var t=this;t._functionListHost=document.createElement('div');n.addClass(t._functionListHost,'wj-flexsheet-formula-list');document.querySelector('body').appendChild(t._functionListHost);t._functionListHost.style.display='none';t._functionListHost.style.position='absolute';t._functionList=new n.input.ListBox(t._functionListHost);t._functionList.isContentHtml=!0;t._functionList.itemsSource=t._getFunctions();t._functionList.displayMemberPath='displayValue';t._functionList.selectedValuePath='actualvalue';t.addEventListener(t._functionListHost,'click',t.applyFunctionToCell.bind(t));t.addEventListener(t._functionListHost,'keydown',function(i){i.keyCode===n.Key.Escape&&(t.hideFunctionList(),t.hostElement.focus(),i.preventDefault());i.keyCode===n.Key.Enter&&(t.applyFunctionToCell(),t.hostElement.focus(),i.preventDefault(),i.stopPropagation())})},c.prototype._getFunctions=function(){for(var i=[],t=0,n;t<s.length;t++)n=s[t],i.push({displayValue:'<div class="wj-flexsheet-formula-name">'+n.name+'</div><div class="wj-flexsheet-formula-description">'+n.description+'</div>',actualvalue:n.name});return i},c.prototype._addCustomFunctionDescription=function(n,t){for(var f={displayValue:'<div class="wj-flexsheet-formula-name">'+n+'</div>'+(t?'<div class="wj-flexsheet-formula-description">'+t+'</div>':''),actualvalue:n},i=this._functionList.itemsSource,u=-1,r=0,e;r<i.length;r++)if(e=i[r],e.actualvalue===n){u=r;break}u>-1?i.splice(u,1,f):i.push(f)},c.prototype._getCurrentFormulaIndex=function(n){var t=-1;return['+','-','*','/','^','(','&'].forEach(function(i){var r=n.lastIndexOf(i);r>t&&(t=r)}),t},c.prototype._prepareCellForEditHandler=function(){var t=this,i=t._edtHdl._edt;i&&(t.addEventListener(i,'keydown',function(i){if(t.isFunctionListOpen)switch(i.keyCode){case n.Key.Up:t.selectPreviousFunction();i.preventDefault();i.stopPropagation();break;case n.Key.Down:t.selectNextFunction();i.preventDefault();i.stopPropagation();break;case n.Key.Tab:case n.Key.Enter:t.applyFunctionToCell();i.preventDefault();i.stopPropagation();break;case n.Key.Escape:t.hideFunctionList();i.preventDefault();i.stopPropagation()}}),t.addEventListener(i,'keyup',function(r){(r.keyCode>40||r.keyCode<32)&&r.keyCode!==n.Key.Tab&&r.keyCode!==n.Key.Escape&&setTimeout(function(){t.showFunctionList(i)},0)}))},c.prototype._addSheet=function(n,t,r,u,f){var e=this,o=new i.Sheet(e,f,n,t,r);return e.sheets.isValidSheetName(o)||o._setValidName(e.sheets.getValidSheetName(o)),o.nameChanged.addHandler(function(n,t){e._updateDefinedNameWithSheetRefUpdating(t.oldValue,t.newValue)}),typeof u=='number'?(u<0&&(u=0),u>=e.sheets.length&&(u=e.sheets.length)):u=e.sheets.length,e.sheets.insert(u,o),u<=e._selectedSheetIndex&&(e._selectedSheetIndex+=1),e.selectedSheetIndex=u,o},c.prototype._showSheet=function(n){!this.sheets||!this.sheets.length||n>=this.sheets.length||n<0||n===this.selectedSheetIndex||this.sheets[n]&&!this.sheets[n].visible||(this.finishEditing(),this._clearCalcEngine(),this.selectedSheetIndex>-1&&this.selectedSheetIndex<this.sheets.length&&(this._copyTo(this.sheets[this.selectedSheetIndex]),this._resetFilterDefinition()),this.sheets[n]&&(this._selectedSheetIndex=n,this._copyFrom(this.sheets[n])),this._filter.closeEditor())},c.prototype._selectedSheetChange=function(n,t){this._showSheet(t.newValue);this.invalidate(!0);this.onSelectedSheetChanged(t)},c.prototype._sourceChange=function(t,i){var r,u;if(i.action===n.collections.NotifyCollectionChangedAction.Add||i.action===n.collections.NotifyCollectionChangedAction.Change)r=i.item,r._attachOwner(this),i.action===n.collections.NotifyCollectionChangedAction.Add?(this._addingSheet=!0,i.index<=this.selectedSheetIndex&&(this._selectedSheetIndex+=1)):i.index===this.selectedSheetIndex&&this._copyFrom(i.item,!0),this.selectedSheetIndex=i.index;else if(i.action===n.collections.NotifyCollectionChangedAction.Reset){for(u=0;u<this.sheets.length;u++)r=this.sheets[u],r._attachOwner(this);this.sheets.length>0?(this.selectedSheetIndex===0&&this._copyFrom(this.selectedSheet,!0),this.selectedSheetIndex=0):(this.rows.clear(),this.columns.clear(),this._selectedSheetIndex=-1)}else this.sheets.length>0?this.selectedSheetIndex>=this.sheets.length?this.selectedSheetIndex=0:this.selectedSheetIndex>i.index&&(this._selectedSheetIndex-=1):(this.rows.clear(),this.columns.clear(),this._selectedSheetIndex=-1);this.invalidate(!0)},c.prototype._sheetVisibleChange=function(n,t){t.item.visible||t.index===this.selectedSheetIndex&&(this.selectedSheetIndex=this.selectedSheetIndex===this.sheets.length-1?t.index-1:t.index+1)},c.prototype._applyStyleForCell=function(n,t,i){var f=this,s=f.rows[n],u,o,e;s==null||s instanceof r||!s.isVisible||(e=n*f.columns.length+t,o=f.selectedSheet._mergedRanges[e],o&&(e=o.topRow*f.columns.length+o.leftCol),u=f.selectedSheet._styledCells[e],u?(u.className=i.className==='normal'?'':i.className||u.className,u.textAlign=i.textAlign||u.textAlign,u.verticalAlign=i.verticalAlign||u.verticalAlign,u.fontFamily=i.fontFamily||u.fontFamily,u.fontSize=i.fontSize||u.fontSize,u.backgroundColor=i.backgroundColor||u.backgroundColor,u.color=i.color||u.color,u.fontStyle=i.fontStyle==='none'?'':i.fontStyle||u.fontStyle,u.fontWeight=i.fontWeight==='none'?'':i.fontWeight||u.fontWeight,u.textDecoration=i.textDecoration==='none'?'':i.textDecoration||u.textDecoration,u.format=i.format||u.format,u.whiteSpace=i.whiteSpace||u.whiteSpace):f.selectedSheet._styledCells[e]={className:i.className,textAlign:i.textAlign,verticalAlign:i.verticalAlign,fontStyle:i.fontStyle,fontWeight:i.fontWeight,fontFamily:i.fontFamily,fontSize:i.fontSize,textDecoration:i.textDecoration,backgroundColor:i.backgroundColor,color:i.color,format:i.format,whiteSpace:i.whiteSpace})},c.prototype._checkCellFormat=function(n,t,i){var f=n*this.columns.length+t,u,r;this.selectedSheet&&(u=this.selectedSheet._mergedRanges[f],u&&(i.isMergedCell=!0,f=u.topRow*this.columns.length+u.leftCol),r=this.selectedSheet._styledCells[f],r&&(i.isBold=i.isBold||r.fontWeight==='bold',i.isItalic=i.isItalic||r.fontStyle==='italic',i.isUnderline=i.isUnderline||r.textDecoration==='underline'),n===this.selection.row&&t===this.selection.col&&(r&&r.textAlign?i.textAlign=r.textAlign:t>-1&&(i.textAlign=this.columns[t].getAlignment()||i.textAlign)))},c.prototype._resetMergedRange=function(n){for(var r,e,u,f,o,t,s=!1,i=n.topRow;i<=n.bottomRow;i++)for(r=n.leftCol;r<=n.rightCol;r++)if(e=i*this.columns.length+r,t=this.selectedSheet._mergedRanges[e],t)for(s=!0,u=t.topRow;u<=t.bottomRow;u++)for(f=t.leftCol;f<=t.rightCol;f++)o=u*this.columns.length+f,delete this.selectedSheet._mergedRanges[o];return s},c.prototype._updateCellsForUpdatingRow=function(n,t,i,r){var l=this,s,f,e,o,u,h={},c=n*this.columns.length;if(r)for(s=t*this.columns.length,f=s;f<c;f++)e=f-i*this.columns.length,o=this.selectedSheet._styledCells[f],o&&(f>=(t+i)*this.columns.length&&(this.selectedSheet._styledCells[e]=o),delete this.selectedSheet._styledCells[f]),u=this.selectedSheet._mergedRanges[f],u&&(t<=u.topRow&&t+i>u.bottomRow?delete this.selectedSheet._mergedRanges[f]:u.bottomRow<t||u.topRow>=t+i?(u.topRow>t&&(u.row-=i),u.row2-=i,this.selectedSheet._mergedRanges[e]=u,delete this.selectedSheet._mergedRanges[f]):this._updateCellMergeRangeForRow(u,t,i,h,!0));else for(s=t*this.columns.length-1,f=c-1;f>s;f--)e=f+this.columns.length*i,o=this.selectedSheet._styledCells[f],o&&(this.selectedSheet._styledCells[e]=o,delete this.selectedSheet._styledCells[f]),u=this.selectedSheet._mergedRanges[f],u&&(u.topRow<t&&u.bottomRow>=t?this._updateCellMergeRangeForRow(u,t,i,h):(u.row+=i,u.row2+=i,this.selectedSheet._mergedRanges[e]=u,delete this.selectedSheet._mergedRanges[f]));Object.keys(h).forEach(function(n){l.selectedSheet._mergedRanges[n]=h[n]})},c.prototype._updateCellMergeRangeForRow=function(n,t,i,r,u){var e,s,o,c,l,h,f;if(u)for(e=n.topRow;e<=n.bottomRow;e++)for(s=n.leftCol;s<=n.rightCol;s++)o=e*this.columns.length+s,c=o-i*this.columns.length,h=this.selectedSheet._mergedRanges[o],h&&(f=h.clone(),f.row>t&&(f.row-=f.row-t),f.row2-=f.row2<t+i-1?f.row2-t+1:i,e<t?r[o]=f:(e>=t+i&&(r[c]=f),delete this.selectedSheet._mergedRanges[o]));else for(e=n.bottomRow;e>=n.topRow;e--)for(s=n.rightCol;s>=n.leftCol;s--)if(o=e*this.columns.length+s,h=this.selectedSheet._mergedRanges[o],h){for(f=h.clone(),f.row2+=i,e<t&&(r[o]=f.clone()),l=1;l<=i;l++)c=o+this.columns.length*l,r[c]=f;delete this.selectedSheet._mergedRanges[o]}},c.prototype._updateCellsForUpdatingColumn=function(n,t,i,r){var a=this,u,e,o,h,s,f,c={},l=this.rows.length*n;if(r)for(u=t;u<l;u++)h=Math.floor(u/n),s=u%n,e=u-i*(h+(s>=t?1:0)),o=this.selectedSheet._styledCells[u],o&&((s<t||s>=t+i)&&(this.selectedSheet._styledCells[e]=o),delete this.selectedSheet._styledCells[u]),f=this.selectedSheet._mergedRanges[u],f&&(t<=f.leftCol&&t+i>f.rightCol?delete this.selectedSheet._mergedRanges[u]:f.rightCol<t||f.leftCol>=t+i?(f.leftCol>=t&&(f.col-=i,f.col2-=i),this.selectedSheet._mergedRanges[e]=f,delete this.selectedSheet._mergedRanges[u]):this._updateCellMergeRangeForColumn(f,t,i,n,c,!0));else for(u=l-1;u>=t;u--)h=Math.floor(u/n),s=u%n,e=u+h*i+(s>=t?1:0),o=this.selectedSheet._styledCells[u],o&&(this.selectedSheet._styledCells[e]=o,delete this.selectedSheet._styledCells[u]),f=this.selectedSheet._mergedRanges[u],f&&(f.leftCol<t&&f.rightCol>=t?this._updateCellMergeRangeForColumn(f,t,i,n,c):(f.leftCol>=t&&(f.col+=i,f.col2+=i),this.selectedSheet._mergedRanges[e]=f,delete this.selectedSheet._mergedRanges[u]));Object.keys(c).forEach(function(n){a.selectedSheet._mergedRanges[n]=c[n]})},c.prototype._updateCellMergeRangeForColumn=function(n,t,i,r,u,f){var s,e,h,c,a,l,o;if(f)for(s=n.topRow;s<=n.bottomRow;s++)for(e=n.leftCol;e<=n.rightCol;e++)h=s*r+e,c=h-i*(s+(e>=t?1:0)),l=this.selectedSheet._mergedRanges[h],l&&(o=l.clone(),o.col>t&&(o.col-=o.col-t),o.col2-=o.col2<t+i-1?o.col2-t+1:i,(e<t||e>=t+i)&&(u[c]=o),delete this.selectedSheet._mergedRanges[h]);else for(s=n.bottomRow;s>=n.topRow;s--)for(e=n.rightCol;e>=n.leftCol;e--)if(h=s*r+e,c=h+s*i+(e>=t?1:0),l=this.selectedSheet._mergedRanges[h],l){if(o=l.clone(),o.col2+=i,e===t&&(u[c-1]=o.clone()),e>=t)for(a=0;a<i;a++)u[c+a]=o;else u[c]=o;delete this.selectedSheet._mergedRanges[h]}},c.prototype._cloneMergedCells=function(){var i,n,t;if(!this.selectedSheet)return null;if(n=this.selectedSheet._mergedRanges,null==n||"object"!=typeof n)return n;if(n instanceof Object){i={};for(t in n)n.hasOwnProperty(t)&&n[t]&&n[t].clone&&(i[t]=n[t].clone());return i}throw new Error("Unable to copy obj! Its type isn't supported.");},c.prototype._evaluate=function(n,t,i,r,u){return n&&n.length>1?(n=n[0]==='='?n:'='+n,this._calcEngine.evaluate(n,t,i,r,u)):n},c.prototype._copyTo=function(i){var r=this,o=i.grid.autoGenerateColumns,u,f,e;if(i._storeRowSettings(),i.grid.selection=new t.CellRange,i.grid.rows.clear(),i.grid.columns.clear(),i.grid.columnHeaders.columns.clear(),i.grid.rowHeaders.rows.clear(),r.itemsSource){if(i.grid.autoGenerateColumns=!1,i.itemsSource=r.itemsSource,i.grid.collectionView.beginUpdate(),!(i.grid.itemsSource instanceof n.collections.CollectionView))for(i.grid.collectionView.sortDescriptions.clear(),e=0;e<r.collectionView.sortDescriptions.length;e++)i.grid.collectionView.sortDescriptions.push(r.collectionView.sortDescriptions[e])}else for(i.itemsSource=null,f=0;f<r.rows.length;f++)i.grid.rows.push(r.rows[f]);for(i._filterDefinition=r._filter.filterDefinition,u=0;u<r.columns.length;u++)i.grid.columns.push(r.columns[u]);i.grid.collectionView&&(r._resetMappedColumns(i.grid),i.grid.collectionView.endUpdate());i.grid.autoGenerateColumns=o;i.grid.frozenRows=r.frozenRows;i.grid.frozenColumns=r.frozenColumns;i.grid.selection=r.selection;i._scrollPosition=r.scrollPosition;setTimeout(function(){r._setFlexSheetToDirty();r.refresh(!0)},10)},c.prototype._copyFrom=function(i,r){r===void 0&&(r=!0);var u=this,l=u.autoGenerateColumns,s,f,h,e,c,o;if(u._isCopying=!0,u._dragable=!1,u.itemsSource=null,u.rows.clear(),u.columns.clear(),u.columnHeaders.columns.clear(),u.rowHeaders.rows.clear(),u.selection=new t.CellRange,i.selectionRanges.length>1&&u.selectionMode===t.SelectionMode.CellRange&&(u._enableMulSel=!0),i.itemsSource){if(u.autoGenerateColumns=!1,u.itemsSource=i.itemsSource,u.collectionView.beginUpdate(),!(u.itemsSource instanceof n.collections.CollectionView))for(u.collectionView.sortDescriptions.clear(),h=0;h<i.grid.collectionView.sortDescriptions.length;h++)u.collectionView.sortDescriptions.push(i.grid.collectionView.sortDescriptions[h])}else for(f=0;f<i.grid.rows.length;f++)u.rows.push(i.grid.rows[f]);for(s=0;s<i.grid.columns.length;s++)c=i.grid.columns[s],c.isRequired=!1,u.columns.push(c);for(u.collectionView&&(navigator.userAgent.toLowerCase().indexOf('chrome')>-1&&(u.collectionView.useStableSort=!0),u._resetMappedColumns(u),u.collectionView.endUpdate(),u.collectionView.collectionChanged.addHandler(function(t,i){i.action===n.collections.NotifyCollectionChangedAction.Reset&&u.invalidate()},u)),u.rows.length&&u.columns.length&&(u.selection=i.grid.selection),i._filterDefinition&&(u._filter.filterDefinition=i._filterDefinition),f=0;f<u.rows.length;f++)e=i._rowSettings[f],e&&(o=u.rows[f],o.height=e.height,o.allowMerging=e.allowMerging,o.visible=e.visible,o instanceof t.GroupRow&&(o.isCollapsed=e.isCollapsed));u.autoGenerateColumns=l;u.frozenRows=i.grid.frozenRows;u.frozenColumns=i.grid.frozenColumns;u._isCopying=!1;u._addingSheet?(u._toRefresh&&(clearTimeout(u._toRefresh),u._toRefresh=null),u._toRefresh=setTimeout(function(){u._setFlexSheetToDirty();u.invalidate()},10),u._addingSheet=!1):r&&u.refresh();u.scrollPosition=i._scrollPosition},c.prototype._resetMappedColumns=function(n){var t,i,r=0;if(n._mappedColumns=null,n.collectionView)for(i=n.collectionView.sortDescriptions;r<i.length;r++)t=n.columns.getColumn(i[r].property),t&&t.dataMap&&(n._mappedColumns||(n._mappedColumns={}),n._mappedColumns[t.binding]=t.dataMap)},c.prototype._resetFilterDefinition=function(){this._resettingFilter=!0;this._filter.filterDefinition=JSON.stringify({defaultFilterType:n.grid.filter.FilterType.Both,filters:[]});this._resettingFilter=!1},c.prototype._loadFromWorkbook=function(t){var o,r,u=0,i=this,f;if(t.sheets!=null&&t.sheets.length!==0){for(i.beginUpdate(),i.clear(),i._reservedContent=t.reservedContent,o=t.sheets.length;u<o;u++)u>0&&i.addUnboundSheet(),i.selectedSheet.grid.wj_sheetInfo={},n.grid.xlsx.FlexGridXlsxConverter.load(i.selectedSheet.grid,t,{sheetIndex:u,includeColumnHeaders:!1}),i.selectedSheet.name=i.selectedSheet.grid.wj_sheetInfo.name,i.selectedSheet.visible=i.selectedSheet.grid.wj_sheetInfo.visible,i.selectedSheet._styledCells=i.selectedSheet.grid.wj_sheetInfo.styledCells,i.selectedSheet._mergedRanges=i.selectedSheet.grid.wj_sheetInfo.mergedRanges,i._copyFrom(i.selectedSheet,!1);if(i.selectedSheetIndex=t.activeWorksheet!=null&&t.activeWorksheet>-1&&t.activeWorksheet<i.sheets.length?t.activeWorksheet:0,t.definedNames&&t.definedNames.length>0)for(f=0;f<t.definedNames.length;f++)r=t.definedNames[f],i.definedNames.push(new e(i,r.name,r.value,r.sheetName));i.endUpdate();i.onLoaded()}},c.prototype._saveToWorkbook=function(){var i,o,u,t,r,e,f;if(this.sheets.length===0)throw'The flexsheet is empty.';for(t=this.sheets[0],this.selectedSheetIndex===0&&t._storeRowSettings(),t._setRowSettings(),i=n.grid.xlsx.FlexGridXlsxConverter.save(t.grid,{sheetName:t.name,sheetVisible:t.visible,includeColumnHeaders:!1}),i.reservedContent=this._reservedContent,r=1;r<this.sheets.length;r++)t=this.sheets[r],this.selectedSheetIndex===r&&t._storeRowSettings(),t._setRowSettings(),o=n.grid.xlsx.FlexGridXlsxConverter.save(t.grid,{sheetName:t.name,sheetVisible:t.visible,includeColumnHeaders:!1}),i._addWorkSheet(o.sheets[0],r);for(i.activeWorksheet=this.selectedSheetIndex,e=0;e<this.definedNames.length;e++)f=this.definedNames[e],u=new n.xlsx.DefinedName,u.name=f.name,u.value=f.value,u.sheetName=f.sheetName,i.definedNames.push(u);return i},c.prototype._mouseDown=function(i){var e=window.navigator.userAgent,r=this.hitTest(i),s=this.columns,u,f;if(this.selectedSheet&&(this.selectedSheet._scrollPosition=this.scrollPosition),this._wholeColumnsSelected=!1,this._dragable){this._isDragging=!0;this._draggingMarker=document.createElement('div');n.setCss(this._draggingMarker,{position:'absolute',display:'none',borderStyle:'dotted',cursor:'move'});document.body.appendChild(this._draggingMarker);this._draggingTooltip=new n.Tooltip;this._draggingCells=this.selection;this.selectedSheet&&this.selectedSheet.selectionRanges.clear();this.onDraggingRowColumn(new o(this._draggingRow,i.shiftKey));i.preventDefault();return}if((r.cellType!==t.CellType.None&&(this._isClicking=!0),this.selectionMode===t.SelectionMode.CellRange?i.ctrlKey?this._enableMulSel||(this._enableMulSel=!0):r.cellType!==t.CellType.None&&(this.selectedSheet&&this.selectedSheet.selectionRanges.clear(),this._enableMulSel&&this.refresh(!1),this._enableMulSel=!1):(this._enableMulSel=!1,this.selectedSheet&&this.selectedSheet.selectionRanges.clear()),this._htDown=r,this.rows.length!==0&&this.columns.length!==0)&&(e.match(/iPad/i)||e.match(/iPhone/i)||this._contextMenu.hide(),this.selectionMode===t.SelectionMode.CellRange)){if(r.cellType===t.CellType.RowHeader&&i.which===3){f=new t.CellRange(r.row,0,r.row,this.columns.length-1);this.selection.contains(f)||(this.selection=f);return}if((r.cellType===t.CellType.ColumnHeader||r.cellType===t.CellType.None)&&(!(r.col>-1)||!this.columns[r.col].isSelected)&&n.hasClass(i.target,'wj-cell')&&!r.edgeRight)if(this._columnHeaderClicked=!0,this._wholeColumnsSelected=!0,i.shiftKey)this._multiSelectColumns(r);else{if(u=new t.CellRange(this.itemsSource?1:0,r.col,this.rows.length-1,r.col),i.which===3&&this.selection.contains(u))return;this.select(u)}}},c.prototype._mouseMove=function(n){var i=this.hitTest(n),r=this.selection,f=this.rows.length,e=this.columns.length,u=this.hostElement.style.cursor,o;if(this.rows.length===0||this.columns.length===0){this._dragable=!1;i.cellType===t.CellType.Cell&&(this.hostElement.style.cursor='default');return}if(this._isDragging){this.hostElement.style.cursor='move';this._showDraggingMarker(n);return}(o=this.itemsSource?r.topRow===0||r.topRow===1:r.topRow===0,r&&i.cellType!==t.CellType.None&&!this.itemsSource&&(this._draggingColumn=o&&r.bottomRow===f-1,this._draggingRow=r.leftCol===0&&r.rightCol===e-1,i.cellType===t.CellType.Cell?(this._draggingColumn&&((i.col===r.leftCol-1||i.col===r.rightCol)&&i.edgeRight||i.row===f-1&&i.edgeBottom)&&(u='move'),this._draggingRow&&!this._containsGroupRows(r)&&((i.row===r.topRow-1||i.row===r.bottomRow)&&i.edgeBottom||i.col===e-1&&i.edgeRight)&&(u='move')):i.cellType===t.CellType.ColumnHeader?i.edgeBottom&&(this._draggingColumn&&i.col>=r.leftCol&&i.col<=r.rightCol?u='move':this._draggingRow&&r.topRow===0&&(u='move')):i.cellType===t.CellType.RowHeader&&i.edgeRight&&(this._draggingColumn&&r.leftCol===0?u='move':this._draggingRow&&i.row>=r.topRow&&i.row<=r.bottomRow&&!this._containsGroupRows(r)&&(u='move')),this._dragable=u==='move'?!0:!1,this.hostElement.style.cursor=u),this._htDown&&this._htDown.panel)&&(i=new t.HitTestInfo(this._htDown.panel,n),this._multiSelectColumns(i),i.cellType===t.CellType.Cell&&this.scrollIntoView(i.row,i.col))},c.prototype._mouseUp=function(n){this._isDragging&&(this._draggingCells.equals(this._dropRange)||(this._handleDropping(n),this.onDroppingRowColumn()),this._draggingCells=null,this._dropRange=null,document.body.removeChild(this._draggingMarker),this._draggingMarker=null,this._draggingTooltip.hide(),this._draggingTooltip=null,this._isDragging=!1,this._draggingColumn=!1,this._draggingRow=!1);this._htDown&&this._htDown.cellType!==t.CellType.None&&this.selection.isValid&&this.selectedSheet&&(this._htDown.cellType===t.CellType.TopLeft?this.selectedSheet.selectionRanges.push(new t.CellRange(this.selectedSheet.itemsSource?1:0,0,this.rows.length-1,this.columns.length-1)):this.selectedSheet.selectionRanges.push(this.selection),this._enableMulSel=!1);this._isClicking=!1;this._columnHeaderClicked=!1;this._htDown=null},c.prototype._click=function(){var n=this,t=window.navigator.userAgent;t.match(/iPad/i)||t.match(/iPhone/i)||n._contextMenu.hide();setTimeout(function(){n.hideFunctionList()},200)},c.prototype._touchStart=function(i){var r=this;n.hasClass(i.target,'wj-context-menu-item')||r._contextMenu.hide();r._longClickTimer=setTimeout(function(){var u;u=r.hitTest(i);u&&u.cellType!==t.CellType.None&&!r.itemsSource&&r._contextMenu.show(undefined,new n.Point(i.pageX+10,i.pageY+10))},500)},c.prototype._touchEnd=function(){clearTimeout(this._longClickTimer)},c.prototype._showDraggingMarker=function(i){var a=new t.HitTestInfo(this.cells,i),v=this.selection,w=this.columns.length,b=this.rows.length,y=this._cumulativeScrollOffset(this.hostElement),k=this._root.getBoundingClientRect(),d=k.left+y.x,g=k.top+y.y,f,u,r,h,o,l,s,p,e;if(this.scrollIntoView(a.row,a.col),this._draggingColumn){for(u=v.rightCol-v.leftCol+1,r=a.col,o=0,(r<0||r+u>w)&&(r=w-u),f=this.cells.getCellBoundingRect(0,r),l=this._root.offsetHeight-this._eCHdr.offsetHeight,h=this.cells.height,h=h>l?l:h,s=0;s<u;s++)o+=this.columns[r+s].renderSize;p=c.convertNumberToAlpha(r)+' : '+c.convertNumberToAlpha(r+u-1);this._dropRange?(this._dropRange.col=r,this._dropRange.col2=r+u-1):this._dropRange=new t.CellRange(0,r,this.rows.length-1,r+u-1)}else if(this._draggingRow){for(u=v.bottomRow-v.topRow+1,r=a.row,h=0,(r<0||r+u>b)&&(r=b-u),f=this.cells.getCellBoundingRect(r,0),l=this._root.offsetWidth-this._eRHdr.offsetWidth,s=0;s<u;s++)h+=this.rows[r+s].renderSize;o=this.cells.width;o=o>l?l:o;p=r+1+' : '+(r+u);this._dropRange?(this._dropRange.row=r,this._dropRange.row2=r+u-1):this._dropRange=new t.CellRange(r,0,r+u-1,this.columns.length-1)}if(f){if(e={display:'inline',zIndex:'9999',opacity:.5,top:f.top-(this._draggingColumn?this._ptScrl.y:0)+y.y,left:f.left-(this._draggingRow?this._ptScrl.x:0)+y.x,height:h,width:o},f.top=f.top-(this._draggingColumn?this._ptScrl.y:0),f.left=f.left-(this._draggingRow?this._ptScrl.x:0),this.rightToLeft&&this._draggingRow&&(e.left=e.left-o+f.width+2*this._ptScrl.x,f.left=f.left+2*this._ptScrl.x),this._draggingRow){if(d+this._eRHdr.offsetWidth!==e.left||g+this._root.offsetHeight+1<e.top+e.height)return}else if(g+this._eCHdr.offsetHeight!==e.top||d+this._root.offsetWidth+1<e.left+e.width)return;n.setCss(this._draggingMarker,e);this._draggingTooltip.show(this.hostElement,p,f)}},c.prototype._handleDropping=function(t){var r=this,e,u,o,f,s,h,c;if(r.selectedSheet&&r._draggingCells&&r._dropRange&&!r._containsMergedCells(r._draggingCells)&&!r._containsMergedCells(r._dropRange)){if(r._clearCalcEngine(),r._draggingColumn&&r._draggingCells.leftCol>r._dropRange.leftCol||r._draggingRow&&r._draggingCells.topRow>r._dropRange.topRow)if(t.shiftKey){if(r._draggingColumn)for(f=r._dropRange.leftCol,u=r._draggingCells.leftCol;u<=r._draggingCells.rightCol;u++)r.columns.moveElement(u,f),f++;else if(r._draggingRow)for(o=r._dropRange.topRow,e=r._draggingCells.topRow;e<=r._draggingCells.bottomRow;e++)r.rows.moveElement(e,o),o++;r._exchangeCellStyle(!0)}else{for(s=new i._MoveCellsAction(r,r._draggingCells,r._dropRange,t.ctrlKey),o=r._dropRange.topRow,e=r._draggingCells.topRow;e<=r._draggingCells.bottomRow;e++){for(f=r._dropRange.leftCol,u=r._draggingCells.leftCol;u<=r._draggingCells.rightCol;u++)r._moveCellContent(e,u,o,f,t.ctrlKey),r._draggingColumn&&o===r._dropRange.topRow&&(r.columns[f].dataType=r.columns[u].dataType?r.columns[u].dataType:n.DataType.Object,r.columns[f].align=r.columns[u].align,r.columns[f].format=r.columns[u].format,t.ctrlKey||(r.columns[u].dataType=n.DataType.Object,r.columns[u].align=null,r.columns[u].format=null)),f++;o++}if(r._draggingColumn&&!t.ctrlKey)for(f=r._dropRange.leftCol,u=r._draggingCells.leftCol;u<=r._draggingCells.rightCol;u++)r._updateColumnFiler(u,f),f++}else if(r._draggingColumn&&r._draggingCells.leftCol<r._dropRange.leftCol||r._draggingRow&&r._draggingCells.topRow<r._dropRange.topRow)if(t.shiftKey){if(r._draggingColumn)for(f=r._dropRange.rightCol,u=r._draggingCells.rightCol;u>=r._draggingCells.leftCol;u--)r.columns.moveElement(u,f),f--;else if(r._draggingRow)for(o=r._dropRange.bottomRow,e=r._draggingCells.bottomRow;e>=r._draggingCells.topRow;e--)r.rows.moveElement(e,o),o--;r._exchangeCellStyle(!1)}else{for(s=new i._MoveCellsAction(r,r._draggingCells,r._dropRange,t.ctrlKey),o=r._dropRange.bottomRow,e=r._draggingCells.bottomRow;e>=r._draggingCells.topRow;e--){for(f=r._dropRange.rightCol,u=r._draggingCells.rightCol;u>=r._draggingCells.leftCol;u--)r._moveCellContent(e,u,o,f,t.ctrlKey),r._draggingColumn&&o===r._dropRange.bottomRow&&(r.columns[f].dataType=r.columns[u].dataType?r.columns[u].dataType:n.DataType.Object,r.columns[f].align=r.columns[u].align,r.columns[f].format=r.columns[u].format,t.ctrlKey||(r.columns[u].dataType=n.DataType.Object,r.columns[u].align=null,r.columns[u].format=null)),f--;o--}if(r._draggingColumn&&!t.ctrlKey)for(f=r._dropRange.rightCol,u=r._draggingCells.rightCol;u>=r._draggingCells.leftCol;u--)r._updateColumnFiler(u,f),f--}t.ctrlKey||(h=r._updateFormulaForDropping(t.shiftKey),c=r._updateNamedRangesForDropping());s&&s.saveNewState()&&(s._affectedFormulas=h,s._affectedDefinedNameVals=c,r._undoStack._addAction(s));r._undoStack._pendingAction&&(r._undoStack._pendingAction._affectedFormulas=h,r._undoStack._pendingAction._affectedDefinedNameVals=c);r.select(r._dropRange);r.selectedSheet.selectionRanges.push(r.selection);r.hostElement.focus()}},c.prototype._moveCellContent=function(n,t,i,r,u){var f=this.getCellData(n,t,!1),e=n*this.columns.length+t,o=i*this.columns.length+r,s=this.selectedSheet._styledCells[e],h;u&&!!f&&typeof f=='string'&&f[0]==='='&&(h=this._updateCellRefForDropping(f,this.selectedSheetIndex));this.setCellData(i,r,h||f);s?this.selectedSheet._styledCells[o]=JSON.parse(JSON.stringify(s)):delete this.selectedSheet._styledCells[o];u||(this.setCellData(n,t,null),delete this.selectedSheet._styledCells[e])},c.prototype._exchangeCellStyle=function(n){for(var i,r,u,f,o=0,e=[],t=this._draggingCells.topRow;t<=this._draggingCells.bottomRow;t++)for(i=this._draggingCells.leftCol;i<=this._draggingCells.rightCol;i++)r=t*this.columns.length+i,this.selectedSheet._styledCells[r]?(e.push(JSON.parse(JSON.stringify(this.selectedSheet._styledCells[r]))),delete this.selectedSheet._styledCells[r]):e.push(undefined);if(n){if(this._draggingColumn)for(f=this._draggingCells.rightCol-this._draggingCells.leftCol+1,i=this._draggingCells.leftCol-1;i>=this._dropRange.leftCol;i--)for(t=0;t<this.rows.length;t++)r=t*this.columns.length+i,u=t*this.columns.length+i+f,this.selectedSheet._styledCells[r]?(this.selectedSheet._styledCells[u]=JSON.parse(JSON.stringify(this.selectedSheet._styledCells[r])),delete this.selectedSheet._styledCells[r]):delete this.selectedSheet._styledCells[u];else if(this._draggingRow)for(f=this._draggingCells.bottomRow-this._draggingCells.topRow+1,t=this._draggingCells.topRow-1;t>=this._dropRange.topRow;t--)for(i=0;i<this.columns.length;i++)r=t*this.columns.length+i,u=(t+f)*this.columns.length+i,this.selectedSheet._styledCells[r]?(this.selectedSheet._styledCells[u]=JSON.parse(JSON.stringify(this.selectedSheet._styledCells[r])),delete this.selectedSheet._styledCells[r]):delete this.selectedSheet._styledCells[u]}else if(this._draggingColumn)for(f=this._draggingCells.rightCol-this._draggingCells.leftCol+1,i=this._draggingCells.rightCol+1;i<=this._dropRange.rightCol;i++)for(t=0;t<this.rows.length;t++)r=t*this.columns.length+i,u=t*this.columns.length+i-f,this.selectedSheet._styledCells[r]?(this.selectedSheet._styledCells[u]=JSON.parse(JSON.stringify(this.selectedSheet._styledCells[r])),delete this.selectedSheet._styledCells[r]):delete this.selectedSheet._styledCells[u];else if(this._draggingRow)for(f=this._draggingCells.bottomRow-this._draggingCells.topRow+1,t=this._draggingCells.bottomRow+1;t<=this._dropRange.bottomRow;t++)for(i=0;i<this.columns.length;i++)r=t*this.columns.length+i,u=(t-f)*this.columns.length+i,this.selectedSheet._styledCells[r]?(this.selectedSheet._styledCells[u]=JSON.parse(JSON.stringify(this.selectedSheet._styledCells[r])),delete this.selectedSheet._styledCells[r]):delete this.selectedSheet._styledCells[u];for(t=this._dropRange.topRow;t<=this._dropRange.bottomRow;t++)for(i=this._dropRange.leftCol;i<=this._dropRange.rightCol;i++)r=t*this.columns.length+i,e[o]?this.selectedSheet._styledCells[r]=e[o]:delete this.selectedSheet._styledCells[r],o++},c.prototype._containsMergedCells=function(n){var t,i,u,r;if(!this.selectedSheet)return!1;for(t=n.topRow;t<=n.bottomRow;t++)for(i=n.leftCol;i<=n.rightCol;i++)if(u=t*this.columns.length+i,r=this.selectedSheet._mergedRanges[u],r&&r.isValid&&!r.isSingleCell)return!0;return!1},c.prototype._multiSelectColumns=function(n){var i;n&&this._columnHeaderClicked&&(i=new t.CellRange(n.row,n.col),i.row=!this.selectedSheet.itemsSource?0:1,i.row2=this.rows.length-1,i.col2=this.selection.col2,this.select(i))},c.prototype._cumulativeOffset=function(t){var i=0,r=0;do i+=t.offsetTop||0,r+=t.offsetLeft||0,t=t.offsetParent;while(t);return new n.Point(r,i)},c.prototype._cumulativeScrollOffset=function(t){var i=0,r=0;do i+=t.scrollTop||0,r+=t.scrollLeft||0,t=t.offsetParent;while(t&&!(t instanceof HTMLBodyElement));return i+=document.body.scrollTop||document.documentElement.scrollTop,r+=document.body.scrollLeft||document.documentElement.scrollLeft,new n.Point(r,i)},c.prototype._checkHitWithinSelection=function(n){var i;return n!=null&&n.cellType===t.CellType.Cell&&((i=this.getMergedRange(this.cells,n.row,n.col),i&&i.contains(this.selection))||this.selection.row===n.row&&this.selection.col===n.col)?!0:!1},c.prototype._clearForEmptySheet=function(n){this.selectedSheet&&this[n].length===0&&this._isCopying!==!0&&this._isUndoing!==!0&&(this.selectedSheet._mergedRanges=null,this.selectedSheet._styledCells=null,this.select(new t.CellRange))},c.prototype._containsGroupRows=function(n){for(var r,i=n.topRow;i<=n.bottomRow;i++)if(r=this.rows[i],r instanceof t.GroupRow)return!0;return!1},c.prototype._delSeletionContent=function(r){var l=this.selectedSheet.selectionRanges,e,c,h,f,u,o,a=!1,s,v=new i._EditAction(this);if(!this.isReadOnly){for(this.beginUpdate(),h=0;h<l.length;h++)for(e=l[h],c=new t.CellRange,s=new t.CellEditEndingEventArgs(this.cells,c,r),u=e.topRow;u<=e.bottomRow;u++)if(this.rows[u]&&!this.rows[u].isReadOnly)for(f=e.leftCol;f<=e.rightCol;f++)if(o=this._getBindingColumn(this.cells,u,this.columns[f]),(!o.isReadOnly&&o.isRequired===!1||o.isRequired==null&&o.dataType==n.DataType.String)&&this.getCellData(u,f,!0)&&(c.setRange(u,f),s.cancel=!1,this.onBeginningEdit(s))){this.setCellData(u,f,'',!0);a=!0;this.onCellEditEnding(s);this.onCellEditEnded(s)}a&&(v.saveNewState(),this._undoStack._addAction(v));this.endUpdate()}},c.prototype._updateAffectedFormula=function(t,i,r,u){var o,c,h,f,e,l,a,s,v,y=[],p=[],w=this.selection.clone();for(this.selectedSheet._storeRowSettings(),this.beginUpdate(),o=0;o<this.sheets.length;o++)for(c=this.sheets[o],h=c.grid,f=0;f<h.rows.length;f++)for(e=0;e<h.columns.length;e++)if(s=h.getCellData(f,e,!1),!!s&&n.isString(s)&&s[0]==='='&&(v=this._updateCellRef(s,o,t,i,r,u),v)){if(y.push({sheet:c,point:new n.Point(f,e),formula:s}),l=f,a=e,o===this.selectedSheetIndex&&(u?f>=t&&(r?l+=i:l-=i):e>=t&&(r?a+=i:a-=i),!r&&(u&&f<=t&&f>=t-i+1||!u&&e<=t&&e>=t-i+1)))continue;h.setCellData(f,e,v);p.push({sheet:c,point:new n.Point(l,a),formula:v})}return this.selection=w,this.endUpdate(),{oldFormulas:y,newFormulas:p}},c.prototype._updateAffectedNamedRanges=function(t,i,r,u){for(var f,e,s,h=[],c=[],o=0;o<this.definedNames.length;o++)f=this.definedNames[o],e=f.value,!!e&&n.isString(e)&&(s=this._updateCellRef(e,this.selectedSheetIndex,t,i,r,u),s&&(h.push({name:f.name,value:e}),f.value=s,c.push({name:f.name,value:s})));return{oldDefinedNameVals:h,newDefinedNameVals:c}},c.prototype._updateColumnFiler=function(n,t){for(var u,i=JSON.parse(this._filter.filterDefinition),r=0;r<i.filters.length;r++)if(u=i.filters[r],u.columnIndex===n){u.columnIndex=t;break}this._filter.filterDefinition=JSON.stringify(i)},c.prototype._isDescendant=function(n,t){for(var i=t.parentNode;i!=null;){if(i===n)return!0;i=i.parentNode}return!1},c.prototype._clearCalcEngine=function(){this._calcEngine._clearExpressionCache()},c.prototype._getRangeString=function(i,r,u){var v,l,c,a;u===void 0&&(u=!0);var f='',p,h,y=!0,a,w,e,o,s=r===this.selectedSheet?this:r.grid;if(n.isArray(i)&&i.length>1){if(this._isMultipleRowsSelected(i,r)){for(f='',h=0;h<i.length;h++)f&&(f+='\n'),f+=this._getRangeString(i[h],r);return f}if(this._isMultipleColumnsSelected(i,r))for(f='',p=0,y=!0;p<s.rows.length;p++){for(y||(f+='\n'),y=!1,h=0,a=!0;h<i.length;h++)w=i[h].clone(),w.row=w.row2=p,a||(f+='\t'),a=!1,f+=this._getRangeString(i[h],r);return f}else{o=i[0];switch(this.selectionMode){case t.SelectionMode.Row:case t.SelectionMode.RowRange:return o.col=0,o.col2=s.columns.length-1,this._getRangeString(o,r);case t.SelectionMode.ListBox:for(o.col=0,o.col2=s.columns.length-1,v=0;v<s.rows.length;v++)s.rows[v].isSelected&&s.rows[v].isVisible&&(o.row=o.row2=v,f&&(f+='\n'),f+=this._getRangeString(o,r));return f}}}for(o=n.asType(n.isArray(i)?i[0]:i,t.CellRange),l=o.topRow;l<=o.bottomRow;l++)if(s.rows[l]&&s.rows[l].isVisible)for(y||(f+='\n'),y=!1,c=o.leftCol,a=!0;c<=o.rightCol;c++)if(s.columns[c]&&s.columns[c].isVisible){if(a||(f+='\t'),a=!1,u){if(e=s.getCellData(l,c,!0).toString(),e&&e[0]==='='){var d=l*s.columns.length+c,b=r._styledCells[d],k=b?b.format:'',g=s.columns[c];e=this.evaluate(e,k,r);e=this._formatEvaluatedResult(e,g,k);e=e==null?'':e}}else e=s.getCellData(l,c,!0).toString();e=e.replace(/\t/g,' ');e.indexOf('\n')>-1&&(e='"'+e.replace(/"/g,'""')+'"');f+=e}return f},c.prototype._containsRandFormula=function(t,i){for(var r,f,e,o,u=0;u<t.length;u++)for(r=t[u],f=r.topRow;f<=r.bottomRow;f++)for(e=r.leftCol;e<=r.rightCol;e++)if(o=i.grid.getCellData(f,e,!1),n.isString(o)&&o[0]==='='&&o.search(/rand/i)!==-1)return!0;return!1},c.prototype._isMultipleRowsSelected=function(n,t){for(var i,u=n&&n.length>0?n:this.selectedSheet.selectionRanges.length>0?this.selectedSheet.selectionRanges:[this.selection],r=0;r<u.length;r++)if(i=u[r],t){if(i.leftCol!==0||i.rightCol!==t.grid.columns.length-1)return!1}else if(i.leftCol!==0||i.rightCol!==this.columns.length-1)return!1;return!0},c.prototype._isMultipleColumnsSelected=function(n,t){for(var i,u=n&&n.length>0?n:this.selectedSheet.selectionRanges.length>0?this.selectedSheet.selectionRanges:[this.selection],r=0;r<u.length;r++)if(i=u[r],t){if(i.bottomRow!==t.grid.rows.length-1||!t.grid.itemsSource&&i.topRow!==0||!!t.grid.itemsSource&&i.topRow!==1)return!1}else if(i.bottomRow!==this.rows.length-1||!this.selectedSheet.itemsSource&&i.topRow!==0||!!this.selectedSheet.itemsSource&&i.topRow!==1)return!1;return!0},c.prototype._postSetClipStringProcess=function(n,i,r,u,f){var e,o,s,c,l=!1,h;if(u>=0&&f>=0&&(e=this.getMergedRange(this.cells,u,f),!e||e.topRow!==u||e.leftCol!==f||(o=i+e.rowSpan-1,o=o<this.rows.length?o:this.rows.length-1,s=r+e.columnSpan-1,s=s<this.columns.length?s:this.columns.length-1,this.mergeRange(new t.CellRange(i,r,o,s),!0))),c=new t.CellRangeEventArgs(this.cells,new t.CellRange(i,r),n),this.onPastingCell(c)&&this.cells.setCellData(i,r,n)){h=n.match(/\n/g);h&&h.length>0&&(this._applyStyleForCell(i,r,{whiteSpace:'pre'}),this.rows[i].height=this.rows.defaultSize*(h.length+1));this.onPastedCell(c);l=!0}return l},c.prototype._delCutData=function(){for(var i,u,f=this._copiedRanges[0],r=this._copiedSheet===this.selectedSheet?this:this._copiedSheet.grid,t=f.topRow;t<=f.bottomRow;t++)for(i=f.leftCol;i<=f.rightCol;i++)(this._copiedSheet!==this.selectedSheet||t<this.selection.topRow||t>this.selection.bottomRow||i<this.selection.leftCol||i>this.selection.rightCol)&&(u=r._getBindingColumn(r.cells,t,r.columns[i]),(u.isRequired==!1||u.isRequired==null&&u.dataType==n.DataType.String)&&r.getCellData(t,i,!0)&&r.setCellData(t,i,'',!0))},c.prototype._containsMultiLineText=function(n){for(var r,i,t=0;t<n.length;t++)for(r=n[t],i=0;i<r.length;i++)if(r[i].indexOf('\n')>=0)return!0;return!1},c.prototype._sortByRow=function(n,t){return n.topRow>t.topRow?1:n.topRow<t.topRow?-1:0},c.prototype._sortByColumn=function(n,t){return n.leftCol>t.leftCol?1:n.leftCol<t.leftCol?-1:0},c.prototype._setFlexSheetToDirty=function(){this.columns._dirty=!0;this.rows._dirty=!0;this.rowHeaders.columns._dirty=!0;this.rowHeaders.rows._dirty=!0;this.columnHeaders.columns._dirty=!0;this.columnHeaders.rows._dirty=!0},c.convertNumberToAlpha=function(n){var t='',i,r;if(n>=0)do i=Math.floor(n/26),r=n%26,t=String.fromCharCode(r+65)+t,n=i-1;while(i);return t},c.prototype._updateFormulaForReorderingRows=function(t,i){var l=i-t,r,e,h,c,u,f,o,s;for(this.beginUpdate(),o=0;o<this.columns.length;o++)if(r=this.getCellData(i,o,!1),!!r&&typeof r=='string'&&r[0]==='='&&(e=r.match(/(?=\b\D)\$?[A-Za-z]{1,2}\$?\d+/g),!!e&&e.length>0)){for(s=0;s<e.length;s++)h=e[s],u=n.xlsx.Workbook.tableAddress(h),f=u.row+l,f<0?f=0:f>=this.rows.length&&(f=this.rows.length-1),u.row=f,c=n.xlsx.Workbook.xlsxAddress(u.row,u.col,u.absRow,u.absCol),r=r.replace(h,c);this.setCellData(i,o,r)}this.endUpdate()},c.prototype._updateFormulaForDropping=function(t){var h=[],c=[],e,u,o,i,l,r,a,f,s;for(this.beginUpdate(),o=0;o<this.sheets.length;o++)for(e=this.sheets[o],u=e.grid,i=0;i<u.rows.length;i++)for(r=0;r<u.columns.length;r++)f=u.getCellData(i,r,!1),!f||typeof f!='string'||f[0]!=='='||(s=this._updateCellRefForDropping(f,o),s&&(u.setCellData(i,r,s),t&&o===this.selectedSheetIndex?(l=u.rows[i],a=u.columns[r],h.push({sheet:e,row:l,column:a,formula:f}),c.push({sheet:e,row:l,column:a,formula:s})):(h.push({sheet:e,point:new n.Point(i,r),formula:f}),c.push({sheet:e,point:new n.Point(i,r),formula:s}))));return this.endUpdate(),{oldFormulas:h,newFormulas:c}},c.prototype._updateNamedRangesForDropping=function(){for(var t,i,u,f=[],e=[],r=0;r<this.definedNames.length;r++)t=this.definedNames[r],i=t.value,!!i&&n.isString(i)&&(u=this._updateCellRefForDropping(i,this.selectedSheetIndex),u&&(f.push({name:t.name,value:i}),t.value=u,e.push({name:t.name,value:u})));return{oldDefinedNameVals:f,newDefinedNameVals:e}},c.prototype._updateCellRefForDropping=function(i,r){var v,h,c,l,p,b,e,w,o,f,k,u,y,s,a;if(c=i.match(/((\w+)\!)?\$?[A-Za-z]{1,2}\$?\d+:((\w+)\!)?\$?[A-Za-z]{1,2}\$?\d+/g),c&&c.length!==0||(c=i.match(/((\w+)\!)?(?=\b\D)\$?[A-Za-z]{1,2}\$?\d+/g)),!!c&&c.length>0)for(p=0;p<c.length;p++){if(f=null,e=null,w=null,u=null,s=null,a=null,l=c[p],l.indexOf(':')>0){if(b=l.split(':'),e=b[0],w=b[1],o=e.indexOf('!'),o>=0&&(f=e.substring(0,o),e=e.substring(o+1)),r===this.selectedSheetIndex){if(f&&f.toLowerCase()!==this.selectedSheet.name.toLowerCase())continue}else if(!f||f.toLowerCase()!==this.selectedSheet.name.toLowerCase())continue;o=e.indexOf('!');o>=0&&(k=e.substring(0,o),w=e.substring(o+1));s=n.xlsx.Workbook.tableAddress(e);u=new t.CellRange(s.row,s.col);a=n.xlsx.Workbook.tableAddress(w);u.row2=a.row;u.col2=a.col}else{if(o=l.indexOf('!'),o>=0?(f=l.substring(0,o),e=l.substring(o+1)):e=l,r===this.selectedSheetIndex){if(f&&f.toLowerCase()!==this.selectedSheet.name.toLowerCase())continue}else if(!f||f.toLowerCase()!==this.selectedSheet.name.toLowerCase())continue;s=n.xlsx.Workbook.tableAddress(e);u=new t.CellRange(s.row,s.col)}u&&this._draggingCells.contains(u)&&(h=this._dropRange.leftCol-this._draggingCells.leftCol,h!==0&&(u.col+=h,u.col2+=h),h=this._dropRange.topRow-this._draggingCells.topRow,h!==0&&(u.row+=h,u.row2+=h),v==null&&(v=i),a?(y=f?f+'!':'',y+=n.xlsx.Workbook.xlsxAddress(u.row,u.col,s.absRow,s.absCol)+':',y+=(k?k+'!':'')+n.xlsx.Workbook.xlsxAddress(u.row2,u.col2,a.absRow,a.absCol)):y=(f?f+'!':'')+n.xlsx.Workbook.xlsxAddress(u.row,u.col,s.absRow,s.absCol),v=v.replace(l,y))}return v},c.prototype._scanFormulas=function(){for(var t,i,u=[],r=0;r<this.rows.length;r++)for(t=0;t<this.columns.length;t++)i=this.getCellData(r,t,!1),i&&n.isString(i)&&i[0]==='='&&u.push({row:r,column:t,formula:i});return u},c.prototype._resetFormulas=function(n){var t=this;n&&t.deferUpdate(function(){for(var r,i=0;i<n.length;i++)r=n[i],t.setCellData(r.row,r.column,r.formula)})},c.prototype._getCellStyle=function(n,t,i){var i=i||this.selectedSheet,r;return i?(r=n*i.grid.columns.length+t,i._styledCells[r]):null},c.prototype._validateSheetName=function(n){for(var t=0;t<this.sheets.length;t++)if(this.sheets[t].name===n)return!0;return!1},c.prototype._checkExistDefinedName=function(n,t,i){i===void 0&&(i=-1);for(var r=0;r<this.definedNames.length;r++)if(this.definedNames[r].name===n&&this.definedNames[r].sheetName===t&&r!==i)return!0;return!1},c.prototype._updateDefinedNameWithSheetRefUpdating=function(n,t){for(var f,i,r,u,o,e=0;e<this.definedNames.length;e++)if(i=this.definedNames[e],i.sheetName===n&&i.sheetName!=null&&(i._sheetName=t),r=i.value.match(/(\w+)\!\$?[A-Za-z]+\$?\d+/g),r&&r.length>0)for(f=0;f<r.length;f++)u=r[f],o=u.substring(0,u.indexOf('!')),o===n&&(i.value=i.value.replace(u,u.replace(n,t)))},c.prototype._updateFormulasWithDefinedNameUpdating=function(n,t){var o,u,f,l,e,i,r,s,h,a,v=this.selection.clone(),c=!1;for(this.selectedSheet._storeRowSettings(),this.beginUpdate(),o=0;o<this.sheets.length;o++)for(l=this.sheets[o],e=l.grid,u=0;u<e.rows.length;u++)for(f=0;f<e.columns.length;f++)if(i=e.getCellData(u,f,!1),!!i&&typeof i=='string'&&i[0]==='='){for(c=!1,r=i.indexOf(n),a=new RegExp(n,'g');r>-1;)s='',h='',r>0&&(s=i[r-1]),r+n.length<i.length&&(h=i[r+n.length]),/\w/.test(s)||/\w/.test(h)||(i=i.replace(a,function(i,u){return u===r?t:n}),c=!0),r=i.indexOf(n,r+n.length);c&&e.setCellData(u,f,i)}this._copyFrom(this.selectedSheet);this.selection=v;this.endUpdate()},c.prototype._getDefinedNameIndexByName=function(n){for(var t=0;t<this.definedNames.length;t++)if(this.definedNames[t].name===n)return t;return-1},c.prototype._copy=function(n,t){var i,f,u;if(n=='columns'){if(h.prototype._copy.call(this,n,t),!!this.itemsSource&&(i=this.rows[0],i instanceof r))for(i._ubv=null,i._ubv={},u=0;u<this.columns.length;u++)f=this.columns[u],i._ubv[f._hash]=f.header;return!0}return!1},c.prototype._sheetSortConverter=function(t,i,r,u){return r=h.prototype._sortConverter.call(this,t,i,r,u),n.isString(r)&&r.length>0&&r[0]==='='&&(r=this.evaluate(r),!n.isPrimitive(r)&&r&&(r=r.value)),r},c.prototype._formatEvaluatedResult=function(t,i,r){return n.isPrimitive(t)?(i.dataMap&&(t=i.dataMap.getDisplayValue(t)),t=!n.isInt(t)||i.format||i.dataMap||r?t!=null?n.Globalize.format(t,r||i.format):'':t.toString()):t&&(t=!n.isInt(t.value)||i.format||i.dataMap||r||t.format?t.value!=null?n.Globalize.format(t.value,r||t.format||i.format):'':t.value.toString()),t},c.prototype._updateCellRef=function(i,r,u,f,e,o){var k,y,p,c,w,nt,tt,l,g,a,h,it,s,d,v,b;if(y=i.match(/((\w+)\!)?\$?[A-Za-z]{1,2}\$?\d+:((\w+)\!)?\$?[A-Za-z]{1,2}\$?\d+/g),y&&y.length!==0||(y=i.match(/((\w+)\!)?(?=\b\D)\$?[A-Za-z]{1,2}\$?\d+/g)),!!y&&y.length>0){for(nt=[],p=0;p<y.length;p++)nt[p]=i.indexOf(y[p]);for(p=0;p<y.length;p++){if(h=null,l=null,g=null,s=null,v=null,b=null,w=y[p],w.indexOf(':')>0){if(tt=w.split(':'),l=tt[0],g=tt[1],a=l.indexOf('!'),a>=0&&(h=l.substring(0,a),l=l.substring(a+1)),r===this.selectedSheetIndex){if(h&&h.toLowerCase()!==this.selectedSheet.name.toLowerCase())continue}else if(!h||h.toLowerCase()!==this.selectedSheet.name.toLowerCase())continue;a=l.indexOf('!');a>=0&&(it=l.substring(0,a),g=l.substring(a+1));v=n.xlsx.Workbook.tableAddress(l);s=new t.CellRange(v.row,v.col);b=n.xlsx.Workbook.tableAddress(g);s.row2=b.row;s.col2=b.col}else{if(a=w.indexOf('!'),a>=0?(h=w.substring(0,a),l=w.substring(a+1)):l=w,r===this.selectedSheetIndex){if(h&&h.toLowerCase()!==this.selectedSheet.name.toLowerCase())continue}else if(!h||h.toLowerCase()!==this.selectedSheet.name.toLowerCase())continue;v=n.xlsx.Workbook.tableAddress(l);s=new t.CellRange(v.row,v.col)}s&&(c=!1,o?e?s.topRow>=u?(s.row+=f,s.row2+=f,c=!0):s.topRow<u&&s.bottomRow>=u&&(s.row<s.row2?s.row2+=f:s.row+=f,c=!0):s.topRow>u?(s.row-=f,s.row2-=f,c=!0):s.isSingleCell?s.row>=u-f+1&&(s.row=u-f+1,s.row2=u-f+1,c=!0):s.topRow>=u-f+1?(s.row<s.row2?(s.row=u-f+1,s.row2-=f):(s.row-=f,s.row2=u-f+1),c=!0):s.topRow<u-f+1&&s.bottomRow>=u-f+1&&(s.bottomRow>u?s.row<s.row2?s.row2-=f:s.row-=f:s.row<s.row2?s.row2=u-f:s.row=u-f,c=!0):e?s.leftCol>=u?(s.col+=f,s.col2+=f,c=!0):s.leftCol<u&&s.rightCol>=u&&(s.col<s.col2?s.col2+=f:s.col+=f,c=!0):s.leftCol>u?(s.col-=f,s.col2-=f,c=!0):s.isSingleCell?s.col>=u-f+1&&(s.col=u-f+1,s.col2=u-f+1,c=!0):s.leftCol>=u-f+1?(s.col<s.col2?(s.col=u-f+1,s.col2-=f):(s.col-=f,s.col2=u-f+1),c=!0):s.leftCol<u-f+1&&s.rightCol>=u-f+1&&(s.rightCol>u?s.col<s.col2?s.col2-=f:s.col-=f:s.col<s.col2?s.col2=u-f:s.col=u-f,c=!0),c&&(b?(d=h?h+'!':'',d+=n.xlsx.Workbook.xlsxAddress(s.row,s.col,v.absRow,v.absCol)+':',d+=(it?it+'!':'')+n.xlsx.Workbook.xlsxAddress(s.row2,s.col2,b.absRow,b.absCol)):d=(h?h+'!':'')+n.xlsx.Workbook.xlsxAddress(s.row,s.col,v.absRow,v.absCol),k==null&&(k=i),k=k.replace(new RegExp(w.replace(/\$/g,'\\$'),'gi'),function(n,t){return t+n.length>=nt[p]?d:n})))}}return k},c.prototype._copyRowsToSelectedSheet=function(){var t,n=this;if(n.selectedSheet){for(n.selectedSheet.grid.rows.clear(),t=0;t<n.rows.length;t++)n.selectedSheet.grid.rows.push(n.rows[t]);setTimeout(function(){n._setFlexSheetToDirty();n.invalidate()},10)}},c.prototype._copyColumnsToSelectedSheet=function(){var t,n=this;if(n.selectedSheet){for(n.selectedSheet.grid.columns.clear(),t=0;t<n.columns.length;t++)n.selectedSheet.grid.columns.push(n.columns[t]);setTimeout(function(){n._setFlexSheetToDirty();n.invalidate()},10)}},c}(t.FlexGrid),o,c,u,f,r,e;h.controlTemplate='<div style="width:100%;height:100%"><div wj-part="container" style="width:100%">'+t.FlexGrid.controlTemplate+'<\/div><div wj-part="tab-holder" style="width:100%; min-width:100px"><\/div><div wj-part="context-menu" style="display:none;z-index:100"><\/div><\/div>';i.FlexSheet=h;o=function(n){function t(t,i){var r=n.call(this)||this;return r._isDraggingRows=t,r._isShiftKey=i,r}return __extends(t,n),Object.defineProperty(t.prototype,"isDraggingRows",{get:function(){return this._isDraggingRows},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isShiftKey",{get:function(){return this._isShiftKey},enumerable:!0,configurable:!0}),t}(n.EventArgs);i.DraggingRowColumnEventArgs=o;c=function(n){function t(t,i){var r=n.call(this)||this;return r._funcName=t,r._params=i,r}return __extends(t,n),Object.defineProperty(t.prototype,"funcName",{get:function(){return this._funcName},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"params",{get:function(){return this._params},enumerable:!0,configurable:!0}),t}(n.EventArgs);i.UnknownFunctionEventArgs=c;u=function(t){function i(n,i,r){var u=t.call(this)||this;return u._index=n,u._count=i,u._added=r,u}return __extends(i,t),Object.defineProperty(i.prototype,"index",{get:function(){return this._index},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"count",{get:function(){return this._count},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"added",{get:function(){return this._added},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isAdd",{get:function(){return n._deprecated('RowColumnChangedEventArgs.isAdd','RowColumnChangedEventArgs.added'),this._added},enumerable:!0,configurable:!0}),i}(n.EventArgs);i.RowColumnChangedEventArgs=u;f=function(i){function r(n,t,r,u,f){return i.call(this,n,t,r,u,f)||this}return __extends(r,i),r.prototype.getSelectedState=function(n,r,u){var o,s,e,f,c,h;if(!this.grid)return undefined;if(h=this.grid.getMergedRange(this,n,r),o=this.grid.selectedSheet?this.grid.selectedSheet.selectionRanges:null,c=i.prototype.getSelectedState.call(this,n,r,u),s=o?o.length:0,c===t.SelectedState.None&&s>0)for(e=0;e<o.length;e++)if(f=o[e],f&&f instanceof t.CellRange){if(this.cellType===t.CellType.Cell){if(h){if(h.contains(f.row,f.col))return e===s-1&&!this.grid._isClicking?this.grid.showMarquee?t.SelectedState.None:t.SelectedState.Cursor:t.SelectedState.Selected;if(h.intersects(f))return t.SelectedState.Selected}if(f.row===n&&f.col===r)return e===s-1&&!this.grid._isClicking?this.grid.showMarquee?t.SelectedState.None:t.SelectedState.Cursor:t.SelectedState.Selected;if(f.contains(n,r))return t.SelectedState.Selected}if(this.grid.showSelectedHeaders&t.HeadersVisibility.Row&&this.cellType===t.CellType.RowHeader&&f.containsRow(n)||this.grid.showSelectedHeaders&t.HeadersVisibility.Column&&this.cellType===t.CellType.ColumnHeader&&f.containsColumn(r))return t.SelectedState.Selected}return c},r.prototype.getCellData=function(t,r,u){var o=i.prototype.getCellData.call(this,t,r,u),s=this.columns[n.asNumber(r,!1,!0)],e=this.grid?this.grid._getBindingColumn(this,t,s):s,h,f;return u&&(f=i.prototype.getCellData.call(this,t,r,!1),h=this.grid?this.grid._getCellStyle(t,r):null,!n.isNumber(f)||f===0||!e||e.format||e.dataMap||h||(o=f.toString())),o},r.prototype.setCellData=function(t,r,u,f){f===void 0&&(f=!0);var e,o=this.getCellData(t,r,!1),s=this.grid._isPasting;return f&&u&&n.isString(u)&&(this.grid.columns[r].dataType===n.DataType.String||n.isNullOrWhiteSpace(u)||isNaN(+u)?this.grid.columns[r].dataType===n.DataType.Boolean?u=n.changeType(u,n.DataType.Boolean,null):u[0]!=='='&&(e=n.Globalize.parseDate(u,''),e&&(u=e)):u=+u),(u&&n.isString(u)&&u[0]==='='||n.isString(o))&&(f=!1),i.prototype.setCellData.call(this,t,r,u,f&&!s)},r.prototype._renderCell=function(t,r,u,f,e,o){var s=t.childNodes[o],h,l=r*this.grid.columns.length+u,c=this.grid.getMergedRange(this,r,u);return(o=i.prototype._renderCell.call(this,t,r,u,f,e,o),this.cellType!==n.grid.CellType.Cell)?o:c&&l>c.topRow*this.grid.columns.length+c.leftCol?o:(n.hasClass(s,'wj-state-selected')||n.hasClass(s,'wj-state-multi-selected')?(s.style.backgroundColor='',s.style.color=''):this.grid.selectedSheet&&(h=this.grid.selectedSheet._styledCells[l],s&&h&&(s.style.backgroundColor=h.backgroundColor,s.style.color=h.color)),o)},r}(t.GridPanel);i.FlexSheetPanel=f;r=function(n){function t(){var t=n.call(this)||this;return t.isReadOnly=!0,t}return __extends(t,n),t}(t.Row);i.HeaderRow=r;e=function(){function n(n,t,i,r){if(this._owner=n,this._name=t,this._value=i,r!=null)if(n._validateSheetName(r))this._sheetName=r;else throw'The sheet name:('+r+') does not exist in FlexSheet.';}return Object.defineProperty(n.prototype,"name",{get:function(){return this._name},set:function(n){var t;if(this._name!==n)if(this._owner._checkExistDefinedName(name,this._sheetName))throw'The '+name+' already existed in definedNames.';else t=this._name,this._name=n,this._owner._updateFormulasWithDefinedNameUpdating(t,this._name)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"value",{get:function(){return this._value},set:function(n){this._value!==n&&(this._value=n)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"sheetName",{get:function(){return this._sheetName},enumerable:!0,configurable:!0}),n}();i.DefinedName=e})(i=t.sheet||(t.sheet={}))})(t=n.grid||(n.grid={}))}(wijmo||(wijmo={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t;(function(t){var i;(function(i){'use strict';var e=function(){function r(t,i,r,f,e){this._visible=!0;this._unboundSortDesc=new n.collections.ObservableArray;this._currentStyledCells={};this._currentMergedRanges={};this._isEmptyGrid=!1;this._rowSettings=[];this._scrollPosition=new n.Point;this._freezeHiddenRowCnt=0;this._freezeHiddenColumnCnt=0;this.nameChanged=new n.Event;this.visibleChanged=new n.Event;var o=this;o._owner=t;o._name=r;o._rowCount=n.isNumber(f)&&!isNaN(f)&&f>=0?f:200;o._columnCount=n.isNumber(e)&&!isNaN(e)&&e>=0?e:20;o._grid=i||this._createGrid();o._grid.itemsSourceChanged.addHandler(this._gridItemsSourceChanged,this);o._addHeaderRow();o._unboundSortDesc.collectionChanged.addHandler(function(){for(var r=o._unboundSortDesc,f,i,t=0;t<r.length;t++)if(f=n.tryCast(r[t],u),!f)throw'sortDescriptions array must contain SortDescription objects.';if(o._owner){if(o._owner.rows.beginUpdate(),o._owner.rows.sort(o._compareRows()),!o._owner._isUndoing)for(t=0;t<o._owner.rows.length;t++)i=o._owner.rows[t],t!==i._idx&&o._owner._updateFormulaForReorderingRows(i._idx,t);o._owner.rows.endUpdate();o._owner.rows._dirty=!0;o._owner.rows._update();o._owner.selectedSheet&&(o._owner._copyTo(o._owner.selectedSheet),o._owner._copyFrom(o._owner.selectedSheet))}})}return Object.defineProperty(r.prototype,"grid",{get:function(){return this._grid.wj_sheetInfo==null&&(this._grid.wj_sheetInfo={}),this._grid},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"name",{get:function(){return this._name},set:function(t){if(!n.isNullOrWhiteSpace(t)&&(this._name&&this._name.toLowerCase()!==t.toLowerCase()||!this._name)){var i=new n.PropertyChangedEventArgs('sheetName',this._name,t);this._name=t;this.grid.wj_sheetInfo.name=t;this.onNameChanged(i)}},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"visible",{get:function(){return this._visible},set:function(t){if(this._visible!==t){this._visible=t;this.grid.wj_sheetInfo.visible=t;this.onVisibleChanged(new n.EventArgs)}},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"rowCount",{get:function(){return this._grid!=null?this._grid.rows.length:0},set:function(i){var r;if(!this.itemsSource&&n.isNumber(i)&&!isNaN(i)&&i>=0&&this._rowCount!==i){if(this._rowCount<i)for(r=0;r<i-this._rowCount;r++)this.grid.rows.push(new t.Row);else this.grid.rows.splice(i,this._rowCount-i);this._rowCount=i;this._owner&&this._owner.selectedSheet&&this._name===this._owner.selectedSheet.name&&this._owner._copyFrom(this,!0)}},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"columnCount",{get:function(){return this._grid!=null?this._grid.columns.length:0},set:function(i){var r;if(!this.itemsSource&&n.isNumber(i)&&!isNaN(i)&&i>=0&&this._columnCount!==i){if(this._columnCount<i)for(r=0;r<i-this._columnCount;r++)this._grid.columns.push(new t.Column);else this._grid.columns.splice(i,this._columnCount-i);this._columnCount=i;this._owner&&this._owner.selectedSheet&&this._name===this._owner.selectedSheet.name&&this._owner._copyFrom(this,!0)}},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"selectionRanges",{get:function(){var i=this;return this._selectionRanges||(this._selectionRanges=new n.collections.ObservableArray,this._selectionRanges.collectionChanged.addHandler(function(){var n,r;i._owner&&!i._owner._isClicking&&(n=i._selectionRanges.length,n>0&&(r=i._selectionRanges[n-1],r&&r instanceof t.CellRange&&(i._owner.selection=r)),n>1&&(i._owner._enableMulSel=!0),i._owner.refresh(),i._owner._enableMulSel=!1)},this)),this._selectionRanges},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"itemsSource",{get:function(){return this._grid!=null?this._grid.itemsSource:null},set:function(n){var t=this;t._grid==null&&(t._createGrid(),t._grid.itemsSourceChanged.addHandler(t._gridItemsSourceChanged,t));t._isEmptyGrid&&t._clearGrid();t._grid.loadedRows.addHandler(function(){t._addHeaderRow()});t._grid.itemsSource=n},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"_styledCells",{get:function(){return this._currentStyledCells||(this._currentStyledCells={}),this._currentStyledCells},set:function(n){this._currentStyledCells=n},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"_mergedRanges",{get:function(){return this._currentMergedRanges||(this._currentMergedRanges={}),this._currentMergedRanges},set:function(n){this._currentMergedRanges=n},enumerable:!0,configurable:!0}),r.prototype.onNameChanged=function(n){this.nameChanged.raise(this,n)},r.prototype.onVisibleChanged=function(n){this.visibleChanged.raise(this,n)},r.prototype.getCellStyle=function(n,t){var i,u=this._grid.rows.length,r=this._grid.columns.length;return n>=u||t>=r?null:(i=n*r+t,this._styledCells[i])},r.prototype._attachOwner=function(n){this._owner!==n&&(this._owner=n)},r.prototype._setValidName=function(n){this._name=n;this.grid.wj_sheetInfo.name=n},r.prototype._storeRowSettings=function(){var i=0,n;for(this._rowSettings=[];i<this._grid.rows.length;i++)n=this._owner.rows[i],n&&(this._rowSettings[i]={height:n.height,allowMerging:n.allowMerging,isCollapsed:n instanceof t.GroupRow?n.isCollapsed:null,visible:n.visible})},r.prototype._setRowSettings=function(){for(var r=0,n,i;r<this._rowSettings.length;r++)i=this._rowSettings[r],i&&(n=this._grid.rows[r],n.height=i.height,n.allowMerging=i.allowMerging,n.visible=i.visible,n instanceof t.GroupRow&&(n.isCollapsed=i.isCollapsed))},r.prototype._compareRows=function(){var t=this,i=this._unboundSortDesc;return function(r,u){for(var o,h=0;h<i.length;h++){var s=i[h],f=r._ubv&&s.column?r._ubv[s.column._hash]:'',e=u._ubv&&s.column?u._ubv[s.column._hash]:'';if(n.isString(f)&&f[0]==='='&&(f=t._owner.evaluate(f),f==null||n.isPrimitive(f)||(f=f.value)),n.isString(e)&&e[0]==='='&&(e=t._owner.evaluate(e),e==null||n.isPrimitive(e)||(e=e.value)),f!==f&&(f=null),e!==e&&(e=null),n.isString(f)&&(f=f.toLowerCase()+f),n.isString(e)&&(e=e.toLowerCase()+e),f===''||f==null)return 1;if(e===''||e==null)return-1;if(o=f<e?-1:f>e?1:0,n.isString(f)&&n.isNumber(e)&&(o=1),n.isString(e)&&n.isNumber(f)&&(o=-1),o!==0)return s.ascending?+o:-o}return 0}},r.prototype._createGrid=function(){var i=document.createElement('div'),n,r,u,f;for(this._isEmptyGrid=!0,i.style.visibility='hidden',document.body.appendChild(i),n=new t.FlexGrid(i),document.body.removeChild(i),f=0;f<this._rowCount;f++)n.rows.push(new t.Row);for(u=0;u<this._columnCount;u++)r=new t.Column,r.isRequired=!1,n.columns.push(r);return n.wj_sheetInfo={name:this.name,visible:this.visible,styledCells:this._styledCells,mergedRanges:this._mergedRanges},n},r.prototype._clearGrid=function(){this._grid.rows.clear();this._grid.columns.clear();this._grid.columnHeaders.columns.clear();this._grid.rowHeaders.rows.clear()},r.prototype._gridItemsSourceChanged=function(){var n=this;n._owner&&n._owner.selectedSheet&&n._name===n._owner.selectedSheet.name&&(n._owner._filter.clear(),n._owner._copyFrom(n,!1),setTimeout(function(){n._owner._setFlexSheetToDirty();n._owner.invalidate()},10))},r.prototype._addHeaderRow=function(){var n,r,t;if(this._grid.itemsSource&&!(this._grid.rows[0]instanceof i.HeaderRow)){for(n=new i.HeaderRow,t=0;t<this._grid.columns.length;t++)r=this._grid.columns[t],n._ubv||(n._ubv={}),n._ubv[r._hash]=r.header;this._grid.rows.insert(0,n)}},r}(),f,r,u;i.Sheet=e;f=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i._current=-1,i.sheetCleared=new n.Event,i.selectedSheetChanged=new n.Event,i.sheetNameChanged=new n.Event,i.sheetVisibleChanged=new n.Event,i}return __extends(i,t),i.prototype.onSheetCleared=function(){this.sheetCleared.raise(this,new n.EventArgs)},Object.defineProperty(i.prototype,"selectedIndex",{get:function(){return this._current},set:function(n){this._moveCurrentTo(+n)},enumerable:!0,configurable:!0}),i.prototype.onSelectedSheetChanged=function(n){this.selectedSheetChanged.raise(this,n)},i.prototype.insert=function(n,i){var r;r=i.name?this.getValidSheetName(i):this._getUniqueName();r!==i.name&&(i.name=r);t.prototype.insert.call(this,n,i);this._postprocessSheet(i)},i.prototype.push=function(){for(var f,n,u,i=[],r=0;r<arguments.length;r++)i[r]=arguments[r];for(f=this.length,n=0;n<i.length;n++)u=i[n].name?this.getValidSheetName(i[n]):this._getUniqueName(),u!==i[n].name&&(i[n].name=u),t.prototype.push.call(this,i[n]),this._postprocessSheet(i[n]);return this.length},i.prototype.splice=function(n,i,r){var u;return r?(u=r.name?this.getValidSheetName(r):this._getUniqueName(),u!==r.name&&(r.name=u),this._postprocessSheet(r),t.prototype.splice.call(this,n,i,r)):t.prototype.splice.call(this,n,i,r)},i.prototype.removeAt=function(n){var i=this.hide(n);i&&(t.prototype.removeAt.call(this,n),n<this.selectedIndex&&(this._current-=1))},i.prototype.onSheetNameChanged=function(n){this.sheetNameChanged.raise(this,n)},i.prototype.onSheetVisibleChanged=function(n){this.sheetVisibleChanged.raise(this,n)},i.prototype.selectFirst=function(){return this._moveCurrentTo(0)},i.prototype.selectLast=function(){return this._moveCurrentTo(this.length-1)},i.prototype.selectPrevious=function(){return this._moveCurrentTo(this._current-1)},i.prototype.selectNext=function(){return this._moveCurrentTo(this._current+1)},i.prototype.hide=function(n){return n<0&&n>=this.length?!1:this[n].visible?(this[n].visible=!1,!0):!1},i.prototype.show=function(n){return n<0&&n>=this.length?!1:(this[n].visible=!0,this._moveCurrentTo(n),!0)},i.prototype.clear=function(){t.prototype.clear.call(this);this._current=-1;this.onSheetCleared()},i.prototype.isValidSheetName=function(n){var t=this._getSheetIndexFrom(n.name),i=this.indexOf(n);return t===-1||t===i},i.prototype.getValidSheetName=function(n){var t=n.name,i=1,u=this.indexOf(n),r;do{if(r=this._getSheetIndexFrom(t),r===-1||r===u)break;else t=n.name.concat((i+1).toString());i=i+1}while(1);return t},i.prototype._moveCurrentTo=function(t){var i=t,r;if(t<0||t>=this.length)return!1;if(this._current<i||i===0)while(i<this.length&&!this[i].visible)i++;else if(this._current>i)while(i>=0&&!this[i].visible)i--;if(i===this.length)for(i=t;i>=0&&!this[i].visible;)i--;if(i<0)return!1;if(i!==this._current){r=new n.PropertyChangedEventArgs('sheetIndex',this._current,i);this._current=i;this.onSelectedSheetChanged(r)}return!0},i.prototype._getSheetIndexFrom=function(n){var r=-1,i,u,t;if(!n)return r;for(n=n.toLowerCase(),t=0;t<this.length;t++)if(i=this[t],u=i.name?i.name.toLowerCase():'',u===n)return t;return r},i.prototype._postprocessSheet=function(t){var i=this;t.nameChanged.addHandler(function(){var r,u=i._getSheetIndexFrom(t.name);i.isValidSheetName(t)||t._setValidName(i.getValidSheetName(t));r=new n.collections.NotifyCollectionChangedEventArgs(n.collections.NotifyCollectionChangedAction.Change,t,n.isNumber(u)?u:i.length-1);i.onSheetNameChanged(r)});t.visibleChanged.addHandler(function(){var r=i._getSheetIndexFrom(t.name),u=new n.collections.NotifyCollectionChangedEventArgs(n.collections.NotifyCollectionChangedAction.Change,t,n.isNumber(r)?r:i.length-1);i.onSheetVisibleChanged(u)})},i.prototype._getUniqueName=function(){var n='Sheet1',t=0;do{if(this._getSheetIndexFrom(n)===-1)break;else n='Sheet'.concat((t+1).toString());t=t+1}while(1);return n},i}(n.collections.ObservableArray);i.SheetCollection=f;r=function(i){function r(n,t,r){var f=i.call(this,n,r)||this,u;return f._rtl=!1,f._sheetTabClicked=!1,u=f,u._owner=t,u._sheets=t.sheets,u._rtl=getComputedStyle(u._owner.hostElement).direction=='rtl',u.hostElement.attributes.tabindex&&u.hostElement.attributes.removeNamedItem('tabindex'),u._initControl(),u.deferUpdate(function(){r&&u.initialize(r)}),f}return __extends(r,i),r.prototype.refresh=function(){this._tabContainer.innerHTML='';this._tabContainer.innerHTML=this._getSheetTabs();this._rtl&&this._adjustSheetsPosition();this._adjustSize()},r.prototype._sourceChanged=function(t,i){i===void 0&&(i=n.collections.NotifyCollectionChangedEventArgs.reset);var r=i,u;switch(r.action){case n.collections.NotifyCollectionChangedAction.Add:u=r.index-1;u<0&&(u=0);this._tabContainer.innerHTML='';this._tabContainer.innerHTML=this._getSheetTabs();this._rtl&&this._adjustSheetsPosition();this._adjustSize();break;case n.collections.NotifyCollectionChangedAction.Remove:this._tabContainer.removeChild(this._tabContainer.children[r.index]);this._tabContainer.hasChildNodes()&&this._updateTabActive(r.index,!0);this._adjustSize();break;default:this.invalidate()}},r.prototype._selectedSheetChanged=function(n,t){this._updateTabActive(t.oldValue,!1);this._updateTabActive(t.newValue,!0);this._sheetTabClicked?this._sheetTabClicked=!1:this._scrollToActiveSheet(t.newValue,t.oldValue);this._adjustSize()},r.prototype._initControl=function(){var n=this;n.applyTemplate('',n.getTemplate(),{_sheetContainer:'sheet-container',_tabContainer:'container',_sheetPage:'sheet-page',_newSheet:'new-sheet'});n._rtl&&(n._sheetPage.style.right='0px',n._tabContainer.parentElement.style.right=n._sheetPage.clientWidth+'px',n._tabContainer.style.right='0px',n._tabContainer.style.cssFloat='right',n._newSheet.style.right=n._sheetPage.clientWidth+n._tabContainer.parentElement.clientWidth+'px');n._adjustNavigationButtons(n._rtl);n.addEventListener(n._newSheet,'click',function(){var t=n._owner.selectedSheetIndex;n._owner.addUnboundSheet();n._scrollToActiveSheet(n._owner.selectedSheetIndex,t)});n._sheets.collectionChanged.addHandler(n._sourceChanged,n);n._sheets.selectedSheetChanged.addHandler(n._selectedSheetChanged,n);n._sheets.sheetNameChanged.addHandler(n._updateSheetName,n);n._sheets.sheetVisibleChanged.addHandler(n._updateTabShown,n);n._initSheetPage();n._initSheetTab()},r.prototype._initSheetTab=function(){var n=this;n.addEventListener(n._tabContainer,'mousedown',function(t){var i=t.target,r;i instanceof HTMLLIElement&&(n._sheetTabClicked=!0,r=n._getItemIndex(n._tabContainer,i),n._scrollSheetTabContainer(i),r>-1&&(n._sheets.selectedIndex=r))})},r.prototype._initSheetPage=function(){var n=this;n.hostElement.querySelector('div.wj-sheet-page').addEventListener('click',function(t){var i=t.target.toString()==='[object HTMLButtonElement]'?t.target:t.target.parentElement,r=n._getItemIndex(n._sheetPage,i);if(n._sheets.length!==0)switch(r){case 0:n._sheets.selectFirst();break;case 1:n._sheets.selectPrevious();break;case 2:n._sheets.selectNext();break;case 3:n._sheets.selectLast()}})},r.prototype._getSheetTabs=function(){for(var t='',n=0;n<this._sheets.length;n++)t+=this._getSheetElement(this._sheets[n],this._sheets.selectedIndex===n);return t},r.prototype._getSheetElement=function(n,t){t===void 0&&(t=!1);var i='<li';return n.visible?t&&(i+=' class="active"'):i+=' class="hidden"',i+('>'+n.name+'</li>')},r.prototype._updateTabActive=function(t,i){t<0||t>=this._tabContainer.children.length||(i?n.addClass(this._tabContainer.children[t],'active'):n.removeClass(this._tabContainer.children[t],'active'))},r.prototype._updateTabShown=function(t,i){i.index<0||i.index>=this._tabContainer.children.length||(i.item.visible?n.removeClass(this._tabContainer.children[i.index],'hidden'):n.addClass(this._tabContainer.children[i.index],'hidden'),this._adjustSize())},r.prototype._adjustSize=function(){var u=this._tabContainer.childElementCount,n,i,t=0,r=0;if(this.hostElement.style.display!=='none'){for(r=this._tabContainer.parentElement.scrollLeft,this._tabContainer.parentElement.style.width='',this._tabContainer.style.width='',this._sheetPage.parentElement.style.width='',n=0;n<u;n++)t+=this._tabContainer.children[n].offsetWidth+1;i=this.hostElement.offsetWidth-this._sheetPage.offsetWidth-this._newSheet.offsetWidth-2;this._tabContainer.parentElement.style.width=(t>i?i:t)+'px';this._tabContainer.style.width=t+'px';this._sheetPage.parentElement.style.width=this._sheetPage.offsetWidth+this._newSheet.offsetWidth+this._tabContainer.parentElement.offsetWidth+3+'px';this._tabContainer.parentElement.scrollLeft=r}},r.prototype._getItemIndex=function(n,t){for(var i=0;i<n.children.length;i++)if(n.children[i]===t)return i;return-1},r.prototype._updateSheetName=function(n,t){this._tabContainer.querySelectorAll('li')[t.index].textContent=t.item.name;this._adjustSize()},r.prototype._scrollSheetTabContainer=function(n){var i=this._tabContainer.parentElement.scrollLeft,f=this._sheetPage.offsetWidth,e=this._newSheet.offsetWidth,r=this._tabContainer.parentElement.offsetWidth,u;if(this._rtl)switch(t.FlexGrid._getRtlMode()){case'rev':u=-this._tabContainer.offsetLeft;u+n.offsetLeft+n.offsetWidth>r+i?this._tabContainer.parentElement.scrollLeft+=n.offsetWidth:u+n.offsetLeft<i&&(this._tabContainer.parentElement.scrollLeft-=n.offsetWidth);break;case'neg':n.offsetLeft<i?this._tabContainer.parentElement.scrollLeft-=n.offsetWidth:n.offsetLeft+n.offsetWidth>r+i&&(this._tabContainer.parentElement.scrollLeft+=n.offsetWidth);break;default:n.offsetLeft-e+i<0?this._tabContainer.parentElement.scrollLeft+=n.offsetWidth:n.offsetLeft+n.offsetWidth-e+i>r&&(this._tabContainer.parentElement.scrollLeft-=n.offsetWidth)}else n.offsetLeft+n.offsetWidth-f>r+i?this._tabContainer.parentElement.scrollLeft+=n.offsetWidth:n.offsetLeft-f<i&&(this._tabContainer.parentElement.scrollLeft-=n.offsetWidth)},r.prototype._adjustSheetsPosition=function(){for(var t=this._tabContainer.querySelectorAll('li'),r=0,i,n=0;n<t.length;n++)i=t[n],i.style.cssFloat='right',i.style.right=r+'px',r+=t[n].clientWidth},r.prototype._scrollToActiveSheet=function(n,i){var u=this._tabContainer.querySelectorAll('li'),e,f,r;if(f=this._tabContainer.clientWidth>this._tabContainer.parentElement.clientWidth?this._tabContainer.clientWidth-this._tabContainer.parentElement.clientWidth:0,u.length>0&&n<u.length&&i<u.length){if(n===0&&!this._rtl||n===u.length-1&&this._rtl){if(this._rtl)switch(t.FlexGrid._getRtlMode()){case'rev':this._tabContainer.parentElement.scrollLeft=0;break;case'neg':this._tabContainer.parentElement.scrollLeft=-f;break;default:this._tabContainer.parentElement.scrollLeft=f}else this._tabContainer.parentElement.scrollLeft=0;return}if(n===0&&this._rtl||n===u.length-1&&!this._rtl){if(this._rtl)switch(t.FlexGrid._getRtlMode()){case'rev':this._tabContainer.parentElement.scrollLeft=f;break;case'neg':this._tabContainer.parentElement.scrollLeft=0;break;default:this._tabContainer.parentElement.scrollLeft=0}else this._tabContainer.parentElement.scrollLeft=f;return}if(n>=i)for(r=i+1;r<=n;r++)e=u[r],this._scrollSheetTabContainer(e);else for(r=i-1;r>=n;r--)e=u[r],this._scrollSheetTabContainer(e)}},r.prototype._adjustNavigationButtons=function(t){var r=this.hostElement.querySelectorAll('.wj-sheet-page button'),i;r&&r.length===4&&(t?(i=r[0].querySelector('span'),n.removeClass(i,'wj-glyph-step-backward'),n.addClass(i,'wj-glyph-step-backward-rtl'),i=r[1].querySelector('span'),n.removeClass(i,'wj-glyph-left'),n.addClass(i,'wj-glyph-left-rtl'),i=r[2].querySelector('span'),n.removeClass(i,'wj-glyph-right'),n.addClass(i,'wj-glyph-right-rtl'),i=r[3].querySelector('span'),n.removeClass(i,'wj-glyph-step-forward'),n.addClass(i,'wj-glyph-step-forward-rtl')):(i=r[0].querySelector('span'),n.removeClass(i,'wj-glyph-step-backward-rtl'),n.addClass(i,'wj-glyph-step-backward'),i=r[1].querySelector('span'),n.removeClass(i,'wj-glyph-left-rtl'),n.addClass(i,'wj-glyph-left'),i=r[2].querySelector('span'),n.removeClass(i,'wj-glyph-right-rtl'),n.addClass(i,'wj-glyph-right'),i=r[3].querySelector('span'),n.removeClass(i,'wj-glyph-step-forward-rtl'),n.addClass(i,'wj-glyph-step-forward')))},r}(n.Control);r.controlTemplate='<div wj-part="sheet-container" class="wj-sheet" style="height:100%;position:relative"><div wj-part="sheet-page" class="wj-btn-group wj-sheet-page"><button type="button" class="wj-btn wj-btn-default"><span class="wj-sheet-icon wj-glyph-step-backward"><\/span><\/button><button type="button" class="wj-btn wj-btn-default"><span class="wj-sheet-icon wj-glyph-left"><\/span><\/button><button type="button" class="wj-btn wj-btn-default"><span class="wj-sheet-icon wj-glyph-right"><\/span><\/button><button type="button" class="wj-btn wj-btn-default"><span class="wj-sheet-icon wj-glyph-step-forward"><\/span><\/button><\/div><div class="wj-sheet-tab" style="height:100%;overflow:hidden"><ul wj-part="container"><\/ul><\/div><div wj-part="new-sheet" class="wj-new-sheet"><span class="wj-sheet-icon wj-glyph-file"><\/span><\/div><\/div>';i._SheetTabs=r;u=function(){function n(n,t){this._column=n;this._ascending=t}return Object.defineProperty(n.prototype,"column",{get:function(){return this._column},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"ascending",{get:function(){return this._ascending},enumerable:!0,configurable:!0}),n}();i._UnboundSortDescription=u})(i=t.sheet||(t.sheet={}))})(t=n.grid||(n.grid={}))}(wijmo||(wijmo={})),function(n){var t;(function(t){var i;(function(i){'use strict';var u=function(){function u(t){this._owner=t;this._sortDescriptions=new n.collections.CollectionView;this._committedList=[new r(-1,!0)];this._sortDescriptions.newItemCreator=function(){return new r(-1,!0)};this._refresh()}return Object.defineProperty(u.prototype,"sortDescriptions",{get:function(){return this._sortDescriptions},set:function(n){this._sortDescriptions=n;this.commitSort(!0);this._refresh()},enumerable:!0,configurable:!0}),u.prototype.addSortLevel=function(t,i){i===void 0&&(i=!0);var r=this._sortDescriptions.addNew();t!=null&&!isNaN(t)&&n.isInt(t)&&(r.columnIndex=t);r.ascending=i;this._sortDescriptions.commitNew()},u.prototype.deleteSortLevel=function(n){var t;t=n!=null?this._getSortItem(n):this._sortDescriptions.currentItem;t&&this._sortDescriptions.remove(t)},u.prototype.copySortLevel=function(){var n=this._sortDescriptions.currentItem,t;n&&(t=this._sortDescriptions.addNew(),t.columnIndex=parseInt(n.columnIndex),t.ascending=n.ascending,this._sortDescriptions.commitNew())},u.prototype.editSortLevel=function(n,t){n!=null&&(this._sortDescriptions.currentItem.columnIndex=n);t!=null&&(this._sortDescriptions.currentItem.ascending=t)},u.prototype.moveSortLevel=function(n){var t=this._sortDescriptions.currentItem;if(t){var i=this._sortDescriptions.sourceCollection,r=i.indexOf(t),u=r+n;r>-1&&u>-1&&(i.splice(r,1),i.splice(u,0,t),this._sortDescriptions.refresh(),this._sortDescriptions.moveCurrentTo(t))}},u.prototype.checkSortItemExists=function(n){for(var t=0,r=this._sortDescriptions.itemCount,i;t<r;t++)if(i=this._sortDescriptions.items[t],+i.columnIndex===n)return t;return-1},u.prototype.commitSort=function(t){var y=this,u,s,h,c,f,l,a,o,e,v;if(t===void 0&&(t=!0),v=this._owner.itemsSource&&this._owner.itemsSource instanceof n.collections.CollectionView,this._owner.selectedSheet){if(this._owner._needCopyToSheet=!1,l=this._owner.selectedSheet._unboundSortDesc,t&&(a=new i._SortColumnAction(this._owner)),this._committedList=this._sortDescriptions.itemCount>0?this._cloneSortList(this._sortDescriptions.items):[new r(-1,!0)],this._owner.collectionView){for(e=this._owner.editableCollectionView,e&&e.currentEditItem&&e.items.indexOf(e.currentEditItem)!==-1&&!this._isEmpty(e.currentEditItem)&&e.commitEdit(),o=this._scanUnboundRows(),this._owner.collectionView.beginUpdate(),this._owner.selectedSheet.grid.collectionView.beginUpdate(),h=this._owner.collectionView.sortDescriptions,h.clear(),v===!1&&(c=this._owner.selectedSheet.grid.collectionView.sortDescriptions,c.clear()),f=0;f<this._sortDescriptions.itemCount;f++)u=this._sortDescriptions.items[f],u.columnIndex>-1&&(s=new n.collections.SortDescription(this._owner.columns[u.columnIndex].binding,u.ascending),h.push(s),v===!1&&c.push(s));this._owner.selectedSheet.selectionRanges.clear();this._owner.collectionView.endUpdate();this._owner.selectedSheet.grid.collectionView.endUpdate();o&&Object.keys(o).forEach(function(n){y._owner.rows.splice(+n,0,o[n])})}else for(l.clear(),f=0;f<this._sortDescriptions.itemCount;f++)u=this._sortDescriptions.items[f],u.columnIndex>-1&&l.push(new i._UnboundSortDescription(this._owner.columns[u.columnIndex],u.ascending));t&&(a.saveNewState(),this._owner.undoStack._addAction(a));this._owner._copiedRanges=null;this._owner._needCopyToSheet=!0}},u.prototype.cancelSort=function(){this._sortDescriptions.sourceCollection=this._committedList.slice();this._refresh()},u.prototype._refresh=function(){var i=[],n,t;if(this._owner.selectedSheet){if(this._owner.collectionView&&this._owner.collectionView.sortDescriptions.length>0)for(n=0;n<this._owner.collectionView.sortDescriptions.length;n++)t=this._owner.collectionView.sortDescriptions[n],i.push(new r(this._getColumnIndex(t.property),t.ascending));else if(this._owner.selectedSheet&&this._owner.selectedSheet._unboundSortDesc.length>0)for(n=0;n<this._owner.selectedSheet._unboundSortDesc.length;n++)t=this._owner.selectedSheet._unboundSortDesc[n],t.column!=null&&i.push(new r(t.column.index,t.ascending));else i.push(new r(-1,!0));this._sortDescriptions.sourceCollection=i}},u.prototype._getColumnIndex=function(n){for(var t=0,i=this._owner.columns.length;t<i;t++)if(this._owner.columns[t].binding===n)return t;return-1},u.prototype._getSortItem=function(n){var t=this.checkSortItemExists(n);return t>-1?this._sortDescriptions.items[t]:undefined},u.prototype._scanUnboundRows=function(){for(var r,u,n=0;n<this._owner.rows.length;n++)r=this._owner.rows[n],r.dataItem||r instanceof i.HeaderRow||r instanceof t._NewRowTemplate||(u||(u={}),u[n]=r);return u},u.prototype._cloneSortList=function(n){for(var i=[],t=0;t<n.length;t++)i[t]=n[t].clone();return i},u.prototype._isEmpty=function(n){var i=Object.prototype.hasOwnProperty,t;if(n==null)return!0;if(n.length>0)return!1;if(n.length===0)return!0;for(t in n)if(i.call(n,t))return!1;return!0},u}(),r;i.SortManager=u;r=function(){function n(n,t){this._columnIndex=n;this._ascending=t}return Object.defineProperty(n.prototype,"columnIndex",{get:function(){return this._columnIndex},set:function(n){this._columnIndex=n},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"ascending",{get:function(){return this._ascending},set:function(n){this._ascending=n},enumerable:!0,configurable:!0}),n.prototype.clone=function(){return new n(this._columnIndex,this._ascending)},n}();i.ColumnSortDescription=r})(i=t.sheet||(t.sheet={}))})(t=n.grid||(n.grid={}))}(wijmo||(wijmo={})),function(n){var t;(function(t){var i;(function(t){'use strict';var i=function(){function i(i){this.MAX_STACK_SIZE=500;this._stack=[];this._pointer=-1;this._resizingTriggered=!1;this.undoStackChanged=new n.Event;var r=this;r._owner=i;r._owner.prepareCellForEdit.addHandler(r._initCellEditAction,r);r._owner.cellEditEnded.addHandler(function(n,i){i.data&&(i.data.keyCode===46||i.data.keyCode===8)||r._pendingAction instanceof t._EditAction&&!r._pendingAction.isPaste&&r._afterProcessCellEditAction(r)},r);r._owner.pasting.addHandler(r._initCellEditActionForPasting,r);r._owner.pastingCell.addHandler(function(n,i){r._pendingAction instanceof t._EditAction?r._pendingAction.updateForPasting(i.range):r._pendingAction instanceof t._CutAction&&r._pendingAction.updateForPasting(i.range)},r);r._owner.pasted.addHandler(function(){r._pendingAction instanceof t._EditAction&&r._pendingAction.isPaste?r._afterProcessCellEditAction(r):r._pendingAction instanceof t._CutAction&&(r._pendingAction.saveNewState(),r._addAction(r._pendingAction),r._pendingAction=null)},r);r._owner.resizingColumn.addHandler(function(n,i){r._resizingTriggered||(r._pendingAction=new t._ColumnResizeAction(r._owner,i.panel,i.col),r._resizingTriggered=!0)},r);r._owner.resizedColumn.addHandler(function(){r._pendingAction instanceof t._ColumnResizeAction&&r._pendingAction.saveNewState()&&r._addAction(r._pendingAction);r._pendingAction=null;r._resizingTriggered=!1},r);r._owner.resizingRow.addHandler(function(n,i){r._resizingTriggered||(r._pendingAction=new t._RowResizeAction(r._owner,i.panel,i.row),r._resizingTriggered=!0)},r);r._owner.resizedRow.addHandler(function(){r._pendingAction instanceof t._RowResizeAction&&r._pendingAction.saveNewState()&&r._addAction(r._pendingAction);r._pendingAction=null;r._resizingTriggered=!1},r);r._owner.draggingRowColumn.addHandler(function(n,i){i.isShiftKey&&(r._pendingAction=i.isDraggingRows?new t._RowsChangedAction(r._owner):new t._ColumnsChangedAction(r._owner))},r);r._owner.droppingRowColumn.addHandler(function(){r._pendingAction&&r._pendingAction.saveNewState()&&r._addAction(r._pendingAction);r._pendingAction=null},r)}return Object.defineProperty(i.prototype,"canUndo",{get:function(){return this._pointer>-1&&this._pointer<this._stack.length},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"canRedo",{get:function(){return this._pointer+1>-1&&this._pointer+1<this._stack.length},enumerable:!0,configurable:!0}),i.prototype.onUndoStackChanged=function(){this.undoStackChanged.raise(this)},i.prototype.undo=function(){var n;this.canUndo&&(n=this._stack[this._pointer],this._beforeUndoRedo(n),n.undo(),this._pointer--,this.onUndoStackChanged())},i.prototype.redo=function(){var n;this.canRedo&&(this._pointer++,n=this._stack[this._pointer],this._beforeUndoRedo(n),n.redo(),this.onUndoStackChanged())},i.prototype._addAction=function(n){this._stack.length>0&&this._stack.length>this._pointer+1&&this._stack.splice(this._pointer+1,this._stack.length-this._pointer-1);this._stack.length>=this.MAX_STACK_SIZE&&this._stack.splice(0,this._stack.length-this.MAX_STACK_SIZE+1);this._pointer=this._stack.length;this._stack.push(n);this.onUndoStackChanged()},i.prototype._pop=function(){var n=this._stack[this._pointer];return this._pointer--,n},i.prototype.clear=function(){this._stack.length=0},i.prototype._initCellEditAction=function(n,i){this._pendingAction=new t._EditAction(this._owner,i.range)},i.prototype._initCellEditActionForPasting=function(){this._owner._cutData?this._pendingAction=new t._CutAction(this._owner):(this._pendingAction=new t._EditAction(this._owner),this._pendingAction.markIsPaste())},i.prototype._afterProcessCellEditAction=function(n){n._pendingAction instanceof t._EditAction&&n._pendingAction.saveNewState()&&n._addAction(this._pendingAction);n._pendingAction=null},i.prototype._beforeUndoRedo=function(n){this._owner.selectedSheetIndex=n.sheetIndex},i}();t.UndoStack=i})(i=t.sheet||(t.sheet={}))})(t=n.grid||(n.grid={}))}(wijmo||(wijmo={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t;(function(t){var i;(function(t){'use strict';var i=function(n){function i(){return n!==null&&n.apply(this,arguments)||this}return __extends(i,n),i.prototype.apply=function(n){var i=this.column.grid;return(i instanceof t.FlexSheet)?!this.showValues||!Object.keys(this.showValues).length?!0:(n=i.getCellValue(n,this.column.index,!0),this.showValues[n]!=undefined):!1},i}(n.grid.filter.ValueFilter);t._FlexSheetValueFilter=i})(i=t.sheet||(t.sheet={}))})(t=n.grid||(n.grid={}))}(wijmo||(wijmo={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t;(function(t){var i;(function(i){'use strict';var r=function(n){function r(){return n!==null&&n.apply(this,arguments)||this}return __extends(r,n),r.prototype.updateEditor=function(){var a=this.filter.column,u=a.grid,o=a.index,f=[],v={},s,h,e,y,p,w,c,l,b,r;if(this.filter.uniqueValues||u.itemsSource!=null&&u.childItemsPath!=null){n.prototype.updateEditor.call(this);return}for(r=0;r<u.rows.length;r++)(p=this.filter.apply(r),y=this.filter.showValues,this.filter.showValues=null,w=u._filter._filter(r),this.filter.showValues=y,h=u.getMergedRange(u.cells,r,o),h&&(r!==h.topRow||o!==h.leftCol))||(s=u.rows[r],s instanceof i.HeaderRow||s instanceof t.GroupRow||!s.visible&&(p||!w))||(e=u.getCellValue(r,o),e=e===''?null:e,c=u.getCellValue(r,o,!0),v[c]||(v[c]=!0,f.push({value:e,text:c})));if(l=this.filter.showValues,l&&Object.keys(l).length!=0){for(b in l)for(r=0;r<f.length;r++)if(f[r].text==b){f[r].show=!0;break}}else for(r=0;r<f.length;r++)f[r].show=!0;this._lbValues.isContentHtml=a.isContentHtml;this._cmbFilter.text=this.filter.filterText;this._filterText=this._cmbFilter.text.toLowerCase();this._view.pageSize=this.filter.maxValues;this._view.sourceCollection=f;this._view.moveCurrentToPosition(-1)},r}(n.grid.filter.ValueFilterEditor);i._FlexSheetValueFilterEditor=r})(i=t.sheet||(t.sheet={}))})(t=n.grid||(n.grid={}))}(wijmo||(wijmo={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t;(function(t){var i;(function(t){'use strict';var i=function(i){function r(){return i!==null&&i.apply(this,arguments)||this}return __extends(r,i),r.prototype.apply=function(i){var u=this.column,h=u.grid,e=this.condition1,o=this.condition2,r,s,f,c,l;return(h instanceof t.FlexSheet)?this.isActive?(r=h.getCellValue(i,u.index),s=f=r,u.dataMap?(r=u.dataMap.getDisplayValue(r),s=f=r):n.isDate(r)?(n.isString(e.value)||n.isString(o.value))&&(r=h.getCellValue(i,u.index,!0),s=f=r):n.isNumber(r)&&(r=n.Globalize.parseFloat(h.getCellValue(i,u.index,!0)),s=f=r,r!==0||u.dataType||(e.isActive&&e.value===''&&(s=r.toString()),o.isActive&&o.value===''&&(f=f.toString()))),c=e.apply(s),l=o.apply(f),e.isActive&&o.isActive?this.and?c&&l:c||l:e.isActive?c:o.isActive?l:!0):!0:!1},r}(n.grid.filter.ConditionFilter);t._FlexSheetConditionFilter=i})(i=t.sheet||(t.sheet={}))})(t=n.grid||(n.grid={}))}(wijmo||(wijmo={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t;(function(t){var i;(function(t){'use strict';var i=function(n){function i(i,r){var u=n.call(this,i,r)||this;return u._valueFilter=new t._FlexSheetValueFilter(r),u._conditionFilter=new t._FlexSheetConditionFilter(r),u}return __extends(i,n),i}(n.grid.filter.ColumnFilter);t._FlexSheetColumnFilter=i})(i=t.sheet||(t.sheet={}))})(t=n.grid||(n.grid={}))}(wijmo||(wijmo={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t;(function(t){var i;(function(t){'use strict';var i=function(i){function r(n,t,r){r===void 0&&(r=!0);var u=i.call(this,n,t,r)||this,o=u,f,e;return r&&(u._divSort.style.display=''),f=u.cloneElement(u._btnAsc),e=u.cloneElement(u._btnDsc),u._btnAsc.parentNode.replaceChild(f,u._btnAsc),u._btnDsc.parentNode.replaceChild(e,u._btnDsc),f.addEventListener('click',function(n){o._sortBtnClick(n,!0)}),e.addEventListener('click',function(n){o._sortBtnClick(n,!1)}),u}return __extends(r,i),r.prototype._showFilter=function(r){r==n.grid.filter.FilterType.Value&&this._edtVal==null&&(this._edtVal=new t._FlexSheetValueFilterEditor(this._divEdtVal,this.filter.valueFilter));i.prototype._showFilter.call(this,r)},r.prototype._sortBtnClick=function(n,t){var u=this.filter.column,i=u.grid.sortManager,r,f,e;n.preventDefault();n.stopPropagation();r=i.checkSortItemExists(u.index);r>-1?(i.sortDescriptions.moveCurrentToPosition(r),e=i.sortDescriptions.currentItem,e.ascending=t,f=-r):(i.addSortLevel(u.index,t),f=-(i.sortDescriptions.items.length-1));i.moveSortLevel(f);i.commitSort();this.updateEditor();this.onButtonClicked()},r.prototype.cloneElement=function(n){for(var t=n.cloneNode();n.firstChild;)t.appendChild(n.lastChild);return t},r}(n.grid.filter.ColumnFilterEditor);t._FlexSheetColumnFilterEditor=i})(i=t.sheet||(t.sheet={}))})(t=n.grid||(n.grid={}))}(wijmo||(wijmo={}));__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){var t;(function(t){var i;(function(i){'use strict';var r=function(r){function u(){return r!==null&&r.apply(this,arguments)||this}return __extends(u,r),Object.defineProperty(u.prototype,"filterDefinition",{get:function(){for(var n,t,u,i={defaultFilterType:this.defaultFilterType,filters:[]},r=0;r<this._filters.length;r++)n=this._filters[r],n&&n.column&&(n.conditionFilter.isActive?(t=n.conditionFilter,i.filters.push({columnIndex:n.column.index,type:'condition',condition1:{operator:t.condition1.operator,value:t.condition1.value},and:t.and,condition2:{operator:t.condition2.operator,value:t.condition2.value}})):n.valueFilter.isActive&&(u=n.valueFilter,i.filters.push({columnIndex:n.column.index,type:'value',filterText:u.filterText,showValues:u.showValues})));return JSON.stringify(i)},set:function(t){var e=JSON.parse(n.asString(t)),f,r,s;for(this.clear(),this.defaultFilterType=e.defaultFilterType,f=0;f<e.filters.length;f++){var i=e.filters[f],u=this.grid.columns[i.columnIndex],o=this.getColumnFilter(u,!0);if(o)switch(i.type){case'condition':r=o.conditionFilter;r.condition1.value=u.dataType==n.DataType.Date?n.changeType(i.condition1.value,u.dataType,null):i.condition1.value;r.condition1.operator=i.condition1.operator;r.and=i.and;r.condition2.value=u.dataType==n.DataType.Date?n.changeType(i.condition2.value,u.dataType,null):i.condition2.value;r.condition2.operator=i.condition2.operator;break;case'value':s=o.valueFilter;s.filterText=i.filterText;s.showValues=i.showValues}}this.apply()},enumerable:!0,configurable:!0}),u.prototype.apply=function(){var r=this;r.grid.deferUpdate(function(){for(var s,u,o,f,h=-1,e=0;e<r.grid.rows.length;e++)if(u=r.grid.rows[e],!(u instanceof i.HeaderRow)&&!(e<=h))if(h=-1,o=r._filter(e),u instanceof t.GroupRow){if(f=u.getCellRange(),u.dataItem==null||u.dataItem instanceof n.collections.CollectionViewGroup)u.visible=r._checkGroupVisible(f);else if(u.visible=o,h=f.bottomRow,f.isValid)for(s=f.topRow;s<=f.bottomRow;s++)r.grid.rows[s].visible=o}else u.visible=o;r.grid._isCopying||r.grid._resettingFilter||r.onFilterApplied()})},u.prototype.editColumnFilter=function(r,u){var f=this,e;f.closeEditor();r=n.isString(r)?f.grid.columns.getColumn(r):n.asType(r,t.Column,!1);e=new t.CellRangeEventArgs(f.grid.cells,new t.CellRange(-1,r.index));f.onFilterChanging(e);if(!e.cancel){e.cancel=!0;f._undoAcion=new i._FilteringAction(f.grid);var o=document.createElement('div'),a=f.getColumnFilter(r),h=new i._FlexSheetColumnFilterEditor(o,a,f.showSortButtons);n.addClass(o,'wj-dropdown-panel');f.grid.rightToLeft&&(o.dir='rtl');h.filterChanged.addHandler(function(){e.cancel=!1;f._undoAcion&&(f._undoAcion.saveNewState()&&f.grid.undoStack._addAction(f._undoAcion),f._undoAcion=null);setTimeout(function(){e.cancel||f.apply()})});h.buttonClicked.addHandler(function(){f.closeEditor();f.grid.focus();f.onFilterChanged(e)});h.lostFocus.addHandler(function(){setTimeout(function(){var t=n.Control.getControl(f._divEdt);t&&!t.containsFocus()&&f.closeEditor()},10)});var l=f.grid.columnHeaders,v=u?u.row:l.rows.length-1,y=u?u.col:r.index,s=l.getCellBoundingRect(v,y),c=document.elementFromPoint(s.left+s.width/2,s.top+s.height/2);c=n.closest(c,'.wj-cell');c?n.showPopup(o,c,!1,!1,!1):n.showPopup(o,s);h.focus();f._divEdt=o;f._edtCol=r}},u.prototype.closeEditor=function(){this._undoAcion&&(this._undoAcion=null);r.prototype.closeEditor.call(this)},u.prototype.getColumnFilter=function(r,u){var f,e;if(u===void 0&&(u=!0),n.isString(r)?r=this.grid.columns.getColumn(r):n.isNumber(r)&&(r=this.grid.columns[r]),!r)return null;for(r=n.asType(r,t.Column),f=0;f<this._filters.length;f++)if(this._filters[f].column==r)return this._filters[f];return u?(e=new i._FlexSheetColumnFilter(this,r),this._filters.push(e),e):null},u.prototype._checkGroupVisible=function(n){for(var i=!0,r,u=n.topRow+1;u<=n.bottomRow;u++)if(r=this.grid.rows[u],r)if(r instanceof t.GroupRow)i=this._checkGroupVisible(r.getCellRange());else if(i=this._filter(u),i)break;return i},u}(n.grid.filter.FlexGridFilter);i._FlexSheetFilter=r})(i=t.sheet||(t.sheet={}))})(t=n.grid||(n.grid={}))}(wijmo||(wijmo={}))